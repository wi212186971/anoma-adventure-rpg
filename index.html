<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anoma RPG - ÊÑèÂõæ‰πãÂ¢É</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ffd700;
        }

        .game-title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .game-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #444;
        }

        .main-content {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }

        .player-stats {
            margin-bottom: 20px;
        }

        .stat-bar {
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #666;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .hp-bar { background: #e74c3c; }
        .mp-bar { background: #3498db; }
        .exp-bar { background: #f39c12; }

        .character-image {
            text-align: center;
            margin: 20px 0;
        }

        .character-image img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 10px;
            border: 2px solid #ffd700;
        }

        .story-content {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #666;
        }

        .story-text {
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .choices {
            display: grid;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            border: 2px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-btn:hover {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        .shop-container, .inn-container, .inventory-container, .map-container {
            display: none;
        }

        .shop-container.active, .inn-container.active, .inventory-container.active, .map-container.active {
            display: block;
        }

        .shop-items, .inventory-items {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }

        .item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            color: #ffd700;
        }

        .item-description {
            font-size: 0.9em;
            color: #ccc;
            margin: 5px 0;
        }

        .item-price {
            color: #f39c12;
            font-weight: bold;
        }

        .buy-btn, .sell-btn, .use-btn, .equip-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .buy-btn:hover, .sell-btn:hover, .use-btn:hover, .equip-btn:hover {
            background: #2ecc71;
        }

        .buy-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .game-log {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #666;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }

        .back-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .back-btn:hover {
            background: #c0392b;
        }

        .inn-service {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .rest-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 10px;
        }

        .rest-btn:hover {
            background: #8e44ad;
        }

        .rest-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .npc-dialogue {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #f39c12;
        }

        .npc-name {
            color: #f39c12;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .dialogue-text {
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(10, 40px);
            gap: 2px;
            margin: 20px 0;
            justify-content: center;
        }

        .map-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 3px;
        }

        .map-cell.player {
            background: #e74c3c;
            border-color: #ffd700;
        }

        .map-cell.forest {
            background: #27ae60;
        }

        .map-cell.town {
            background: #3498db;
        }

        .map-cell.mountain {
            background: #95a5a6;
        }

        .companion-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #3498db;
        }

        .companion-name {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr;
            }
            
            .game-title {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">üßô‚Äç‚ôÇÔ∏è Anoma RPG - ÊÑèÂõæ‰πãÂ¢É üåü</h1>
        
        <div class="game-layout">
            <!-- ‰æßËæπÊ†è - ËßíËâ≤Áä∂ÊÄÅ -->
            <div class="sidebar">
                <div class="player-stats">
                    <h3>üßô‚Äç‚ôÇÔ∏è ÊÑèÂõæÊ≥ïÂ∏à</h3>
                    <p>Á≠âÁ∫ß: <span id="player-level">1</span></p>
                    <p>ÈáëÂ∏Å: <span id="player-gold">100</span> üí∞</p>
                    
                    <div class="stat-bar">
                        <div class="stat-label">ÁîüÂëΩÂÄº: <span id="hp-text">100/100</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill hp-bar" id="hp-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">È≠îÊ≥ïÂÄº: <span id="mp-text">50/50</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill mp-bar" id="mp-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">ÁªèÈ™åÂÄº: <span id="exp-text">0/100</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill exp-bar" id="exp-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="character-image">
                    <img id="character-img" src="./wizard.png" alt="ËßíËâ≤ÂõæÂÉè">
                </div>

                <!-- ‰ºô‰º¥‰ø°ÊÅØ -->
                <div id="companion-section" style="display: none;">
                    <div class="companion-info">
                        <div class="companion-name" id="companion-name">ËôæËôæ</div>
                        <div class="stat-bar">
                            <div class="stat-label">ÁîüÂëΩÂÄº: <span id="companion-hp-text">60/60</span></div>
                            <div class="progress-bar">
                                <div class="progress-fill hp-bar" id="companion-hp-bar" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Âø´Êç∑Êìç‰Ωú -->
                <div style="margin-top: 20px;">
                    <button class="choice-btn" onclick="saveGame()" style="width: 100%; margin-bottom: 10px;">üíæ ‰øùÂ≠òÊ∏∏Êàè</button>
                    <button class="choice-btn" onclick="loadGame()" style="width: 100%;">üìÅ Âä†ËΩΩÊ∏∏Êàè</button>
                </div>
            </div>

            <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
            <div class="main-content">
                <!-- ÊïÖ‰∫ãÊ®°Âºè -->
                <div id="story-mode">
                    <div class="story-content">
                        <div class="story-text" id="story-text">
                            Âú®AnomaÁöÑÁ•ûÁßò‰∏ñÁïå‰∏≠Ôºå‰Ω†ÊòØ‰∏ÄÂêçÂàöÂàöËßâÈÜíÊÑèÂõæËÉΩÂäõÁöÑÂπ¥ËΩªÊ≥ïÂ∏à„ÄÇËøô‰∏™‰∏ñÁïåÁî±Êó†Êï∞‰∏™"ÊÑèÂõæ"ÊûÑÊàêÔºåÊØè‰∏™ÊÑèÂõæÈÉΩÊòØÁé∞ÂÆûÁöÑ‰∏Ä‰∏™ÁâáÊÆµÔºåËÄå‰Ω†Êã•ÊúâÊìçÊéßËøô‰∫õÊÑèÂõæÁöÑÂ§©Ëµã„ÄÇ

                            ‰Ω†Á´ôÂú®Êñ∞ÊâãÊùëÁöÑ‰∏≠Â§ÆÔºåÂë®Âõ¥ÊòØÁÜüÊÇâÁöÑËåÖËçâÂ±ãÂíåÁü≥ÊùøË∑Ø„ÄÇËøúÂ§ÑÁöÑÂú∞Âπ≥Á∫ø‰∏äÔºåÁ•ûÁßòÁöÑÊÑèÂõæ‰πãÂ°îËã•ÈöêËã•Áé∞ÔºåÈÇ£ÈáåÊçÆËØ¥ÈöêËóèÁùÄAnoma‰∏ñÁïåÁöÑÁªàÊûÅÁßòÂØÜ„ÄÇ

                            ‰Ω†ÁöÑÂØºÂ∏àÂëäËØâ‰Ω†ÔºåÂè™ÊúâÈÄöËøá‰∏çÊñ≠ÁöÑÂÜíÈô©ÂíåÊàòÊñóÔºåÊâçËÉΩÊèêÂçá‰Ω†ÁöÑÊÑèÂõæÊìçÊéßËÉΩÂäõÔºåÊúÄÁªàÊàê‰∏∫ÁúüÊ≠£ÁöÑÊÑèÂõæÂ§ßÂ∏à„ÄÇ
                        </div>
                        
                        <div class="choices" id="story-choices">
                            <button class="choice-btn" onclick="goToVillageChief()">üè† ÂâçÂæÄÊùëÈïøÂÆ∂Êé•ÂèóÁ¨¨‰∏Ä‰∏™‰ªªÂä°</button>
                            <button class="choice-btn" onclick="exploreForest()">üå≤ Êé¢Á¥¢ÊùëÂ∫ÑÂë®Âõ¥ÁöÑÊ£ÆÊûó</button>
                            <button class="choice-btn" onclick="openInventory()">üìä Êü•Áúã‰∏™‰∫∫Áä∂ÊÄÅÂíåË£ÖÂ§á</button>
                            <button class="choice-btn" onclick="openShop()">üè™ ÂâçÂæÄÂïÜÂ∫óË¥≠‰π∞Áâ©ÂìÅ</button>
                            <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ÊâìÂºÄ‰∏ñÁïåÂú∞Âõæ</button>
                        </div>
                    </div>
                </div>

                <!-- ÂïÜÂ∫óÊ®°Âºè -->
                <div id="shop-mode" class="shop-container">
                    <h2>üè™ ÊÑèÂõæÂïÜÂ∫ó</h2>
                    <p>Ê¨¢ËøéÊù•Âà∞ÊÑèÂõæÂïÜÂ∫óÔºÅËøôÈáåÊúâÂêÑÁßçÂÜíÈô©ÂøÖÈúÄÂìÅ„ÄÇ</p>
                    
                    <div class="npc-dialogue">
                        <div class="npc-name">ÂïÜ‰∫∫È≤çÂãÉ</div>
                        <div class="dialogue-text">
                            "Ê¨¢ËøéÊù•Âà∞Êàë‰ª¨ÁöÑÂ∞èÈïáÔºÅËøôÈáåÁöÑË¥∏ÊòìÂæàÁπÅËç£„ÄÇÂ¶ÇÊûú‰Ω†ÈúÄË¶ÅÂ•ΩË£ÖÂ§áÔºåËÆ∞ÂæóÂéªÂïÜÂ∫óÁúãÁúãÔºÅÊÑèÂõæÊ≥ïÂ∏à‰ª¨ÊÄªÊòØÂæàÂøôÁ¢åÔºå‰ΩÜËÆ∞ÂæóË¶ÅÂ•ΩÂ•Ω‰ºëÊÅØÂì¶„ÄÇ"
                        </div>
                    </div>
                    
                    <div class="shop-items" id="shop-items">
                        <!-- ÂïÜÂ∫óÁâ©ÂìÅÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">ËøîÂõûÊùëÂ∫Ñ</button>
                </div>

                <!-- ÊóÖÂ∫óÊ®°Âºè -->
                <div id="inn-mode" class="inn-container">
                    <h2>üè® ÊÑèÂõæÊóÖÂ∫ó</h2>
                    
                    <div class="npc-dialogue">
                        <div class="npc-name">ÂÆ¢Ê†àËÄÅÊùøÂ®òÁéõ‰∏Ω</div>
                        <div class="dialogue-text" id="inn-dialogue">
                            "Ê¨¢ËøéÊù•Âà∞ÊÑèÂõæÊóÖÂ∫óÔºÅÁ¥Ø‰∫ÜÂêóÔºüÂú®ËøôÈáå‰ºëÊÅØ‰∏Ä‰∏ãÔºåÂè™ÈúÄË¶Å20ÈáëÂ∏ÅÂ∞±ËÉΩÂÆåÂÖ®ÊÅ¢Â§ç‰Ω†ÁöÑÁîüÂëΩÂÄºÂíåÈ≠îÊ≥ïÂÄº„ÄÇÊàë‰ª¨ÁöÑÂ∫äÈì∫ÊòØÂÖ®ÊùëÊúÄËàíÊúçÁöÑÔºÅ"
                        </div>
                    </div>
                    
                    <div class="inn-service">
                        <h3>üí§ ‰ºëÊÅØÊúçÂä°</h3>
                        <p>Ë¥πÁî®: 20 ÈáëÂ∏Å</p>
                        <p>ÊïàÊûú: ÂÆåÂÖ®ÊÅ¢Â§çÁîüÂëΩÂÄºÂíåÈ≠îÊ≥ïÂÄº</p>
                        <button class="rest-btn" id="rest-btn" onclick="restAtInn()">üí§ ‰ºëÊÅØ (20ÈáëÂ∏Å)</button>
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">Á¶ªÂºÄÊóÖÂ∫ó</button>
                </div>

                <!-- ËÉåÂåÖÊ®°Âºè -->
                <div id="inventory-mode" class="inventory-container">
                    <h2>üéí Áâ©ÂìÅËÉåÂåÖ</h2>
                    
                    <div class="inventory-items" id="inventory-items">
                        <!-- ËÉåÂåÖÁâ©ÂìÅÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">ÂÖ≥Èó≠ËÉåÂåÖ</button>
                </div>

                <!-- Âú∞ÂõæÊ®°Âºè -->
                <div id="map-mode" class="map-container">
                    <h2>üó∫Ô∏è ÊÑèÂõæ‰∏ñÁïåÂú∞Âõæ</h2>
                    <p>‰ΩøÁî®ÊñπÂêëÈîÆÊàñÁÇπÂáªÁßªÂä®„ÄÇüßô‚Äç‚ôÇÔ∏è Ë°®Á§∫‰Ω†ÁöÑ‰ΩçÁΩÆ„ÄÇ</p>
                    
                    <div class="map-grid" id="map-grid">
                        <!-- Âú∞ÂõæÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="choice-btn" onclick="movePlayer(-1, 0)" style="width: 60px;">‚¨ÖÔ∏è</button>
                        <button class="choice-btn" onclick="movePlayer(1, 0)" style="width: 60px;">‚û°Ô∏è</button>
                        <button class="choice-btn" onclick="movePlayer(0, -1)" style="width: 60px;">‚¨ÜÔ∏è</button>
                        <button class="choice-btn" onclick="movePlayer(0, 1)" style="width: 60px;">‚¨áÔ∏è</button>
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">ÂÖ≥Èó≠Âú∞Âõæ</button>
                </div>

                <!-- Ê∏∏ÊàèÊó•Âøó -->
                <div class="game-log">
                    <h4>üìú Ê∏∏ÊàèÊó•Âøó</h4>
                    <div id="game-log">
                        <div class="log-entry">Ê∏∏ÊàèÂºÄÂßãÔºÅÊ¨¢ËøéÊù•Âà∞Anoma‰∏ñÁïåÔºÅ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            player: {
                level: 1,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                exp: 0,
                maxExp: 100,
                gold: 100,
                x: 5,
                y: 5,
                inventory: [
                    { id: 'potion', name: 'Ê≤ªÁñóËçØÊ∞¥', type: 'consumable', effect: { hp: 30 }, price: 50, description: 'ÊÅ¢Â§ç30ÁÇπÁîüÂëΩÂÄº' },
                    { id: 'mana_potion', name: 'È≠îÊ≥ïËçØÊ∞¥', type: 'consumable', effect: { mp: 20 }, price: 40, description: 'ÊÅ¢Â§ç20ÁÇπÈ≠îÊ≥ïÂÄº' }
                ],
                equipment: {
                    weapon: { id: 'starter_staff', name: 'Êñ∞ÊâãÊ≥ïÊùñ', attack: 10 },
                    armor: { id: 'cloth_robe', name: 'Â∏ÉÂà∂ÈïøË¢ç', defense: 5 }
                },
                companions: []
            },
            currentScene: 'intro',
            gameMode: 'story',
            hasCompanion: false,
            gameMap: null
        };

        // ÂïÜÂ∫óÁâ©ÂìÅ
        const shopItems = [
            { id: 'healing_potion', name: 'Ê≤ªÁñóËçØÊ∞¥', type: 'consumable', effect: { hp: 30 }, price: 50, description: 'ÊÅ¢Â§ç30ÁÇπÁîüÂëΩÂÄº' },
            { id: 'mana_potion', name: 'È≠îÊ≥ïËçØÊ∞¥', type: 'consumable', effect: { mp: 20 }, price: 40, description: 'ÊÅ¢Â§ç20ÁÇπÈ≠îÊ≥ïÂÄº' },
            { id: 'iron_sword', name: 'ÈìÅÂâë', type: 'weapon', attack: 20, price: 100, description: 'ÊîªÂáªÂäõ+20ÁöÑÈìÅÂà∂Ê≠¶Âô®' },
            { id: 'leather_armor', name: 'ÁöÆÁî≤', type: 'armor', defense: 10, price: 80, description: 'Èò≤Âæ°Âäõ+10ÁöÑÁöÆÂà∂Êä§Áî≤' },
            { id: 'magic_ring', name: 'È≠îÊ≥ïÊàíÊåá', type: 'accessory', mp: 20, price: 150, description: 'Â¢ûÂä†20ÁÇπÊúÄÂ§ßÈ≠îÊ≥ïÂÄº' },
            { id: 'strength_potion', name: 'ÂäõÈáèËçØÊ∞¥', type: 'consumable', effect: { attack: 10 }, price: 50, description: '‰∏¥Êó∂Â¢ûÂä†10ÁÇπÊîªÂáªÂäõ' }
        ];

        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            updateUI();
            generateMap();
            addLog('Ê∏∏ÊàèÂàùÂßãÂåñÂÆåÊàêÔºÅ');
        }

        // Êõ¥Êñ∞UI
        function updateUI() {
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-gold').textContent = gameState.player.gold;
            
            // Êõ¥Êñ∞Ë°ÄÊù°
            const hpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            document.getElementById('hp-bar').style.width = hpPercent + '%';
            document.getElementById('hp-text').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            
            // Êõ¥Êñ∞È≠îÊ≥ïÊù°
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('mp-bar').style.width = mpPercent + '%';
            document.getElementById('mp-text').textContent = `${gameState.player.mp}/${gameState.player.maxMp}`;
            
            // Êõ¥Êñ∞ÁªèÈ™åÊù°
            const expPercent = (gameState.player.exp / gameState.player.maxExp) * 100;
            document.getElementById('exp-bar').style.width = expPercent + '%';
            document.getElementById('exp-text').textContent = `${gameState.player.exp}/${gameState.player.maxExp}`;

            // Êõ¥Êñ∞‰ºô‰º¥‰ø°ÊÅØ
            if (gameState.hasCompanion) {
                document.getElementById('companion-section').style.display = 'block';
                document.getElementById('character-img').src="./monster1.png"';
            }
        }

        // Ê∑ªÂä†Êó•Âøó
        function addLog(message) {
            const logDiv = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ÂàáÊç¢Ê∏∏ÊàèÊ®°Âºè
        function switchMode(mode) {
            // ÈöêËóèÊâÄÊúâÊ®°Âºè
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'none';
            
            // ÊòæÁ§∫ÊåáÂÆöÊ®°Âºè
            document.getElementById(mode + '-mode').style.display = 'block';
            gameState.gameMode = mode;
        }

        // ÊïÖ‰∫ãÈÄâÊã©ÂáΩÊï∞
        function goToVillageChief() {
            document.getElementById('story-text').innerHTML = `
                ÊùëÈïøÊòØ‰∏Ä‰ΩçÊÖàÁ••ÁöÑËÄÅ‰∫∫Ôºå‰ªñÁöÑÁúº‰∏≠Èó™ÁÉÅÁùÄÊô∫ÊÖßÁöÑÂÖâËäí„ÄÇÂΩì‰Ω†Ëµ∞Ëøõ‰ªñÁöÑÊàøÈó¥Êó∂Ôºå‰ªñÊ≠£Âú®Á†îÁ©∂‰∏ÄÂº†Âè§ËÄÅÁöÑÂú∞Âõæ„ÄÇ
                <br><br>
                "Âπ¥ËΩªÁöÑÊÑèÂõæÊ≥ïÂ∏àÔºå"ÊùëÈïøÊä¨Ëµ∑Â§¥ÁúãÁùÄ‰Ω†Ôºå"Êàë‰ª¨ÊùëÂ∫ÑÊúÄËøëÈÅáÂà∞‰∫ÜÈ∫ªÁÉ¶„ÄÇÊ£ÆÊûóÊ∑±Â§ÑÂá∫Áé∞‰∫Ü‰∏Ä‰∫õÂ•áÊÄ™ÁöÑÁîüÁâ©ÔºåÂÆÉ‰ª¨‰ºº‰πéË¢´ÊüêÁßçÊâ≠Êõ≤ÁöÑÊÑèÂõæÊâÄÈ©±Âä®„ÄÇ
                <br><br>
                ÊàëÈúÄË¶Å‰Ω†ÂéªË∞ÉÊü•Ëøô‰ª∂‰∫ãÔºå‰ΩÜÈ¶ñÂÖàÔºå‰Ω†ÈúÄË¶Å‰∏Ä‰∏™‰ºô‰º¥„ÄÇÂú®ÊùëÂ∫ÑÁöÑ‰∏úËæπÔºåÊúâ‰∏ÄÂè™ÂêçÂè´ËôæËôæÁöÑÁ•ûÂ•áÁîüÁâ©ÔºåÂÆÉ‰∏ÄÁõ¥Âú®Á≠âÂæÖÂêàÈÄÇÁöÑÊÑèÂõæÊ≥ïÂ∏à„ÄÇ"
            `;
            
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="findCompanion()">ü¶ê Êé•Âèó‰ªªÂä°ÔºåÂâçÂæÄÂØªÊâæËôæËôæ</button>
                <button class="choice-btn" onclick="openInn()">üè® ÂÖàÂéªÊóÖÂ∫ó‰ºëÊÅØ‰∏Ä‰∏ã</button>
                <button class="choice-btn" onclick="openShop()">üè™ ÂâçÂæÄÂïÜÂ∫óË¥≠‰π∞Ë£ÖÂ§á</button>
                <button class="choice-btn" onclick="backToVillage()">üè† ËøîÂõûÊùëÂ∫Ñ‰∏≠ÂøÉ</button>
            `;
            
            addLog('‰Ω†ÂâçÂæÄÊùëÈïøÂÆ∂Êé•Âèó‰∫Ü‰ªªÂä°');
        }

        function findCompanion() {
            gameState.hasCompanion = true;
            document.getElementById('story-text').innerHTML = `
                ‰Ω†Êù•Âà∞ÊùëÂ∫Ñ‰∏úËæπÁöÑÂ∞èÊ∫™ÊóÅÔºåËøôÈáåÊ∞¥Ëçâ‰∏∞ËåÇÔºåÈò≥ÂÖâÈÄèËøáÊ†ëÂè∂Ê¥íÂú®Ê∞¥Èù¢‰∏ä„ÄÇÁ™ÅÁÑ∂Ôºå‰∏Ä‰∏™Á∫¢Ëâ≤ÁöÑË∫´ÂΩ±‰ªéÊ∞¥‰∏≠Ë∑ÉÂá∫ÔºÅ
                <br><br>
                ËøôÂ∞±ÊòØËôæËôæ‚Äî‚Äî‰∏ÄÂè™Êà¥ÁùÄËìùËâ≤Â∏ΩÂ≠êÁöÑÁ•ûÂ•áËôæÁ±ªÁîüÁâ©„ÄÇÂÆÉÁöÑÁúº‰∏≠Èó™ÁÉÅÁùÄÁîµÂÖâÔºå‰ºº‰πéÊã•ÊúâÊüêÁßçÁâπÊÆäÁöÑËÉΩÂäõ„ÄÇ
                <br><br>
                ËôæËôæÁúãÂà∞‰Ω†ÂêéÔºåÂÖ¥Â•ãÂú∞Ê∏∏Âà∞Â≤∏ËæπÔºåÁî®ÂÆÉÁã¨ÁâπÁöÑÊñπÂºè‰∏é‰Ω†‰∫§ÊµÅ„ÄÇ‰Ω†ÊÑüÂèóÂà∞‰∫Ü‰∏ÄÁßçÂ•áÂ¶ôÁöÑÊÑèÂõæÂÖ±È∏£„ÄÇ
                <br><br>
                <strong>ËôæËôæÂä†ÂÖ•‰∫Ü‰Ω†ÁöÑÈòü‰ºçÔºÅ</strong>
            `;
            
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="exploreForest()">üå≤ ‰∏éËôæËôæ‰∏ÄËµ∑Êé¢Á¥¢Ê£ÆÊûó</button>
                <button class="choice-btn" onclick="openShop()">üè™ ÂÖàÂéªÂïÜÂ∫óË¥≠‰π∞Ë£ÖÂ§á</button>
                <button class="choice-btn" onclick="openInn()">üè® ÂéªÊóÖÂ∫óÂ∫ÜÁ•ù‰∏Ä‰∏ã</button>
                <button class="choice-btn" onclick="backToVillage()">üè† ËøîÂõûÊùëÂ∫Ñ‰∏≠ÂøÉ</button>
            `;
            
            updateUI();
            addLog('ËôæËôæÂä†ÂÖ•‰∫Ü‰Ω†ÁöÑÈòü‰ºçÔºÅ');
        }

        function exploreForest() {
            document.getElementById('story-text').innerHTML = `
                ‰Ω†${gameState.hasCompanion ? 'ÂíåËôæËôæ‰∏ÄËµ∑' : ''}Êù•Âà∞‰∫ÜÊùëÂ∫ÑÂ§ñÁöÑÊ£ÆÊûóËæπÁºò„ÄÇËøôÈáåÁöÑÊ†ëÊú®ÂºÇÂ∏∏È´òÂ§ßÔºåÊûùÂè∂ËåÇÂØÜÂæóÂá†‰πéÈÅÆËîΩ‰∫ÜÂ§©Á©∫„ÄÇ
                <br><br>
                Á©∫Ê∞î‰∏≠Âº•Êº´ÁùÄ‰∏ÄÁßçÂ•áÁâπÁöÑËÉΩÈáèÊ≥¢Âä®Ôºå‰Ω†ÁöÑÊÑèÂõæÊÑüÁü•ÂëäËØâ‰Ω†ÔºåËøôÈáåÈöêËóèÁùÄËÆ∏Â§öÁßòÂØÜ„ÄÇ
                <br><br>
                ËøúÂ§Ñ‰º†Êù•‰∫ÜÂ•áÊÄ™ÁöÑÂ£∞Èü≥Ôºå‰ºº‰πéÊòØÊüêÁßçÁîüÁâ©Âú®ÁßªÂä®„ÄÇ‰Ω†ÈúÄË¶ÅÂ∞èÂøÉË°å‰∫ã„ÄÇ
            `;
            
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="encounterBattle()">‚öîÔ∏è Ê∑±ÂÖ•Ê£ÆÊûóÊé¢Á¥¢</button>
                <button class="choice-btn" onclick="findTreasure()">üíé ÊêúÁ¥¢ÈöêËóèÁöÑÂÆùËóè</button>
                <button class="choice-btn" onclick="openMap()">üó∫Ô∏è Êü•ÁúãÂú∞ÂõæËßÑÂàíË∑ØÁ∫ø</button>
                <button class="choice-btn" onclick="backToVillage()">üè† ËøîÂõûÊùëÂ∫Ñ</button>
            `;
            
            addLog('‰Ω†ËøõÂÖ•‰∫ÜÁ•ûÁßòÁöÑÊ£ÆÊûó');
        }

        function encounterBattle() {
            const damage = Math.floor(Math.random() * 20) + 10;
            const expGain = Math.floor(Math.random() * 30) + 20;
            const goldGain = Math.floor(Math.random() * 50) + 25;
            
            gameState.player.hp = Math.max(0, gameState.player.hp - damage);
            gameState.player.exp += expGain;
            gameState.player.gold += goldGain;
            
            // Ê£ÄÊü•ÂçáÁ∫ß
            if (gameState.player.exp >= gameState.player.maxExp) {
                gameState.player.level++;
                gameState.player.exp = 0;
                gameState.player.maxExp += 50;
                gameState.player.maxHp += 20;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.maxMp += 10;
                gameState.player.mp = gameState.player.maxMp;
                addLog(`ÊÅ≠ÂñúÔºÅ‰Ω†ÂçáÂà∞‰∫Ü${gameState.player.level}Á∫ßÔºÅ`);
            }
            
            document.getElementById('story-text').innerHTML = `
                ‰Ω†Âú®Ê£ÆÊûóÊ∑±Â§ÑÈÅáÂà∞‰∫Ü‰∏ÄÂè™Ë¢´Êâ≠Êõ≤ÊÑèÂõæÂΩ±ÂìçÁöÑÊ£ÆÊûóÁîüÁâ©ÔºÅ
                <br><br>
                ÁªèËøá‰∏ÄÁï™ÊøÄÁÉàÁöÑÊàòÊñóÔºå‰Ω†${gameState.hasCompanion ? 'ÂíåËôæËôæ' : ''}ÊàêÂäüÂáªË¥•‰∫ÜÂÆÉ„ÄÇËôΩÁÑ∂Âèó‰∫Ü‰∏Ä‰∫õ‰º§Ôºà-${damage} HPÔºâÔºå‰ΩÜ‰Ω†Ëé∑Âæó‰∫ÜÂÆùË¥µÁöÑÁªèÈ™å„ÄÇ
                <br><br>
                <strong>ÊàòÊñóÁªìÊûúÔºö</strong><br>
                ‚Ä¢ ÂèóÂà∞‰º§ÂÆ≥Ôºö${damage} HP<br>
                ‚Ä¢ Ëé∑ÂæóÁªèÈ™åÔºö${expGain} EXP<br>
                ‚Ä¢ Ëé∑ÂæóÈáëÂ∏ÅÔºö${goldGain} üí∞
            `;
            
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="openInn()">üè® ÂéªÊóÖÂ∫óÊ≤ªÁñó‰º§Âäø</button>
                <button class="choice-btn" onclick="usePotion()">üß™ ‰ΩøÁî®Ê≤ªÁñóËçØÊ∞¥</button>
                <button class="choice-btn" onclick="exploreForest()">üå≤ ÁªßÁª≠Êé¢Á¥¢Ê£ÆÊûó</button>
                <button class="choice-btn" onclick="backToVillage()">üè† ËøîÂõûÊùëÂ∫Ñ</button>
            `;
            
            updateUI();
            addLog(`ÊàòÊñóËÉúÂà©ÔºÅËé∑Âæó${expGain}ÁªèÈ™åÂíå${goldGain}ÈáëÂ∏Å`);
        }

        function findTreasure() {
            const goldFound = Math.floor(Math.random() * 100) + 50;
            gameState.player.gold += goldFound;
            
            // ÈöèÊú∫Ëé∑ÂæóÁâ©ÂìÅ
            const treasureItems = [
                { id: 'rare_potion', name: 'Á®ÄÊúâÊ≤ªÁñóËçØÊ∞¥', type: 'consumable', effect: { hp: 80 }, price: 120, description: 'ÊÅ¢Â§ç80ÁÇπÁîüÂëΩÂÄºÁöÑÁèçË¥µËçØÊ∞¥' },
                { id: 'magic_crystal', name: 'È≠îÊ≥ïÊ∞¥Êô∂', type: 'consumable', effect: { mp: 50 }, price: 100, description: 'Ëï¥Âê´Á∫ØÂáÄÈ≠îÊ≥ïËÉΩÈáèÁöÑÊ∞¥Êô∂' }
            ];
            
            const foundItem = treasureItems[Math.floor(Math.random() * treasureItems.length)];
            gameState.player.inventory.push(foundItem);
            
            document.getElementById('story-text').innerHTML = `
                Âú®Ê£ÆÊûóÁöÑ‰∏Ä‰∏™ÈöêÁßòËßíËêΩÔºå‰Ω†ÂèëÁé∞‰∫Ü‰∏Ä‰∏™Âè§ËÄÅÁöÑÂÆùÁÆ±ÔºÅ
                <br><br>
                ÂÆùÁÆ±Êï£ÂèëÁùÄÂæÆÂº±ÁöÑÊÑèÂõæÂÖâËäíÔºåÊòæÁÑ∂ÊòØË¢´ÊüêÁßçÈ≠îÊ≥ï‰øùÊä§ÁùÄÁöÑ„ÄÇÂΩì‰Ω†Â∞èÂøÉÁøºÁøºÂú∞ÊâìÂºÄÂÆÉÊó∂ÔºåÈáåÈù¢ÁöÑÂÆùÁâ©ËÆ©‰Ω†ÁúºÂâç‰∏Ä‰∫ÆÔºÅ
                <br><br>
                <strong>ÂèëÁé∞ÂÆùËóèÔºö</strong><br>
                ‚Ä¢ ÈáëÂ∏ÅÔºö${goldFound} üí∞<br>
                ‚Ä¢ Áâ©ÂìÅÔºö${foundItem.name}
            `;
            
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="exploreForest()">üå≤ ÁªßÁª≠Êé¢Á¥¢Ê£ÆÊûó</button>
                <button class="choice-btn" onclick="openInventory()">üéí Êü•ÁúãËé∑ÂæóÁöÑÁâ©ÂìÅ</button>
                <button class="choice-btn" onclick="backToVillage()">üè† ËøîÂõûÊùëÂ∫Ñ</button>
                <button class="choice-btn" onclick="openShop()">üè™ ÂéªÂïÜÂ∫óÂá∫ÂîÆÁâ©ÂìÅ</button>
            `;
            
            updateUI();
            addLog(`ÂèëÁé∞ÂÆùËóèÔºÅËé∑Âæó${goldFound}ÈáëÂ∏ÅÂíå${foundItem.name}`);
        }

        function usePotion() {
            const potionIndex = gameState.player.inventory.findIndex(item => item.type === 'consumable' && item.effect.hp);
            if (potionIndex !== -1) {
                const potion = gameState.player.inventory[potionIndex];
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + potion.effect.hp);
                gameState.player.inventory.splice(potionIndex, 1);
                addLog(`‰ΩøÁî®‰∫Ü${potion.name}ÔºåÊÅ¢Â§ç‰∫Ü${potion.effect.hp}ÁÇπÁîüÂëΩÂÄº`);
                updateUI();
                exploreForest();
            } else {
                addLog('‰Ω†Ê≤°ÊúâÊ≤ªÁñóËçØÊ∞¥ÔºÅ');
                exploreForest();
            }
        }

        function backToVillage() {
            document.getElementById('story-text').innerHTML = `
                ‰Ω†ÂõûÂà∞‰∫ÜÁÜüÊÇâÁöÑÊñ∞ÊâãÊùë„ÄÇÊùëÂ∫ÑÈáåÁöÑ‰∫∫‰ª¨Ê≠£Âú®ÂøôÁ¢åÁùÄÂêÑËá™ÁöÑ‰∫ãÊÉÖÔºåÁ©∫Ê∞î‰∏≠Âº•Êº´ÁùÄÁÇäÁÉüÁöÑÈ¶ôÂë≥„ÄÇ
                <br><br>
                ${gameState.hasCompanion ? 'ËôæËôæÂú®‰Ω†Ë∫´ËæπÊ∏∏Êù•Ê∏∏ÂéªÔºå‰ºº‰πéÂØπËøô‰∏™Âú∞ÊñπÂæàÊÑüÂÖ¥Ë∂£„ÄÇ' : ''}
                <br><br>
                ‰Ω†ÂèØ‰ª•ÈÄâÊã©Êé•‰∏ãÊù•Ë¶ÅÂÅö‰ªÄ‰πà„ÄÇ
            `;
            
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="goToVillageChief()">üè† ÂâçÂæÄÊùëÈïøÂÆ∂Êé•Âèó‰ªªÂä°</button>
                <button class="choice-btn" onclick="exploreForest()">üå≤ Êé¢Á¥¢ÊùëÂ∫ÑÂë®Âõ¥ÁöÑÊ£ÆÊûó</button>
                <button class="choice-btn" onclick="openInventory()">üìä Êü•Áúã‰∏™‰∫∫Áä∂ÊÄÅÂíåË£ÖÂ§á</button>
                <button class="choice-btn" onclick="openShop()">üè™ ÂâçÂæÄÂïÜÂ∫óË¥≠‰π∞Áâ©ÂìÅ</button>
                <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ÊâìÂºÄ‰∏ñÁïåÂú∞Âõæ</button>
            `;
            
            addLog('‰Ω†ÂõûÂà∞‰∫ÜÊùëÂ∫Ñ‰∏≠ÂøÉ');
        }

        // ÂïÜÂ∫óÂäüËÉΩ
        function openShop() {
            switchMode('shop');
            renderShop();
            addLog('‰Ω†ËøõÂÖ•‰∫ÜÂïÜÂ∫ó');
        }

        function renderShop() {
            const shopContainer = document.getElementById('shop-items');
            shopContainer.innerHTML = '';
            
            shopItems.forEach(item => {
                const canAfford = gameState.player.gold >= item.price;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                        <div class="item-price">‰ª∑Ê†º: ${item.price} ÈáëÂ∏Å</div>
                    </div>
                    <button class="buy-btn" onclick="buyItem('${item.id}')" ${!canAfford ? 'disabled' : ''}>
                        ${canAfford ? 'Ë¥≠‰π∞' : 'ÈáëÂ∏Å‰∏çË∂≥'}
                    </button>
                `;
                shopContainer.appendChild(itemDiv);
            });
        }

        function buyItem(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (item && gameState.player.gold >= item.price) {
                gameState.player.gold -= item.price;
                gameState.player.inventory.push({...item});
                addLog(`Ë¥≠‰π∞‰∫Ü${item.name}ÔºåËä±Ë¥π${item.price}ÈáëÂ∏Å`);
                updateUI();
                renderShop();
            }
        }

        // ÊóÖÂ∫óÂäüËÉΩ
        function openInn() {
            switchMode('inn');
            updateRestButton();
            addLog('‰Ω†ËøõÂÖ•‰∫ÜÊóÖÂ∫ó');
        }

        function updateRestButton() {
            const restBtn = document.getElementById('rest-btn');
            const canAfford = gameState.player.gold >= 20;
            const needsRest = gameState.player.hp < gameState.player.maxHp || gameState.player.mp < gameState.player.maxMp;
            
            restBtn.disabled = !canAfford || !needsRest;
            
            if (!needsRest) {
                restBtn.textContent = 'üí§ ‰Ω†Â∑≤ÁªèÂÆåÂÖ®ÊÅ¢Â§ç‰∫Ü';
            } else if (!canAfford) {
                restBtn.textContent = 'üí§ ÈáëÂ∏Å‰∏çË∂≥ (ÈúÄË¶Å20ÈáëÂ∏Å)';
            } else {
                restBtn.textContent = 'üí§ ‰ºëÊÅØ (20ÈáëÂ∏Å)';
            }
        }

        function restAtInn() {
            if (gameState.player.gold >= 20) {
                gameState.player.gold -= 20;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.mp = gameState.player.maxMp;
                
                document.getElementById('inn-dialogue').innerHTML = `
                    "Â•ΩÂ•Ω‰ºëÊÅØÂêßÔºÅ"Áéõ‰∏ΩÊ∏©ÂíåÂú∞ËØ¥ÈÅì„ÄÇ‰Ω†Âú®ËàíÈÄÇÁöÑÂ∫äÈì∫‰∏äÁù°‰∫Ü‰∏ÄËßâÔºåÊÑüËßâÁ≤æÁ•ûÁÑïÂèëÔºÅ
                    <br><br>
                    <strong>‰Ω†ÁöÑÁîüÂëΩÂÄºÂíåÈ≠îÊ≥ïÂÄºÂ∑≤ÂÆåÂÖ®ÊÅ¢Â§çÔºÅ</strong>
                `;
                
                addLog('Âú®ÊóÖÂ∫ó‰ºëÊÅØÔºåÂÆåÂÖ®ÊÅ¢Â§ç‰∫ÜÁîüÂëΩÂÄºÂíåÈ≠îÊ≥ïÂÄº');
                updateUI();
                updateRestButton();
            }
        }

        // ËÉåÂåÖÂäüËÉΩ
        function openInventory() {
            switchMode('inventory');
            renderInventory();
            addLog('‰Ω†ÊâìÂºÄ‰∫ÜËÉåÂåÖ');
        }

        function renderInventory() {
            const inventoryContainer = document.getElementById('inventory-items');
            inventoryContainer.innerHTML = '';
            
            if (gameState.player.inventory.length === 0) {
                inventoryContainer.innerHTML = '<p>ËÉåÂåÖÊòØÁ©∫ÁöÑ</p>';
                return;
            }
            
            gameState.player.inventory.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                
                let actionButton = '';
                if (item.type === 'consumable') {
                    actionButton = `<button class="use-btn" onclick="useInventoryItem(${index})">‰ΩøÁî®</button>`;
                } else {
                    actionButton = `<button class="equip-btn" onclick="equipItem(${index})">Ë£ÖÂ§á</button>`;
                }
                
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                        <div class="item-price">‰ª∑ÂÄº: ${item.price} ÈáëÂ∏Å</div>
                    </div>
                    <div>
                        ${actionButton}
                        <button class="sell-btn" onclick="sellItem(${index})">Âá∫ÂîÆ</button>
                    </div>
                `;
                inventoryContainer.appendChild(itemDiv);
            });
        }

        function useInventoryItem(index) {
            const item = gameState.player.inventory[index];
            if (item.type === 'consumable') {
                if (item.effect.hp) {
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + item.effect.hp);
                    addLog(`‰ΩøÁî®‰∫Ü${item.name}ÔºåÊÅ¢Â§ç‰∫Ü${item.effect.hp}ÁÇπÁîüÂëΩÂÄº`);
                }
                if (item.effect.mp) {
                    gameState.player.mp = Math.min(gameState.player.maxMp, gameState.player.mp + item.effect.mp);
                    addLog(`‰ΩøÁî®‰∫Ü${item.name}ÔºåÊÅ¢Â§ç‰∫Ü${item.effect.mp}ÁÇπÈ≠îÊ≥ïÂÄº`);
                }
                
                gameState.player.inventory.splice(index, 1);
                updateUI();
                renderInventory();
            }
        }

        function equipItem(index) {
            const item = gameState.player.inventory[index];
            // ÁÆÄÂåñÁöÑË£ÖÂ§áÁ≥ªÁªü
            addLog(`Ë£ÖÂ§á‰∫Ü${item.name}`);
            gameState.player.inventory.splice(index, 1);
            renderInventory();
        }

        function sellItem(index) {
            const item = gameState.player.inventory[index];
            const sellPrice = Math.floor(item.price * 0.7); // 70%ÁöÑ‰ª∑Ê†ºÂá∫ÂîÆ
            gameState.player.gold += sellPrice;
            gameState.player.inventory.splice(index, 1);
            addLog(`Âá∫ÂîÆ‰∫Ü${item.name}ÔºåËé∑Âæó${sellPrice}ÈáëÂ∏Å`);
            updateUI();
            renderInventory();
        }

        // Âú∞ÂõæÂäüËÉΩ
        function openMap() {
            switchMode('map');
            renderMap();
            addLog('‰Ω†ÊâìÂºÄ‰∫Ü‰∏ñÁïåÂú∞Âõæ');
        }

        function generateMap() {
            gameState.gameMap = [];
            for (let y = 0; y < 10; y++) {
                gameState.gameMap[y] = [];
                for (let x = 0; x < 10; x++) {
                    let terrain = 'grass';
                    if (Math.random() < 0.2) terrain = 'forest';
                    else if (Math.random() < 0.1) terrain = 'mountain';
                    else if (Math.random() < 0.05) terrain = 'town';
                    
                    gameState.gameMap[y][x] = {
                        terrain: terrain,
                        discovered: false
                    };
                }
            }
            
            // ËÆæÁΩÆËµ∑Âßã‰ΩçÁΩÆ
            gameState.gameMap[gameState.player.y][gameState.player.x] = {
                terrain: 'village',
                discovered: true
            };
        }

        function renderMap() {
            const mapContainer = document.getElementById('map-grid');
            mapContainer.innerHTML = '';
            
            for (let y = 0; y < 10; y++) {
                for (let x = 0; x < 10; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    
                    if (x === gameState.player.x && y === gameState.player.y) {
                        cell.textContent = 'üßô‚Äç‚ôÇÔ∏è';
                        cell.classList.add('player');
                    } else if (gameState.gameMap[y][x].discovered) {
                        const terrain = gameState.gameMap[y][x].terrain;
                        switch (terrain) {
                            case 'village': cell.textContent = 'üèòÔ∏è'; break;
                            case 'town': cell.textContent = 'üèõÔ∏è'; cell.classList.add('town'); break;
                            case 'forest': cell.textContent = 'üå≤'; cell.classList.add('forest'); break;
                            case 'mountain': cell.textContent = '‚õ∞Ô∏è'; cell.classList.add('mountain'); break;
                            default: cell.textContent = 'üå±'; break;
                        }
                    } else {
                        cell.textContent = '‚ùì';
                    }
                    
                    cell.onclick = () => movePlayerTo(x, y);
                    mapContainer.appendChild(cell);
                }
            }
        }

        function movePlayer(dx, dy) {
            const newX = Math.max(0, Math.min(9, gameState.player.x + dx));
            const newY = Math.max(0, Math.min(9, gameState.player.y + dy));
            
            if (newX !== gameState.player.x || newY !== gameState.player.y) {
                gameState.player.x = newX;
                gameState.player.y = newY;
                
                // ÂèëÁé∞Êñ∞Âå∫Âüü
                gameState.gameMap[newY][newX].discovered = true;
                
                // ÈöèÊú∫‰∫ã‰ª∂
                const terrain = gameState.gameMap[newY][newX].terrain;
                if (terrain === 'forest' && Math.random() < 0.3) {
                    addLog('Âú®Ê£ÆÊûó‰∏≠ÈÅáÂà∞‰∫ÜÈáéÁîüÂä®Áâ©ÔºÅ');
                } else if (terrain === 'town') {
                    addLog('Âà∞Ëææ‰∫Ü‰∏Ä‰∏™ÁπÅÂçéÁöÑÂüéÈïá');
                }
                
                renderMap();
                addLog(`ÁßªÂä®Âà∞‰ΩçÁΩÆ (${newX}, ${newY})`);
            }
        }

        function movePlayerTo(x, y) {
            const distance = Math.abs(x - gameState.player.x) + Math.abs(y - gameState.player.y);
            if (distance === 1) {
                movePlayer(x - gameState.player.x, y - gameState.player.y);
            }
        }

        // ËøîÂõûÊïÖ‰∫ãÊ®°Âºè
        function backToStory() {
            switchMode('story');
            addLog('ËøîÂõûÂà∞ÊïÖ‰∫ãÊ®°Âºè');
        }

        // ‰øùÂ≠òÂíåÂä†ËΩΩÊ∏∏Êàè
        function saveGame() {
            localStorage.setItem('anomaRpgSave', JSON.stringify(gameState));
            addLog('Ê∏∏ÊàèÂ∑≤‰øùÂ≠ò');
        }

        function loadGame() {
            const saved = localStorage.getItem('anomaRpgSave');
            if (saved) {
                gameState = JSON.parse(saved);
                updateUI();
                addLog('Ê∏∏ÊàèÂ∑≤Âä†ËΩΩ');
            } else {
                addLog('Ê≤°ÊúâÊâæÂà∞‰øùÂ≠òÁöÑÊ∏∏Êàè');
            }
        }

        // ÈîÆÁõòÊéßÂà∂
        document.addEventListener('keydown', function(e) {
            if (gameState.gameMode === 'map') {
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                        e.preventDefault();
                        movePlayer(0, -1);
                        break;
                    case 'ArrowDown':
                    case 's':
                        e.preventDefault();
                        movePlayer(0, 1);
                        break;
                    case 'ArrowLeft':
                    case 'a':
                        e.preventDefault();
                        movePlayer(-1, 0);
                        break;
                    case 'ArrowRight':
                    case 'd':
                        e.preventDefault();
                        movePlayer(1, 0);
                        break;
                }
            }
        });

        // Ê∏∏ÊàèÂàùÂßãÂåñ
        window.onload = function() {
            initGame();
        };
    </script>
</body>
</html>

