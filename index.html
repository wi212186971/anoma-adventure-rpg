<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anoma RPG - ÊÑèÂõæ‰πãÂ¢É</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ffd700;
        }

        .game-title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .game-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #444;
        }

        .main-content {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }

        .player-stats {
            margin-bottom: 20px;
        }

        .stat-bar {
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #666;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .hp-bar { background: #e74c3c; }
        .mp-bar { background: #3498db; }
        .exp-bar { background: #f39c12; }

        .character-image {
            text-align: center;
            margin: 20px 0;
        }

        .character-image img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 10px;
            border: 2px solid #ffd700;
        }

        .story-content {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #666;
        }

        .story-text {
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .choices {
            display: grid;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            border: 2px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-btn:hover {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        .shop-container, .inn-container, .inventory-container, .map-container {
            display: none;
        }

        .shop-container.active, .inn-container.active, .inventory-container.active, .map-container.active {
            display: block;
        }

        .shop-items, .inventory-items {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }

        .item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            color: #ffd700;
        }

        .item-description {
            font-size: 0.9em;
            color: #ccc;
            margin: 5px 0;
        }

        .item-price {
            color: #f39c12;
            font-weight: bold;
        }

        .buy-btn, .sell-btn, .use-btn, .equip-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .buy-btn:hover, .sell-btn:hover, .use-btn:hover, .equip-btn:hover {
            background: #2ecc71;
        }

        .buy-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .game-log {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #666;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }

        .back-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .back-btn:hover {
            background: #c0392b;
        }

        .inn-service {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .rest-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 10px;
        }

        .rest-btn:hover {
            background: #8e44ad;
        }

        .rest-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .npc-dialogue {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #f39c12;
        }

        .npc-name {
            color: #f39c12;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .dialogue-text {
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(10, 40px);
            gap: 2px;
            margin: 20px 0;
            justify-content: center;
        }

        .map-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 3px;
            background: #2c3e50;
        }

        .map-cell.player {
            background: #e74c3c;
            border-color: #ffd700;
        }

        .map-cell.forest {
            background: #27ae60;
        }

        .map-cell.town {
            background: #3498db;
        }

        .map-cell.mountain {
            background: #95a5a6;
        }

        .map-cell.cave {
            background: #6a3200;
        }

        .companion-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #3498db;
        }

        .companion-name {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr;
            }
            
            .game-title {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">üßô‚Äç‚ôÇÔ∏è Anoma RPG - ÊÑèÂõæ‰πãÂ¢É üåü</h1>
        
        <div class="game-layout">
            <!-- ‰æßËæπÊ†è - ËßíËâ≤Áä∂ÊÄÅ -->
            <div class="sidebar">
                <div class="player-stats">
                    <h3>üßô‚Äç‚ôÇÔ∏è ÊÑèÂõæÊ≥ïÂ∏à</h3>
                    <p>Á≠âÁ∫ß: <span id="player-level">1</span></p>
                    <p>ÈáëÂ∏Å: <span id="player-gold">100</span> üí∞</p>
                    
                    <div class="stat-bar">
                        <div class="stat-label">ÁîüÂëΩÂÄº: <span id="hp-text">100/100</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill hp-bar" id="hp-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">È≠îÊ≥ïÂÄº: <span id="mp-text">50/50</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill mp-bar" id="mp-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">ÁªèÈ™åÂÄº: <span id="exp-text">0/100</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill exp-bar" id="exp-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="character-image">
                    <img id="character-img" src="./wizard.png" alt="ËßíËâ≤ÂõæÂÉè">
                </div>

                <!-- ‰ºô‰º¥‰ø°ÊÅØ -->
                <div id="companion-section" style="display: none;">
                    <div class="companion-info">
                        <div class="companion-name" id="companion-name">ËôæËôæ</div>
                        <div class="stat-bar">
                            <div class="stat-label">ÁîüÂëΩÂÄº: <span id="companion-hp-text">60/60</span></div>
                            <div class="progress-bar">
                                <div class="progress-fill hp-bar" id="companion-hp-bar" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Âø´Êç∑Êìç‰Ωú -->
                <div style="margin-top: 20px;">
                    <button class="choice-btn" onclick="saveGame()" style="width: 100%; margin-bottom: 10px;">üíæ ‰øùÂ≠òÊ∏∏Êàè</button>
                    <button class="choice-btn" onclick="loadGame()" style="width: 100%;">üìÅ Âä†ËΩΩÊ∏∏Êàè</button>
                </div>
            </div>

            <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
            <div class="main-content">
                <!-- ÊïÖ‰∫ãÊ®°Âºè -->
                <div id="story-mode">
                    <div class="story-content">
                        <div class="story-text" id="story-text">
                            Âú®AnomaÁöÑÁ•ûÁßò‰∏ñÁïå‰∏≠Ôºå‰Ω†ÊòØ‰∏ÄÂêçÂàöÂàöËßâÈÜíÊÑèÂõæËÉΩÂäõÁöÑÂπ¥ËΩªÊ≥ïÂ∏à„ÄÇËøô‰∏™‰∏ñÁïåÁî±Êó†Êï∞‰∏™"ÊÑèÂõæ"ÊûÑÊàêÔºåÊØè‰∏™ÊÑèÂõæÈÉΩÊòØÁé∞ÂÆûÁöÑ‰∏Ä‰∏™ÁâáÊÆµÔºåËÄå‰Ω†Êã•ÊúâÊìçÊéßËøô‰∫õÊÑèÂõæÁöÑÂ§©Ëµã„ÄÇ

                            ‰Ω†Á´ôÂú®Êñ∞ÊâãÊùëÁöÑ‰∏≠Â§ÆÔºåÂë®Âõ¥ÊòØÁÜüÊÇâÁöÑËåÖËçâÂ±ãÂíåÁü≥ÊùøË∑Ø„ÄÇËøúÂ§ÑÁöÑÂú∞Âπ≥Á∫ø‰∏äÔºåÁ•ûÁßòÁöÑÊÑèÂõæ‰πãÂ°îËã•ÈöêËã•Áé∞ÔºåÈÇ£ÈáåÊçÆËØ¥ÈöêËóèÁùÄAnoma‰∏ñÁïåÁöÑÁªàÊûÅÁßòÂØÜ„ÄÇ

                            ‰Ω†ÁöÑÂØºÂ∏àÂëäËØâ‰Ω†ÔºåÂè™ÊúâÈÄöËøá‰∏çÊñ≠ÁöÑÂÜíÈô©ÂíåÊàòÊñóÔºåÊâçËÉΩÊèêÂçá‰Ω†ÁöÑÊÑèÂõæÊìçÊéßËÉΩÂäõÔºåÊúÄÁªàÊàê‰∏∫ÁúüÊ≠£ÁöÑÊÑèÂõæÂ§ßÂ∏à„ÄÇ
                        </div>
                        
                        <div class="choices" id="story-choices">
                            <button class="choice-btn" onclick="goToVillageChief()">üè† ÂâçÂæÄÊùëÈïøÂÆ∂Êé•ÂèóÁ¨¨‰∏Ä‰∏™‰ªªÂä°</button>
                            <button class="choice-btn" onclick="exploreForest()">üå≤ Êé¢Á¥¢ÊùëÂ∫ÑÂë®Âõ¥ÁöÑÊ£ÆÊûó</button>
                            <button class="choice-btn" onclick="openInventory()">üìä Êü•Áúã‰∏™‰∫∫Áä∂ÊÄÅÂíåË£ÖÂ§á</button>
                            <button class="choice-btn" onclick="openShop()">üè™ ÂâçÂæÄÂïÜÂ∫óË¥≠‰π∞Áâ©ÂìÅ</button>
                            <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ÊâìÂºÄ‰∏ñÁïåÂú∞Âõæ</button>
                        </div>
                    </div>
                </div>

                <!-- ÂïÜÂ∫óÊ®°Âºè -->
                <div id="shop-mode" class="shop-container">
                    <h2>üè™ ÊÑèÂõæÂïÜÂ∫ó</h2>
                    <p>Ê¨¢ËøéÊù•Âà∞ÊÑèÂõæÂïÜÂ∫óÔºÅËøôÈáåÊúâÂêÑÁßçÂÜíÈô©ÂøÖÈúÄÂìÅ„ÄÇ</p>
                    
                    <div class="npc-dialogue">
                        <div class="npc-name">ÂïÜ‰∫∫È≤çÂãÉ</div>
                        <div class="dialogue-text">
                            "Ê¨¢ËøéÊù•Âà∞Êàë‰ª¨ÁöÑÂ∞èÈïáÔºÅËøôÈáåÁöÑË¥∏ÊòìÂæàÁπÅËç£„ÄÇÂ¶ÇÊûú‰Ω†ÈúÄË¶ÅÂ•ΩË£ÖÂ§áÔºåËÆ∞ÂæóÂéªÂïÜÂ∫óÁúãÁúãÔºÅÊÑèÂõæÊ≥ïÂ∏à‰ª¨ÊÄªÊòØÂæàÂøôÁ¢åÔºå‰ΩÜËÆ∞ÂæóË¶ÅÂ•ΩÂ•Ω‰ºëÊÅØÂì¶„ÄÇ"
                        </div>
                    </div>
                    
                    <div class="shop-items" id="shop-items">
                        <!-- ÂïÜÂ∫óÁâ©ÂìÅÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">ËøîÂõûÊùëÂ∫Ñ</button>
                </div>

                <!-- ÊóÖÂ∫óÊ®°Âºè -->
                <div id="inn-mode" class="inn-container">
                    <h2>üè® ÊÑèÂõæÊóÖÂ∫ó</h2>
                    
                    <div class="npc-dialogue">
                        <div class="npc-name">ÂÆ¢Ê†àËÄÅÊùøÂ®òÁéõ‰∏Ω</div>
                        <div class="dialogue-text" id="inn-dialogue">
                            "Ê¨¢ËøéÊù•Âà∞ÊÑèÂõæÊóÖÂ∫óÔºÅÁ¥Ø‰∫ÜÂêóÔºüÂú®ËøôÈáå‰ºëÊÅØ‰∏Ä‰∏ãÔºåÂè™ÈúÄË¶Å20ÈáëÂ∏ÅÂ∞±ËÉΩÂÆåÂÖ®ÊÅ¢Â§ç‰Ω†ÁöÑÁîüÂëΩÂÄºÂíåÈ≠îÊ≥ïÂÄº„ÄÇÊàë‰ª¨ÁöÑÂ∫äÈì∫ÊòØÂÖ®ÊùëÊúÄËàíÊúçÁöÑÔºÅ"
                        </div>
                    </div>
                    
                    <div class="inn-service">
                        <h3>üí§ ‰ºëÊÅØÊúçÂä°</h3>
                        <p>Ë¥πÁî®: 20 ÈáëÂ∏Å</p>
                        <p>ÊïàÊûú: ÂÆåÂÖ®ÊÅ¢Â§çÁîüÂëΩÂÄºÂíåÈ≠îÊ≥ïÂÄº</p>
                        <button class="rest-btn" id="rest-btn" onclick="restAtInn()">üí§ ‰ºëÊÅØ (20ÈáëÂ∏Å)</button>
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">Á¶ªÂºÄÊóÖÂ∫ó</button>
                </div>

                <!-- ËÉåÂåÖÊ®°Âºè -->
                <div id="inventory-mode" class="inventory-container">
                    <h2>üéí Áâ©ÂìÅËÉåÂåÖ</h2>
                    
                    <div class="inventory-items" id="inventory-items">
                        <!-- ËÉåÂåÖÁâ©ÂìÅÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">ÂÖ≥Èó≠ËÉåÂåÖ</button>
                </div>

                <!-- Âú∞ÂõæÊ®°Âºè -->
                <div id="map-mode" class="map-container">
                    <h2>üó∫Ô∏è ÊÑèÂõæ‰∏ñÁïåÂú∞Âõæ</h2>
                    <p>‰ΩøÁî®ÊñπÂêëÈîÆÊàñÁÇπÂáªÁßªÂä®„ÄÇüßô‚Äç‚ôÇÔ∏è Ë°®Á§∫‰Ω†ÁöÑ‰ΩçÁΩÆ„ÄÇ</p>
                    
                    <div class="map-grid" id="map-grid">
                        <!-- Âú∞ÂõæÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="choice-btn" onclick="movePlayer(-1, 0)" style="width: 60px;">‚¨ÖÔ∏è</button>
                        <button class="choice-btn" onclick="movePlayer(1, 0)" style="width: 60px;">‚û°Ô∏è</button>
                        <button class="choice-btn" onclick="movePlayer(0, -1)" style="width: 60px;">‚¨ÜÔ∏è</button>
                        <button class="choice-btn" onclick="movePlayer(0, 1)" style="width: 60px;">‚¨áÔ∏è</button>
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">ÂÖ≥Èó≠Âú∞Âõæ</button>
                </div>

                <!-- Ê∏∏ÊàèÊó•Âøó -->
                <div class="game-log">
                    <h4>üìú Ê∏∏ÊàèÊó•Âøó</h4>
                    <div id="game-log">
                        <div class="log-entry">Ê∏∏ÊàèÂºÄÂßãÔºÅÊ¨¢ËøéÊù•Âà∞Anoma‰∏ñÁïåÔºÅ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            player: {
                x: 0,
                y: 0,
                level: 1,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                exp: 0,
                nextLevelExp: 100,
                gold: 100,
                inventory: [
                    { name: 'ÂàùÁ∫ßÊ≤ªÁñóËçØÊ∞¥', type: 'potion', effect: 30, price: 20 },
                ],
                companions: [],
            },
            mapData: [
                { x: 2, y: 2, type: 'town', name: 'Â∏åÊúõÈïá', icon: 'üèòÔ∏è' },
                { x: 7, y: 5, type: 'cave', name: 'ÂõûÈü≥Ê¥ûÁ©¥', icon: 'üèûÔ∏è' },
                { x: 4, y: 8, type: 'mountain', name: 'Ëø∑ÈõæÂ±±ËÑâ', icon: '‚õ∞Ô∏è' },
                { x: 1, y: 6, type: 'town', name: 'ÂïÜ‰∏öÈïá', icon: 'üè™' },
                { x: 8, y: 2, type: 'cave', name: 'Ê∞¥Êô∂Ê¥ûÁ©¥', icon: 'üíé' },
                { x: 6, y: 9, type: 'mountain', name: 'Èõ™Â≥∞Â±±', icon: 'üèîÔ∏è' },
            ],
            shopItems: [
                { name: 'ÂàùÁ∫ßÊ≤ªÁñóËçØÊ∞¥', description: 'ÊÅ¢Â§ç30ÁÇπÁîüÂëΩÂÄº', price: 20, type: 'potion', effect: 30 },
                { name: 'ÂàùÁ∫ßÈ≠îÊ≥ïËçØÊ∞¥', description: 'ÊÅ¢Â§ç20ÁÇπÈ≠îÊ≥ïÂÄº', price: 25, type: 'potion', effect: 20 },
                { name: 'ÊÑèÂõæÁ¢éÁâá', description: 'Áî®‰∫éÂçáÁ∫ßË£ÖÂ§áÁöÑÁ•ûÁßòÁ¢éÁâá', price: 100, type: 'material' },
                { name: 'ÈìÅÂâë', description: 'ÊîªÂáªÂäõ+15ÁöÑÊ≠¶Âô®', price: 150, type: 'weapon' },
                { name: 'ÁöÆÁî≤', description: 'Èò≤Âæ°Âäõ+10ÁöÑÊä§Áî≤', price: 120, type: 'armor' },
            ],
            currentMode: 'story',
        };

        // Êõ¥Êñ∞Áé©ÂÆ∂Áä∂ÊÄÅÊòæÁ§∫
        function updatePlayerStats() {
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-gold').textContent = gameState.player.gold;
            document.getElementById('hp-text').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('mp-text').textContent = `${gameState.player.mp}/${gameState.player.maxMp}`;
            document.getElementById('exp-text').textContent = `${gameState.player.exp}/${gameState.player.nextLevelExp}`;
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            document.getElementById('hp-bar').style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            document.getElementById('mp-bar').style.width = `${(gameState.player.mp / gameState.player.maxMp) * 100}%`;
            document.getElementById('exp-bar').style.width = `${(gameState.player.exp / gameState.player.nextLevelExp) * 100}%`;
        }

        // ËÆ∞ÂΩïÊ∏∏ÊàèÊó•Âøó
        function logMessage(message) {
            const logDiv = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ÊòæÁ§∫‰∏çÂêåÊ®°Âºè
        function showStoryMode() {
            document.getElementById('story-mode').style.display = 'block';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'none';
            gameState.currentMode = 'story';
        }

        function showShopMode() {
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'block';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'none';
            gameState.currentMode = 'shop';
            renderShop();
        }

        function showInnMode() {
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'block';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'none';
            gameState.currentMode = 'inn';
            updateRestButton();
        }

        function showInventoryMode() {
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'block';
            document.getElementById('map-mode').style.display = 'none';
            gameState.currentMode = 'inventory';
            renderInventory();
        }

        function showMapMode() {
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'block';
            gameState.currentMode = 'map';
            renderMap();
        }

        // Ê∏≤ÊüìÂú∞Âõæ
        function renderMap() {
            const mapContainer = document.getElementById('map-grid');
            mapContainer.innerHTML = '';

            for (let y = 0; y < 10; y++) {
                for (let x = 0; x < 10; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÁé©ÂÆ∂‰ΩçÁΩÆ
                    if (x === gameState.player.x && y === gameState.player.y) {
                        cell.classList.add('player');
                        cell.textContent = 'üßô‚Äç‚ôÇÔ∏è';
                    } else {
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁâπÊÆäÂú∞ÁÇπ
                        const location = gameState.mapData.find(loc => loc.x === x && loc.y === y);
                        if (location) {
                            cell.classList.add(location.type);
                            cell.textContent = location.icon;
                            cell.title = location.name;
                        } else {
                            // ÈöèÊú∫Âú∞ÂΩ¢
                            const terrain = Math.random();
                            if (terrain < 0.3) {
                                cell.classList.add('forest');
                                cell.textContent = 'üå≤';
                            } else {
                                cell.textContent = 'üü´';
                            }
                        }
                    }
                    
                    mapContainer.appendChild(cell);
                }
            }
        }

        // ÁßªÂä®Áé©ÂÆ∂
        function movePlayer(dx, dy) {
            const newX = gameState.player.x + dx;
            const newY = gameState.player.y + dy;

            // Ê£ÄÊü•ËæπÁïå
            if (newX >= 0 && newX < 10 && newY >= 0 && newY < 10) {
                gameState.player.x = newX;
                gameState.player.y = newY;

                // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÁâπÊÆäÂú∞ÁÇπ
                const location = gameState.mapData.find(loc => loc.x === gameState.player.x && loc.y === gameState.player.y);
                if (location) {
                    if (location.type === 'town') {
                        logMessage(`‰Ω†ËøõÂÖ•‰∫Ü${location.name}ÔºÅ`);
                        document.getElementById('story-text').innerText = `Ê¨¢ËøéÊù•Âà∞${location.name}ÔºÅËøôÈáåÊòØ‰∏Ä‰∏™ÁπÅËç£ÁöÑÂïÜ‰∏ö‰∏≠ÂøÉÔºå‰Ω†ÂèØ‰ª•Âú®ËøôÈáåÊâæÂà∞ÂïÜÂ∫óÂíåÊóÖÂ∫ó„ÄÇ`;
                        document.getElementById('story-choices').innerHTML = `
                            <button class="choice-btn" onclick="openShop()">üè™ ÈÄõÈÄõÂïÜÂ∫ó</button>
                            <button class="choice-btn" onclick="openInn()">üè® Âú®ÊóÖÂ∫ó‰ºëÊÅØ</button>
                            <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ËøîÂõûÂú∞Âõæ</button>
                        `;
                        showStoryMode();
                    } else if (location.type === 'cave') {
                        logMessage(`‰Ω†ÂèëÁé∞‰∫Ü${location.name}ÔºÅ`);
                        document.getElementById('story-text').innerText = `‰Ω†Ëµ∞Ëøõ${location.name}ÔºåËøôÈáåÈò¥ÊöóÊΩÆÊπøÔºå‰ºº‰πéÈöêËóèÁùÄ‰ªÄ‰πàÁßòÂØÜ„ÄÇ‰Ω†ÂèØ‰ª•ÈÄâÊã©Ê∑±ÂÖ•Êé¢Á¥¢ÊàñËÄÖÁ¶ªÂºÄ„ÄÇ`;
                        document.getElementById('story-choices').innerHTML = `
                            <button class="choice-btn" onclick="exploreCave()">üî¶ Ê∑±ÂÖ•Êé¢Á¥¢Ê¥ûÁ©¥</button>
                            <button class="choice-btn" onclick="openMap()">üó∫Ô∏è Á¶ªÂºÄÊ¥ûÁ©¥</button>
                        `;
                        showStoryMode();
                    } else if (location.type === 'mountain') {
                        logMessage(`‰Ω†Êù•Âà∞‰∫Ü${location.name}„ÄÇ`);
                        document.getElementById('story-text').innerText = `‰Ω†Á´ôÂú®${location.name}ÁöÑËÑö‰∏ãÔºåÂ±±Ë∑ØÂ¥éÂ≤ñÔºåÂÖÖÊª°ÊåëÊàò„ÄÇËøôÈáåÁöÑÁ©∫Ê∞îÁ®ÄËñÑÔºå‰ΩÜÊôØËâ≤Â£ÆËßÇ„ÄÇ`;
                        document.getElementById('story-choices').innerHTML = `
                            <button class="choice-btn" onclick="climbMountain()">‚õ∞Ô∏è Â∞ùËØïÊîÄÁôª</button>
                            <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ËøîÂõûÂú∞Âõæ</button>
                        `;
                        showStoryMode();
                    }
                } else {
                    logMessage(`‰Ω†ÁßªÂä®Âà∞‰∫Ü (${gameState.player.x}, ${gameState.player.y})`);
                    
                    // ÈöèÊú∫ÈÅáÊïåÊ£ÄÊü•ÔºàÂú®ÊôÆÈÄöÂú∞ÂΩ¢ÁßªÂä®Êó∂Ôºâ
                    const encounterChance = Math.random();
                    if (encounterChance < 0.3) { // 30% Ê¶ÇÁéáÈÅáÊïå
                        triggerRandomEncounter();
                        return; // ÈÅáÊïåÂêé‰∏çÁªßÁª≠Ê∏≤ÊüìÂú∞ÂõæÔºåÁ≠âÂæÖÊàòÊñóÁªìÊùü
                    }
                }

                renderMap();
            }
        }

        // Êé¢Á¥¢Ê¥ûÁ©¥
        function exploreCave() {
            const random = Math.random();
            if (random < 0.4) {
                // ÂèëÁé∞ÂÆùËóè
                const goldFound = Math.floor(Math.random() * 50) + 20;
                gameState.player.gold += goldFound;
                logMessage(`‰Ω†Âú®Ê¥ûÁ©¥‰∏≠ÂèëÁé∞‰∫Ü${goldFound}ÈáëÂ∏ÅÔºÅ`);
                document.getElementById('story-text').innerText = `Âú®Ê¥ûÁ©¥Ê∑±Â§ÑÔºå‰Ω†ÂèëÁé∞‰∫Ü‰∏Ä‰∏™Âè§ËÄÅÁöÑÂÆùÁÆ±ÔºåÈáåÈù¢Êúâ${goldFound}ÈáëÂ∏ÅÔºÅ`;
            } else if (random < 0.7) {
                // ÈÅáÂà∞ÊÄ™Áâ©
                const damage = Math.floor(Math.random() * 20) + 10;
                gameState.player.hp = Math.max(0, gameState.player.hp - damage);
                logMessage(`‰Ω†ÈÅáÂà∞‰∫ÜÊ¥ûÁ©¥ÊÄ™Áâ©ÔºåÂèóÂà∞‰∫Ü${damage}ÁÇπ‰º§ÂÆ≥ÔºÅ`);
                document.getElementById('story-text').innerText = `‰∏ÄÂè™Ê¥ûÁ©¥ËùôËù†Á™ÅÁÑ∂Ë¢≠Âáª‰∫Ü‰Ω†ÔºÅ‰Ω†ÂèóÂà∞‰∫Ü${damage}ÁÇπ‰º§ÂÆ≥„ÄÇ`;
            } else {
                // ÂèëÁé∞‰ºô‰º¥
                if (gameState.player.companions.length === 0) {
                    gameState.player.companions.push({
                        name: 'ËôæËôæ',
                        hp: 60,
                        maxHp: 60,
                        image: './monster7.png'
                    });
                    document.getElementById('companion-section').style.display = 'block';
                    logMessage('‰Ω†ÂèëÁé∞‰∫Ü‰∏ÄÂè™ÂèãÂñÑÁöÑËôæËôæÔºåÂÆÉÂÜ≥ÂÆöË∑üÈöè‰Ω†ÂÜíÈô©ÔºÅ');
                    document.getElementById('story-text').innerText = 'Âú®Ê¥ûÁ©¥ÁöÑËßíËêΩÔºå‰Ω†ÂèëÁé∞‰∫Ü‰∏ÄÂè™Âèó‰º§ÁöÑËôæËôæ„ÄÇÁªèËøá‰Ω†ÁöÑÊ≤ªÁñóÔºåÂÆÉÂÜ≥ÂÆöË∑üÈöè‰Ω†‰∏ÄËµ∑ÂÜíÈô©ÔºÅ';
                } else {
                    logMessage('‰Ω†Âú®Ê¥ûÁ©¥‰∏≠Ê≤°ÊúâÂèëÁé∞‰ªÄ‰πàÁâπÂà´ÁöÑ‰∏úË•ø„ÄÇ');
                    document.getElementById('story-text').innerText = '‰Ω†‰ªîÁªÜÊêúÁ¥¢‰∫ÜÊ¥ûÁ©¥Ôºå‰ΩÜÊ≤°ÊúâÂèëÁé∞‰ªÄ‰πàÁâπÂà´ÁöÑ‰∏úË•ø„ÄÇ';
                }
            }
            
            document.getElementById('story-choices').innerHTML = `<button class="choice-btn" onclick="openMap()">üó∫Ô∏è Á¶ªÂºÄÊ¥ûÁ©¥</button>`;
            updatePlayerStats();
        }

        // ÊîÄÁôªÂ±±Â≥∞
        function climbMountain() {
            const random = Math.random();
            if (random < 0.5) {
                // ÊàêÂäüÊîÄÁôªÔºåËé∑ÂæóÁªèÈ™å
                const expGained = Math.floor(Math.random() * 30) + 20;
                gameState.player.exp += expGained;
                logMessage(`ÊàêÂäüÊîÄÁôªÂ±±Â≥∞ÔºåËé∑Âæó‰∫Ü${expGained}ÁÇπÁªèÈ™åÔºÅ`);
                document.getElementById('story-text').innerText = `ÁªèËøáËâ∞ÈöæÁöÑÊîÄÁôªÔºå‰Ω†ÊàêÂäüÂà∞Ëææ‰∫ÜÂ±±Â≥∞ÔºÅÂ£Æ‰∏ΩÁöÑÊôØËâ≤ËÆ©‰Ω†Ëé∑Âæó‰∫Ü${expGained}ÁÇπÁªèÈ™å„ÄÇ`;
                
                // Ê£ÄÊü•ÂçáÁ∫ß
                if (gameState.player.exp >= gameState.player.nextLevelExp) {
                    levelUp();
                }
            } else {
                // ÊîÄÁôªÂ§±Ë¥•ÔºåÊ∂àËÄó‰ΩìÂäõ
                const hpLost = Math.floor(Math.random() * 15) + 5;
                gameState.player.hp = Math.max(0, gameState.player.hp - hpLost);
                logMessage(`ÊîÄÁôªÂ§±Ë¥•ÔºåÊ∂àËÄó‰∫Ü${hpLost}ÁÇπÁîüÂëΩÂÄº„ÄÇ`);
                document.getElementById('story-text').innerText = `Â±±Ë∑ØÂ§™ËøáÈô©Â≥ªÔºå‰Ω†Âú®ÊîÄÁôªËøáÁ®ã‰∏≠ÊªëÂÄí‰∫ÜÔºåÊ∂àËÄó‰∫Ü${hpLost}ÁÇπÁîüÂëΩÂÄº„ÄÇ`;
            }
            
            document.getElementById('story-choices').innerHTML = `<button class="choice-btn" onclick="openMap()">üó∫Ô∏è ËøîÂõûÂú∞Âõæ</button>`;
            updatePlayerStats();
        }

        // ÂçáÁ∫ß
        function levelUp() {
            gameState.player.level++;
            gameState.player.exp = 0;
            gameState.player.nextLevelExp += 50;
            gameState.player.maxHp += 20;
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.maxMp += 10;
            gameState.player.mp = gameState.player.maxMp;
            
            logMessage(`ÊÅ≠ÂñúÂçáÁ∫ßÔºÅÁé∞Âú®ÊòØ${gameState.player.level}Á∫ßÔºÅ`);
        }

        // ÈöèÊú∫ÈÅáÊïå
        function triggerRandomEncounter() {
            const monsters = [
                { name: 'Ê£ÆÊûóÂè≤Ëé±ÂßÜ', hp: 30, attack: 8, exp: 15, gold: 10, image: './monster1.png' },
                { name: 'ÈáéÁîüËòëËèá', hp: 25, attack: 6, exp: 12, gold: 8, image: './monster2.png' },
                { name: 'Ëø∑Ë∑ØÂ∞èÁ≤æÁÅµ', hp: 20, attack: 10, exp: 18, gold: 12, image: './monster3.png' },
                { name: 'Â≤©Áü≥Ëüπ', hp: 40, attack: 12, exp: 20, gold: 15, image: './monster4.png' },
                { name: 'È£é‰πãÁãº', hp: 35, attack: 15, exp: 25, gold: 18, image: './monster6.png' }
            ];
            
            const randomMonster = monsters[Math.floor(Math.random() * monsters.length)];
            
            logMessage(`ÈÅ≠ÈÅá‰∫Ü${randomMonster.name}ÔºÅ`);
            
            document.getElementById('story-text').innerText = `Âú®Êé¢Á¥¢ËøáÁ®ã‰∏≠Ôºå‰Ω†ÈÅ≠ÈÅá‰∫Ü‰∏ÄÂè™${randomMonster.name}ÔºÅÂÆÉÁúãËµ∑Êù•ÂæàÊúâÊïåÊÑèÔºåÂáÜÂ§áÊàòÊñóÔºÅ`;
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="startBattle('${JSON.stringify(randomMonster).replace(/"/g, '&quot;')}')">‚öîÔ∏è ÂºÄÂßãÊàòÊñó</button>
                <button class="choice-btn" onclick="attemptFlee()">üèÉ‚Äç‚ôÇÔ∏è Â∞ùËØïÈÄÉË∑ë</button>
            `;
            showStoryMode();
        }

        // ÂºÄÂßãÊàòÊñó
        function startBattle(monsterData) {
            const monster = JSON.parse(monsterData.replace(/&quot;/g, '"'));
            gameState.currentBattle = {
                monster: monster,
                playerTurn: true
            };
            
            battleTurn(monster);
        }

        // ÊàòÊñóÂõûÂêà
        function battleTurn(monster) {
            if (gameState.player.hp <= 0) {
                // Áé©ÂÆ∂Ê≠ª‰∫°
                document.getElementById('story-text').innerText = '‰Ω†Ë¢´ÂáªË¥•‰∫ÜÔºÅ‰Ω†Â§±Âéª‰∫Ü‰∏Ä‰∫õÈáëÂ∏ÅÔºå‰ΩÜ‰øù‰Ωè‰∫ÜÊÄßÂëΩ„ÄÇ';
                gameState.player.hp = Math.floor(gameState.player.maxHp * 0.3);
                gameState.player.gold = Math.max(0, gameState.player.gold - 20);
                document.getElementById('story-choices').innerHTML = `
                    <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ËøîÂõûÂú∞Âõæ</button>
                `;
                updatePlayerStats();
                return;
            }
            
            if (monster.hp <= 0) {
                // ÊÄ™Áâ©Ê≠ª‰∫°ÔºåÁé©ÂÆ∂ËÉúÂà©
                gameState.player.exp += monster.exp;
                gameState.player.gold += monster.gold;
                
                logMessage(`ÂáªË¥•‰∫Ü${monster.name}ÔºÅËé∑Âæó${monster.exp}ÁªèÈ™åÂíå${monster.gold}ÈáëÂ∏ÅÔºÅ`);
                document.getElementById('story-text').innerText = `‰Ω†ÊàêÂäüÂáªË¥•‰∫Ü${monster.name}ÔºÅËé∑Âæó‰∫Ü${monster.exp}ÁÇπÁªèÈ™åÂíå${monster.gold}ÈáëÂ∏Å„ÄÇ`;
                
                // Ê£ÄÊü•ÂçáÁ∫ß
                if (gameState.player.exp >= gameState.player.nextLevelExp) {
                    levelUp();
                }
                
                document.getElementById('story-choices').innerHTML = `
                    <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ÁªßÁª≠Êé¢Á¥¢</button>
                `;
                updatePlayerStats();
                return;
            }
            
            // ÁªßÁª≠ÊàòÊñó
            if (gameState.currentBattle.playerTurn) {
                // Áé©ÂÆ∂ÂõûÂêà
                document.getElementById('story-text').innerText = `${monster.name} (ÁîüÂëΩÂÄº: ${monster.hp}) Ê≠£Âú®‰∏é‰Ω†ÊàòÊñóÔºÅÈÄâÊã©‰Ω†ÁöÑË°åÂä®Ôºö`;
                document.getElementById('story-choices').innerHTML = `
                    <button class="choice-btn" onclick="playerAttack()">‚öîÔ∏è ÊîªÂáª</button>
                    <button class="choice-btn" onclick="useHealingPotion()">üß™ ‰ΩøÁî®Ê≤ªÁñóËçØÊ∞¥</button>
                    <button class="choice-btn" onclick="attemptFlee()">üèÉ‚Äç‚ôÇÔ∏è Â∞ùËØïÈÄÉË∑ë</button>
                `;
            } else {
                // ÊÄ™Áâ©ÂõûÂêà
                const damage = Math.floor(Math.random() * monster.attack) + 5;
                gameState.player.hp = Math.max(0, gameState.player.hp - damage);
                
                logMessage(`${monster.name}ÊîªÂáª‰∫Ü‰Ω†ÔºåÈÄ†Êàê${damage}ÁÇπ‰º§ÂÆ≥ÔºÅ`);
                document.getElementById('story-text').innerText = `${monster.name}Âêë‰Ω†ÂèëËµ∑ÊîªÂáªÔºåÈÄ†Êàê‰∫Ü${damage}ÁÇπ‰º§ÂÆ≥ÔºÅ`;
                
                gameState.currentBattle.playerTurn = true;
                updatePlayerStats();
                
                setTimeout(() => {
                    battleTurn(monster);
                }, 1500);
            }
        }

        // Áé©ÂÆ∂ÊîªÂáª
        function playerAttack() {
            const monster = gameState.currentBattle.monster;
            const damage = Math.floor(Math.random() * 20) + 10 + gameState.player.level * 2;
            monster.hp = Math.max(0, monster.hp - damage);
            
            logMessage(`‰Ω†ÊîªÂáª‰∫Ü${monster.name}ÔºåÈÄ†Êàê${damage}ÁÇπ‰º§ÂÆ≥ÔºÅ`);
            document.getElementById('story-text').innerText = `‰Ω†Âêë${monster.name}ÂèëËµ∑ÊîªÂáªÔºåÈÄ†Êàê‰∫Ü${damage}ÁÇπ‰º§ÂÆ≥ÔºÅ`;
            
            gameState.currentBattle.playerTurn = false;
            
            setTimeout(() => {
                battleTurn(monster);
            }, 1500);
        }

        // ‰ΩøÁî®Ê≤ªÁñóËçØÊ∞¥
        function useHealingPotion() {
            const potionIndex = gameState.player.inventory.findIndex(item => 
                item.type === 'potion' && item.name.includes('Ê≤ªÁñó')
            );
            
            if (potionIndex !== -1) {
                const potion = gameState.player.inventory[potionIndex];
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + potion.effect);
                gameState.player.inventory.splice(potionIndex, 1);
                
                logMessage(`‰ΩøÁî®‰∫Ü${potion.name}ÔºåÊÅ¢Â§ç‰∫Ü${potion.effect}ÁÇπÁîüÂëΩÂÄºÔºÅ`);
                document.getElementById('story-text').innerText = `‰Ω†‰ΩøÁî®‰∫Ü${potion.name}ÔºåÊÅ¢Â§ç‰∫Ü${potion.effect}ÁÇπÁîüÂëΩÂÄºÔºÅ`;
                
                gameState.currentBattle.playerTurn = false;
                updatePlayerStats();
                
                setTimeout(() => {
                    battleTurn(gameState.currentBattle.monster);
                }, 1500);
            } else {
                logMessage('‰Ω†Ê≤°ÊúâÊ≤ªÁñóËçØÊ∞¥ÔºÅ');
                document.getElementById('story-text').innerText = '‰Ω†Ê≤°ÊúâÊ≤ªÁñóËçØÊ∞¥ÂèØ‰ª•‰ΩøÁî®ÔºÅ';
                
                setTimeout(() => {
                    battleTurn(gameState.currentBattle.monster);
                }, 1000);
            }
        }

        // Â∞ùËØïÈÄÉË∑ë
        function attemptFlee() {
            const fleeChance = Math.random();
            if (fleeChance < 0.7) { // 70% ÊàêÂäüÁéá
                logMessage('ÊàêÂäüÈÄÉË∑ë‰∫ÜÔºÅ');
                document.getElementById('story-text').innerText = '‰Ω†ÊàêÂäüÈÄÉÁ¶ª‰∫ÜÊàòÊñóÔºÅ';
                document.getElementById('story-choices').innerHTML = `
                    <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ËøîÂõûÂú∞Âõæ</button>
                `;
            } else {
                logMessage('ÈÄÉË∑ëÂ§±Ë¥•ÔºÅ');
                document.getElementById('story-text').innerText = 'ÈÄÉË∑ëÂ§±Ë¥•ÔºÅÊÄ™Áâ©ÈòªÊ≠¢‰∫Ü‰Ω†ÁöÑÈÄÉË∑ëÔºÅ';
                
                gameState.currentBattle.playerTurn = false;
                
                setTimeout(() => {
                    battleTurn(gameState.currentBattle.monster);
                }, 1500);
            }
        }

        // Ê∏≤ÊüìÂïÜÂ∫ó
        function renderShop() {
            const shopContainer = document.getElementById('shop-items');
            shopContainer.innerHTML = '';

            gameState.shopItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                
                const canAfford = gameState.player.gold >= item.price;
                
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                        <div class="item-price">‰ª∑Ê†º: ${item.price} ÈáëÂ∏Å</div>
                    </div>
                    <button class="buy-btn" onclick="buyItem(${index})" ${!canAfford ? 'disabled' : ''}>
                        ${canAfford ? 'Ë¥≠‰π∞' : 'ÈáëÂ∏Å‰∏çË∂≥'}
                    </button>
                `;
                
                shopContainer.appendChild(itemDiv);
            });
        }

        // Ë¥≠‰π∞Áâ©ÂìÅ
        function buyItem(index) {
            const item = gameState.shopItems[index];
            if (gameState.player.gold >= item.price) {
                gameState.player.gold -= item.price;
                gameState.player.inventory.push({...item});
                logMessage(`Ë¥≠‰π∞‰∫Ü${item.name}ÔºÅ`);
                updatePlayerStats();
                renderShop();
            }
        }

        // Ê∏≤ÊüìËÉåÂåÖ
        function renderInventory() {
            const inventoryContainer = document.getElementById('inventory-items');
            inventoryContainer.innerHTML = '';

            if (gameState.player.inventory.length === 0) {
                inventoryContainer.innerHTML = '<p>ËÉåÂåÖÊòØÁ©∫ÁöÑ</p>';
                return;
            }

            gameState.player.inventory.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                
                let actionButton = '';
                if (item.type === 'potion') {
                    actionButton = `<button class="use-btn" onclick="useItem(${index})">‰ΩøÁî®</button>`;
                } else {
                    actionButton = `<button class="sell-btn" onclick="sellItem(${index})">Âá∫ÂîÆ (${Math.floor(item.price * 0.7)}ÈáëÂ∏Å)</button>`;
                }
                
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                    </div>
                    ${actionButton}
                `;
                
                inventoryContainer.appendChild(itemDiv);
            });
        }

        // ‰ΩøÁî®Áâ©ÂìÅ
        function useItem(index) {
            const item = gameState.player.inventory[index];
            if (item.type === 'potion') {
                if (item.name.includes('Ê≤ªÁñó')) {
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + item.effect);
                    logMessage(`‰ΩøÁî®‰∫Ü${item.name}ÔºåÊÅ¢Â§ç‰∫Ü${item.effect}ÁÇπÁîüÂëΩÂÄºÔºÅ`);
                } else if (item.name.includes('È≠îÊ≥ï')) {
                    gameState.player.mp = Math.min(gameState.player.maxMp, gameState.player.mp + item.effect);
                    logMessage(`‰ΩøÁî®‰∫Ü${item.name}ÔºåÊÅ¢Â§ç‰∫Ü${item.effect}ÁÇπÈ≠îÊ≥ïÂÄºÔºÅ`);
                }
                
                gameState.player.inventory.splice(index, 1);
                updatePlayerStats();
                renderInventory();
            }
        }

        // Âá∫ÂîÆÁâ©ÂìÅ
        function sellItem(index) {
            const item = gameState.player.inventory[index];
            const sellPrice = Math.floor(item.price * 0.7);
            gameState.player.gold += sellPrice;
            gameState.player.inventory.splice(index, 1);
            logMessage(`Âá∫ÂîÆ‰∫Ü${item.name}ÔºåËé∑Âæó${sellPrice}ÈáëÂ∏ÅÔºÅ`);
            updatePlayerStats();
            renderInventory();
        }

        // Êõ¥Êñ∞‰ºëÊÅØÊåâÈíÆÁä∂ÊÄÅ
        function updateRestButton() {
            const restBtn = document.getElementById('rest-btn');
            const canRest = gameState.player.gold >= 20 && (gameState.player.hp < gameState.player.maxHp || gameState.player.mp < gameState.player.maxMp);
            
            if (!canRest) {
                restBtn.disabled = true;
                if (gameState.player.gold < 20) {
                    restBtn.textContent = 'üí§ ÈáëÂ∏Å‰∏çË∂≥';
                } else {
                    restBtn.textContent = 'üí§ Áä∂ÊÄÅÊª°ÂÄº';
                }
            } else {
                restBtn.disabled = false;
                restBtn.textContent = 'üí§ ‰ºëÊÅØ (20ÈáëÂ∏Å)';
            }
        }

        // Âú®ÊóÖÂ∫ó‰ºëÊÅØ
        function restAtInn() {
            if (gameState.player.gold >= 20) {
                gameState.player.gold -= 20;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.mp = gameState.player.maxMp;
                logMessage('Âú®ÊóÖÂ∫ó‰ºëÊÅØÔºåÂÆåÂÖ®ÊÅ¢Â§ç‰∫ÜÁîüÂëΩÂÄºÂíåÈ≠îÊ≥ïÂÄºÔºÅ');
                updatePlayerStats();
                updateRestButton();
            }
        }

        // ÊïÖ‰∫ãÈÄâÊã©ÂáΩÊï∞
        function goToVillageChief() {
            document.getElementById('story-text').innerText = '‰Ω†Êù•Âà∞‰∫ÜÊùëÈïøÂÆ∂„ÄÇÊùëÈïøÊòØ‰∏Ä‰ΩçÊÖàÁ••ÁöÑËÄÅ‰∫∫Ôºå‰ªñÊ≠£Âú®‰∏∫ÊùëÂ∫ÑÁöÑÂÆâÂÖ®ÊãÖÂøß„ÄÇ';
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="acceptQuest()">üéØ Êé•ÂèóÊ∏ÖÁêÜÊ£ÆÊûóÊÄ™Áâ©ÁöÑ‰ªªÂä°</button>
                <button class="choice-btn" onclick="openInn()">üè® ËØ¢ÈóÆÊóÖÂ∫ó‰ø°ÊÅØ</button>
                <button class="choice-btn" onclick="backToStory()">üîô ËøîÂõûÊùëÂ∫Ñ‰∏≠ÂøÉ</button>
            `;
        }

        function acceptQuest() {
            const expGained = 50;
            const goldGained = 30;
            gameState.player.exp += expGained;
            gameState.player.gold += goldGained;
            
            document.getElementById('story-text').innerText = `ÊùëÈïøÊÑüÊøÄÂú∞ËØ¥Ôºö"Ë∞¢Ë∞¢‰Ω†ÊÑøÊÑèÂ∏ÆÂä©Êàë‰ª¨ÔºÅËøôÈáåÊúâ‰∏Ä‰∫õÊä•ÈÖ¨„ÄÇ"‰Ω†Ëé∑Âæó‰∫Ü${expGained}ÁÇπÁªèÈ™åÂíå${goldGained}ÈáëÂ∏ÅÔºÅ`;
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="backToStory()">üîô ËøîÂõûÊùëÂ∫Ñ‰∏≠ÂøÉ</button>
            `;
            
            logMessage(`ÂÆåÊàê‰ªªÂä°ÔºåËé∑Âæó${expGained}ÁªèÈ™åÂíå${goldGained}ÈáëÂ∏ÅÔºÅ`);
            updatePlayerStats();
            
            if (gameState.player.exp >= gameState.player.nextLevelExp) {
                levelUp();
            }
        }

        function exploreForest() {
            const random = Math.random();
            if (random < 0.5) {
                const expGained = Math.floor(Math.random() * 20) + 10;
                gameState.player.exp += expGained;
                document.getElementById('story-text').innerText = `‰Ω†Âú®Ê£ÆÊûó‰∏≠ÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÂ∞èÊÄ™Áâ©ÔºåÁªèËøáÊàòÊñóËé∑Âæó‰∫Ü${expGained}ÁÇπÁªèÈ™åÔºÅ`;
                logMessage(`Ê£ÆÊûóÊé¢Á¥¢Ëé∑Âæó${expGained}ÁÇπÁªèÈ™åÔºÅ`);
            } else {
                const goldFound = Math.floor(Math.random() * 30) + 10;
                gameState.player.gold += goldFound;
                document.getElementById('story-text').innerText = `‰Ω†Âú®Ê£ÆÊûó‰∏≠ÂèëÁé∞‰∫Ü‰∏Ä‰∏™Â∞èÂÆùÁÆ±ÔºåËé∑Âæó‰∫Ü${goldFound}ÈáëÂ∏ÅÔºÅ`;
                logMessage(`ÂèëÁé∞ÂÆùÁÆ±ÔºåËé∑Âæó${goldFound}ÈáëÂ∏ÅÔºÅ`);
            }
            
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="backToStory()">üîô ËøîÂõûÊùëÂ∫Ñ‰∏≠ÂøÉ</button>
            `;
            
            updatePlayerStats();
            
            if (gameState.player.exp >= gameState.player.nextLevelExp) {
                levelUp();
            }
        }

        function openShop() {
            showShopMode();
        }

        function openInn() {
            showInnMode();
        }

        function openInventory() {
            showInventoryMode();
        }

        function openMap() {
            showMapMode();
        }

        function backToStory() {
            document.getElementById('story-text').innerText = `
                Âú®AnomaÁöÑÁ•ûÁßò‰∏ñÁïå‰∏≠Ôºå‰Ω†ÊòØ‰∏ÄÂêçÂàöÂàöËßâÈÜíÊÑèÂõæËÉΩÂäõÁöÑÂπ¥ËΩªÊ≥ïÂ∏à„ÄÇËøô‰∏™‰∏ñÁïåÁî±Êó†Êï∞‰∏™"ÊÑèÂõæ"ÊûÑÊàêÔºåÊØè‰∏™ÊÑèÂõæÈÉΩÊòØÁé∞ÂÆûÁöÑ‰∏Ä‰∏™ÁâáÊÆµÔºåËÄå‰Ω†Êã•ÊúâÊìçÊéßËøô‰∫õÊÑèÂõæÁöÑÂ§©Ëµã„ÄÇ

                ‰Ω†Á´ôÂú®Êñ∞ÊâãÊùëÁöÑ‰∏≠Â§ÆÔºåÂë®Âõ¥ÊòØÁÜüÊÇâÁöÑËåÖËçâÂ±ãÂíåÁü≥ÊùøË∑Ø„ÄÇËøúÂ§ÑÁöÑÂú∞Âπ≥Á∫ø‰∏äÔºåÁ•ûÁßòÁöÑÊÑèÂõæ‰πãÂ°îËã•ÈöêËã•Áé∞ÔºåÈÇ£ÈáåÊçÆËØ¥ÈöêËóèÁùÄAnoma‰∏ñÁïåÁöÑÁªàÊûÅÁßòÂØÜ„ÄÇ

                ‰Ω†ÁöÑÂØºÂ∏àÂëäËØâ‰Ω†ÔºåÂè™ÊúâÈÄöËøá‰∏çÊñ≠ÁöÑÂÜíÈô©ÂíåÊàòÊñóÔºåÊâçËÉΩÊèêÂçá‰Ω†ÁöÑÊÑèÂõæÊìçÊéßËÉΩÂäõÔºåÊúÄÁªàÊàê‰∏∫ÁúüÊ≠£ÁöÑÊÑèÂõæÂ§ßÂ∏à„ÄÇ
            `;
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="goToVillageChief()">üè† ÂâçÂæÄÊùëÈïøÂÆ∂Êé•ÂèóÁ¨¨‰∏Ä‰∏™‰ªªÂä°</button>
                <button class="choice-btn" onclick="exploreForest()">üå≤ Êé¢Á¥¢ÊùëÂ∫ÑÂë®Âõ¥ÁöÑÊ£ÆÊûó</button>
                <button class="choice-btn" onclick="openInventory()">üìä Êü•Áúã‰∏™‰∫∫Áä∂ÊÄÅÂíåË£ÖÂ§á</button>
                <button class="choice-btn" onclick="openShop()">üè™ ÂâçÂæÄÂïÜÂ∫óË¥≠‰π∞Áâ©ÂìÅ</button>
                <button class="choice-btn" onclick="openMap()">üó∫Ô∏è ÊâìÂºÄ‰∏ñÁïåÂú∞Âõæ</button>
            `;
            showStoryMode();
        }

        // ‰øùÂ≠òÊ∏∏Êàè
        function saveGame() {
            localStorage.setItem('anomaRPGSave', JSON.stringify(gameState));
            logMessage('Ê∏∏ÊàèÂ∑≤‰øùÂ≠òÔºÅ');
        }

        // Âä†ËΩΩÊ∏∏Êàè
        function loadGame() {
            const savedGame = localStorage.getItem('anomaRPGSave');
            if (savedGame) {
                gameState = JSON.parse(savedGame);
                updatePlayerStats();
                logMessage('Ê∏∏ÊàèÂ∑≤Âä†ËΩΩÔºÅ');
                
                // ÊòæÁ§∫‰ºô‰º¥‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
                if (gameState.player.companions.length > 0) {
                    document.getElementById('companion-section').style.display = 'block';
                }
            } else {
                logMessage('Ê≤°ÊúâÊâæÂà∞Â≠òÊ°£ÔºÅ');
            }
        }

        // ÈîÆÁõòÊéßÂà∂
        document.addEventListener('keydown', function(event) {
            if (gameState.currentMode === 'map') {
                switch(event.key) {
                    case 'ArrowLeft':
                        movePlayer(-1, 0);
                        break;
                    case 'ArrowRight':
                        movePlayer(1, 0);
                        break;
                    case 'ArrowUp':
                        movePlayer(0, -1);
                        break;
                    case 'ArrowDown':
                        movePlayer(0, 1);
                        break;
                }
            }
        });

        // ÂàùÂßãÂåñÊ∏∏Êàè
        updatePlayerStats();
    </script>
</body>
</html>

