<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anoma RPG - 意图之境</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom right, #2c3e50, #34495e);
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        #game-container {
            width: 95%;
            max-width: 900px;
            text-align: center;
            margin: 20px auto;
            border: 3px solid #3498db;
            position: relative;
            overflow: hidden;
        }

        #game-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #e74c3c, #f39c12, #2ecc71, #3498db);
            z-index: -1;
            filter: blur(15px);
            opacity: 0.6;
        }

        #story-title {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #f1c40f;
            text-shadow: 2px 2px #c0392b;
            border-bottom: 2px solid #f1c40f;
            padding-bottom: 10px;
        }

        #story-text {
            font-size: 1.2em;
            line-height: 1.8;
            margin-bottom: 30px;
            white-space: pre-wrap;
            text-align: left;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3498db;
        }

        #choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .choice-button {
            background-color: #3498db;
            color: white;
            border: 2px solid #2980b9;
            padding: 18px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            text-shadow: 1px 1px #2c3e50;
            box-shadow: 3px 3px #2c3e50;
        }

        .choice-button:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 5px 5px #2c3e50;
        }

        .choice-button:active {
            transform: translateY(0);
            box-shadow: 1px 1px #2c3e50;
        }

        #player-stats {
            background-color: rgba(52, 73, 94, 0.7);
            border-radius: 10px;
            padding: 15px;
            margin-top: 30px;
            text-align: left;
            font-size: 1em;
            border: 1px solid #2ecc71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }

        #player-stats div {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #player-stats span:first-child {
            font-weight: bold;
            color: #2ecc71;
        }

        #game-log {
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin-top: 30px;
            text-align: left;
            font-size: 0.9em;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e74c3c;
            box-shadow: inset 0 0 8px rgba(231, 76, 60, 0.5);
            color: #ecf0f1;
        }

        #game-log div {
            margin-bottom: 5px;
            border-bottom: 1px dashed rgba(236, 240, 241, 0.2);
            padding-bottom: 3px;
        }

        #game-log div:last-child {
            border-bottom: none;
        }

        #battle-section {
            display: none;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 95%;
            max-width: 900px;
            text-align: center;
            margin: 20px auto;
            border: 3px solid #e74c3c;
            position: relative;
            overflow: hidden;
        }

        #enemy-display {
            margin-bottom: 25px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e74c3c;
        }

        #enemy-sprite {
            font-size: 5em;
            margin-bottom: 10px;
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.5));
        }

        #enemy-name {
            font-size: 2em;
            color: #e74c3c;
            text-shadow: 1px 1px #c0392b;
        }

        #enemy-hp-bar-container {
            background-color: #c0392b;
            border-radius: 8px;
            height: 20px;
            width: 90%;
            margin: 15px auto;
            overflow: hidden;
            border: 1px solid #e74c3c;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        #enemy-hp-bar {
            background-color: #2ecc71;
            height: 100%;
            width: 100%;
            transition: width 0.5s ease-in-out;
            border-radius: 8px;
        }

        #battle-choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        #map-container {
            display: none;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 95%;
            max-width: 900px;
            text-align: center;
            margin: 20px auto;
            border: 3px solid #f39c12;
            position: relative;
            overflow: hidden;
        }

        #game-map {
            display: grid;
            border: 2px solid #f39c12;
            margin: 25px auto;
            background-color: #34495e;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .map-tile {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            border: 1px solid rgba(236, 240, 241, 0.1);
            box-sizing: border-box;
            transition: background-color 0.2s ease;
            text-shadow: 1px 1px #2c3e50;
        }

        .map-tile.player {
            background-color: #f1c40f;
            border: 3px solid #e67e22;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.8);
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .map-tile.grass {
            background-color: #27ae60;
        }

        .map-tile.forest {
            background-color: #2ecc71;
        }

        .map-tile.village {
            background-color: #f39c12;
        }

        .map-tile.mountain {
            background-color: #7f8c8d;
            border: 2px solid #e74c3c; /* Obstacle border */
            position: relative;
        }

        .map-tile.mountain::after {
            content: '▲';
            position: absolute;
            color: #bdc3c7;
            font-size: 1.2em;
        }

        .map-tile.water {
            background-color: #3498db;
            border: 2px solid #e74c3c; /* Obstacle border */
            position: relative;
        }

        .map-tile.water::after {
            content: '~';
            position: absolute;
            color: #ecf0f1;
            font-size: 1.5em;
        }

        .map-tile.town {
            background-color: #e67e22;
        }

        .map-tile.dungeon {
            background-color: #9b59b6;
        }

        #map-controls {
            margin-top: 20px;
        }

        #map-controls button {
            background-color: #95a5a6;
            color: white;
            border: 2px solid #7f8c8d;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 8px;
            transition: all 0.3s ease;
            text-shadow: 1px 1px #2c3e50;
            box-shadow: 2px 2px #2c3e50;
        }

        #map-controls button:hover {
            background-color: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 4px 4px #2c3e50;
        }

        #player-image-container {
            margin-top: 25px;
            margin-bottom: 25px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }

        #player-image {
            width: 180px;
            height: 180px;
            object-fit: contain;
            border-radius: 50%;
            border: 4px solid #f1c40f;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.8);
        }

        #companion-image-container {
            margin-top: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #2ecc71;
        }

        .companion-image {
            width: 90px;
            height: 90px;
            object-fit: contain;
            border-radius: 50%;
            border: 3px solid #2ecc71;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.6);
            transition: transform 0.2s ease;
        }

        .companion-image:hover {
            transform: scale(1.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #game-container, #battle-section, #map-container {
                padding: 15px;
                width: 98%;
            }

            #story-title {
                font-size: 2em;
            }

            #story-text {
                font-size: 1em;
            }

            .choice-button {
                padding: 12px 15px;
                font-size: 0.9em;
            }

            .map-tile {
                width: 25px;
                height: 25px;
                font-size: 1em;
            }

            #player-image {
                width: 120px;
                height: 120px;
            }

            .companion-image {
                width: 70px;
                height: 70px;
            }
        }

        @media (max-width: 480px) {
            #story-title {
                font-size: 1.8em;
            }

            #choices {
                grid-template-columns: 1fr;
            }

            .map-tile {
                width: 20px;
                height: 20px;
                font-size: 0.8em;
            }
        }

        /* Existing styles */
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid #ffd700;
        }
        
        .game-title {
            text-align: center;
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .player-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 1px solid #ffd700;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #cccccc;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd700);
            transition: width 0.3s ease;
        }
        
        .story-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #ffd700;
        }
        
        .story-title {
            font-size: 1.5em;
            color: #ffd700;
            margin-bottom: 15px;
        }
        
        .story-text {
            line-height: 1.8;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .character-image {
            text-align: center;
            margin: 20px 0;
        }
        
        .character-image img {
            max-width: 200px;
            border-radius: 10px;
            border: 2px solid #ffd700;
        }
        
        .choices {
            display: grid;
            gap: 15px;
        }
        
        .choice-btn {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            border: 2px solid #ffd700;
            color: #ffffff;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .choice-btn:hover {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        
        .map-container {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .map-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .map-cell {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 1.2em;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .grass { background: #4a7c59; }
        .forest { background: #2d5016; }
        .mountain { background: #8b7355; }
        .water { background: #4682b4; }
        .village { background: #ffd700; }
        .town { background: #87ceeb; }
        .cave { background: #483d8b; }
        .player { background: #ff4500 !important; }
        .undiscovered { background: #333333; }
        
        .map-controls {
            text-align: center;
            margin-top: 20px;
        }
        
        .map-controls button {
            background: #4a5568;
            border: 1px solid #ffd700;
            color: white;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .map-controls button:hover {
            background: #ffd700;
            color: black;
        }
        
        .game-log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ffd700;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid #ffd700;
            padding-left: 10px;
        }
        
        .battle-section {
            display: none;
            background: rgba(139, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff4500;
        }
        
        .enemy-info {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .battle-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .battle-btn {
            background: #8b0000;
            border: 1px solid #ff4500;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        
        .battle-btn:hover {
            background: #ff4500;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">🧙‍♂️ Anoma RPG - 意图之境 🌟</h1>
        
        <!-- 玩家状态 -->
        <div class="player-stats">
            <div class="stat">
                <div class="stat-label">等级</div>
                <div class="stat-value" id="player-level">1</div>
            </div>
            <div class="stat">
                <div class="stat-label">生命值</div>
                <div class="stat-value" id="player-hp">100/100</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="hp-bar" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-label">魔法值</div>
                <div class="stat-value" id="player-mp">50/50</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="mp-bar" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-label">经验值</div>
                <div class="stat-value" id="player-exp">0/100</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="exp-bar" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-label">金币</div>
                <div class="stat-value" id="player-gold">100</div>
            </div>
        </div>
        
        <!-- 故事区域 -->
        <div class="story-section" id="story-section">
            <h2 class="story-title" id="story-title">意图觉醒</h2>
            <div class="story-text" id="story-text">
                在Anoma的神秘世界中，你是一名刚刚觉醒意图能力的年轻法师。这个世界由无数个"意图"构成，每个意图都是现实的一个片段，而你拥有操控这些意图的天赋。
                
                你站在新手村的中央，周围是熟悉的茅草屋和石板路。远处的地平线上，神秘的意图之塔若隐若现，那里据说隐藏着Anoma世界的终极秘密。
                
                你的导师告诉你，只有通过不断的冒险和战斗，才能提升你的意图操控能力，最终成为真正的意图大师。
            </div>
            <div class="character-image">
                <img src="wizard.png" alt="意图法师" style="max-width: 150px; border-radius: 10px; border: 3px solid #ffd700;">
            </div>
        </div>
        
        <!-- 选择区域 -->
        <div class="choices" id="choices">
            <button class="choice-btn" onclick="makeChoice(\'village_chief\')">🏠 前往村长家接受第一个任务</button>
            <button class="choice-btn" onclick="makeChoice(\'forest\')">🌲 探索村庄周围的森林</button>
            <button class="choice-btn" onclick="makeChoice(\'status\')">📊 查看个人状态和装备</button>
            <button class="choice-btn" onclick="makeChoice(\'shop\')">🏪 前往商店购买物品</button>
            <button class="choice-btn" onclick="makeChoice(\'map\')">🗺️ 打开世界地图</button>
        </div>
        
        <!-- 地图区域 -->
        <div class="map-container" id="map-container">
            <h3 style="text-align: center; color: #ffd700; margin-bottom: 20px;">🗺️ 意图世界地图</h3>
            <div class="map-grid" id="map-grid"></div>
            <div class="map-controls">
                <button onclick="movePlayer(-1, 0)">⬅️ 西</button>
                <button onclick="movePlayer(0, -1)">⬆️ 北</button>
                <button onclick="movePlayer(0, 1)">⬇️ 南</button>
                <button onclick="movePlayer(1, 0)">➡️ 东</button>
                <button onclick="closeMap()">❌ 关闭地图</button>
            </div>
            <p style="text-align: center; margin-top: 15px; color: #cccccc;">
                当前位置: (<span id="player-x">10</span>, <span id="player-y">10</span>)<br>
                <small>🔴边框 = 不可通行 | 森林遇敌率35% | 草地遇敌率15%</small>
            </p>
        </div>
        
        <!-- 战斗区域 -->
        <div class="battle-section" id="battle-section">
            <h3 style="text-align: center; color: #ff4500; margin-bottom: 20px;">⚔️ 战斗模式</h3>
            <div class="enemy-info">
                <div style="font-size: 3em; margin-bottom: 10px;" id="enemy-sprite">👹</div>
                <div style="font-size: 1.2em; margin-bottom: 5px;" id="enemy-name">森林哥布林</div>
                <div id="enemy-hp">HP: 60/60</div>
                <div class="progress-bar" style="margin: 10px auto; width: 200px;">
                    <div class="progress-fill" id="enemy-hp-bar" style="width: 100%; background: #ff4500;"></div>
                </div>
            </div>
            <div class="battle-actions">
                <button class="battle-btn" onclick="battleAction(\'attack\')">⚔️ 攻击</button>
                <button class="battle-btn" onclick="battleAction(\'magic\')">✨ 魔法</button>
                <button class="battle-btn" onclick="battleAction(\'defend\')">🛡️ 防御</button>
                <button class="battle-btn" onclick="battleAction(\'escape\')">🏃 逃跑</button>
            </d
        #game-container {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6), 0 0 0 10px rgba(52, 152, 219, 0.2);
            padding: 30px;
            width: 95%;
            max-width: 900px;
            text-align: center;
            margin: 20px auto;
            border: 3px solid #3498db;
            position: relative;
            overflow: hidden;
        }

        #game-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #e74c3c, #f39c12, #2ecc71, #3498db);
            z-index: -1;
            filter: blur(15px);
            opacity: 0.6;
        }

        #story-title {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #f1c40f;
            text-shadow: 2px 2px #c0392b;
            border-bottom: 2px solid #f1c40f;
            padding-bottom: 10px;
        }

        #story-text {
            font-size: 1.2em;
            line-height: 1.8;
            margin-bottom: 30px;
            white-space: pre-wrap;
            text-align: left;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3498db;
        }

        #choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .choice-button {
            background-color: #3498db;
            color: white;
            border: 2px solid #2980b9;
            padding: 18px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            text-shadow: 1px 1px #2c3e50;
            box-shadow: 3px 3px #2c3e50;
        }

        .choice-button:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 5px 5px #2c3e50;
        }

        .choice-button:active {
            transform: translateY(0);
            box-shadow: 1px 1px #2c3e50;
        }

        #player-stats {
            background-color: rgba(52, 73, 94, 0.7);
            border-radius: 10px;
            padding: 15px;
            margin-top: 30px;
            text-align: left;
            font-size: 1em;
            border: 1px solid #2ecc71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }

        #player-stats div {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #player-stats span:first-child {
            font-weight: bold;
            color: #2ecc71;
        }

        #game-log {
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin-top: 30px;
            text-align: left;
            font-size: 0.9em;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e74c3c;
            box-shadow: inset 0 0 8px rgba(231, 76, 60, 0.5);
            color: #ecf0f1;
        }

        #game-log div {
            margin-bottom: 5px;
            border-bottom: 1px dashed rgba(236, 240, 241, 0.2);
            padding-bottom: 3px;
        }

        #game-log div:last-child {
            border-bottom: none;
        }

        #battle-section {
            display: none;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 95%;
            max-width: 900px;
            text-align: center;
            margin: 20px auto;
            border: 3px solid #e74c3c;
            position: relative;
            overflow: hidden;
        }

        #enemy-display {
            margin-bottom: 25px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e74c3c;
        }

        #enemy-sprite {
            font-size: 5em;
            margin-bottom: 10px;
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.5));
        }

        #enemy-name {
            font-size: 2em;
            color: #e74c3c;
            text-shadow: 1px 1px #c0392b;
        }

        #enemy-hp-bar-container {
            background-color: #c0392b;
            border-radius: 8px;
            height: 20px;
            width: 90%;
            margin: 15px auto;
            overflow: hidden;
            border: 1px solid #e74c3c;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        #enemy-hp-bar {
            background-color: #2ecc71;
            height: 100%;
            width: 100%;
            transition: width 0.5s ease-in-out;
            border-radius: 8px;
        }

        #battle-choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        #map-container {
            display: none;
            background-color: rgba(44, 62, 80, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 95%;
            max-width: 900px;
            text-align: center;
            margin: 20px auto;
            border: 3px solid #f39c12;
            position: relative;
            overflow: hidden;
        }

        #game-map {
            display: grid;
            border: 2px solid #f39c12;
            margin: 25px auto;
            background-color: #34495e;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .map-tile {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            border: 1px solid rgba(236, 240, 241, 0.1);
            box-sizing: border-box;
            transition: background-color 0.2s ease;
            text-shadow: 1px 1px #2c3e50;
        }

        .map-tile.player {
            background-color: #f1c40f;
            border: 3px solid #e67e22;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.8);
            animation: pulse 1.5s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .map-tile.grass {
            background-color: #27ae60;
        }

        .map-tile.forest {
            background-color: #2ecc71;
        }

        .map-tile.village {
            background-color: #f39c12;
        }

        .map-tile.mountain {
            background-color: #7f8c8d;
            border: 2px solid #e74c3c; /* Obstacle border */
            position: relative;
        }

        .map-tile.mountain::after {
            content: '▲';
            position: absolute;
            color: #bdc3c7;
            font-size: 1.2em;
        }

        .map-tile.water {
            background-color: #3498db;
            border: 2px solid #e74c3c; /* Obstacle border */
            position: relative;
        }

        .map-tile.water::after {
            content: '~';
            position: absolute;
            color: #ecf0f1;
            font-size: 1.5em;
        }

        .map-tile.town {
            background-color: #e67e22;
        }

        .map-tile.dungeon {
            background-color: #9b59b6;
        }

        #map-controls {
            margin-top: 20px;
        }

        #map-controls button {
            background-color: #95a5a6;
            color: white;
            border: 2px solid #7f8c8d;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 8px;
            transition: all 0.3s ease;
            text-shadow: 1px 1px #2c3e50;
            box-shadow: 2px 2px #2c3e50;
        }

        #map-controls button:hover {
            background-color: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 4px 4px #2c3e50;
        }

        #player-image-container {
            margin-top: 25px;
            margin-bottom: 25px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }

        #player-image {
            width: 180px;
            height: 180px;
            object-fit: contain;
            border-radius: 50%;
            border: 4px solid #f1c40f;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.8);
        }

        #companion-image-container {
            margin-top: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #2ecc71;
        }

        .companion-image {
            width: 90px;
            height: 90px;
            object-fit: contain;
            border-radius: 50%;
            border: 3px solid #2ecc71;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.6);
            transition: transform 0.2s ease;
        }

        .companion-image:hover {
            transform: scale(1.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #game-container, #battle-section, #map-container {
                padding: 15px;
                width: 98%;
            }

            #story-title {
                font-size: 2em;
            }

            #story-text {
                font-size: 1em;
            }

            .choice-button {
                padding: 12px 15px;
                font-size: 0.9em;
            }

            .map-tile {
                width: 25px;
                height: 25px;
                font-size: 1em;
            }

            #player-image {
                width: 120px;
                height: 120px;
            }

            .companion-image {
                width: 70px;
                height: 70px;
            }
        }

        @media (max-width: 480px) {
            #story-title {
                font-size: 1.8em;
            }

            #choices {
                grid-template-columns: 1fr;
            }

            .map-tile {
                width: 20px;
                height: 20px;
                font-size: 0.8em;
            }
        }

    <script>
        // 游戏状态
        let gameState = {
            player: {
                level: 1,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                exp: 0,
                maxExp: 100,
                gold: 100,
                x: 10,
                y: 10,
                inventory: [
                    { id: 'potion', name: '治疗药水', type: 'consumable', effect: { hp: 30 }, price: 50, description: '恢复30点生命值', dropRate: 0.4 },
                    { id: 'super_potion', name: '高级治疗药水', type: 'consumable', effect: { hp: 80 }, price: 150, description: '恢复80点生命值', dropRate: 0.15 },
                    { id: 'attack_amulet', name: '攻击护符', type: 'accessory', attack: 5, price: 200, description: '增加5点攻击力', dropRate: 0.1 },
                    { id: 'defense_ring', name: '防御戒指', type: 'accessory', defense: 3, price: 180, description: '增加3点防御力', dropRate: 0.1 },
                    { id: 'mana_potion', name: '魔法药水', type: 'consumable', effect: { mp: 50 }, price: 70, description: '恢复50点魔法值', dropRate: 0.3 },
                    { id: 'sword', name: '铁剑', type: 'weapon', attack: 10, price: 100, description: '一把普通的铁剑', dropRate: 0.05 },
                    { id: 'shield', name: '木盾', type: 'armor', defense: 5, price: 80, description: '一个普通的木盾', dropRate: 0.05 },
                    { id: 'leather_armor', name: '皮甲', type: 'armor', defense: 8, price: 120, description: '一套轻便的皮甲', dropRate: 0.03 },
                    { id: 'iron_sword', name: '铁剑', type: 'weapon', attack: 15, price: 250, description: '一把锋利的铁剑', dropRate: 0.03 },
                    { id: 'gold_bar', name: '金条', type: 'valuable', price: 500, description: '一块闪闪发光的金条', dropRate: 0.01 }
                ],
                equipment: {
                    weapon: { id: 'starter_staff', name: '新手法杖', attack: 10 },
                    armor: { id: 'cloth_robe', name: '布制长袍', defense: 5 }
                },
                companions: []
            },
            currentScene: 'intro',
            gameMode: 'story',
            enemy: null,
            gameMap: null,            shopItems: [
                { id: 'healing_potion', name: '治疗药水', type: 'consumable', effect: 'heal', value: 30, price: 50, description: '恢复30点生命值' },
                { id: 'mana_potion', name: '魔法药水', type: 'consumable', effect: 'mana', value: 20, price: 40, description: '恢复20点魔法值' },
                { id: 'iron_sword', name: '铁剑', type: 'weapon', attack: 20, price: 100, description: '攻击力+20的铁制武器' },
                { id: 'leather_armor', name: '皮甲', type: 'armor', defense: 10, price: 80, description: '防御力+10的皮制护甲' },
                { id: 'magic_ring', name: '魔法戒指', type: 'accessory', mp: 20, price: 150, description: '增加20点最大魔法值' },
                { id: 'strength_potion', name: '力量药水', type: 'consumable', effect: 'buff', value: 10, price: 50, description: '临时增加10点攻击力' },
                { id: 'steel_sword', name: '钢剑', type: 'weapon', attack: 35, price: 250, description: '攻击力+35的钢制武器' },
                { id: 'plate_armor', name: '板甲', type: 'armor', defense: 25, price: 200, description: '防御力+25的重型板甲' },
                { id: 'wisdom_amulet', name: '智慧护符', type: 'accessory', mp: 30, price: 300, description: '增加30点最大魔法值' },
                { id: 'elixir', name: '万能药', type: 'consumable', effect: 'full_heal', value: 999, price: 500, description: '完全恢复生命值和魔法值' }
            ],
            // 掉落物品
            dropItems: [
                { id: 'healing_potion', name: '治疗药水', type: 'consumable', effect: 'heal', value: 30, price: 50, description: '恢复30点生命值', dropRate: 0.3 },
                { id: 'mana_potion', name: '魔法药水', type: 'consumable', effect: 'mana', value: 20, price: 40, description: '恢复20点魔法值', dropRate: 0.2 },
                { id: 'gold_bag', name: '金币袋', type: 'consumable', effect: 'gold', value: 50, price: 0, description: '获得50金币', dropRate: 0.4 },
                { id: 'rusty_sword', name: '生锈的剑', type: 'weapon', attack: 5, price: 20, description: '攻击力+5的生锈武器', dropRate: 0.1 },
                { id: 'old_boots', name: '旧靴子', type: 'armor', defense: 2, price: 10, description: '防御力+2的旧靴子', dropRate: 0.1 }
            ],    { id: 'strength_potion', name: '力量药水', type: 'consumable', effect: 'buff', value: 10, price: 50, description: '临时增加10点攻击力' },
                { id: 'steel_sword', name: '钢剑', type: 'weapon', attack: 35, price: 250, description: '攻击力+35的钢制武器' },
                { id: 'plate_armor', name: '板甲', type: 'armor', defense: 25, price: 200, description: '防御力+25的重型板甲' },
                { id: 'wisdom_amulet', name: '智慧护符', type: 'accessory', mp: 30, price: 300, description: '增加30点最大魔法值' },
                { id: 'elixir', name: '万能药', type: 'consumable', effect: 'full_heal', value: 999, price: 500, description: '完全恢复生命值和魔法值' }
            ],
            // 掉落物品
            dropItems: [
                { id: 'healing_potion', name: '治疗药水', type: 'consumable', effect: 'heal', value: 30, price: 50, description: '恢复30点生命值', dropRate: 0.3 },
                { id: 'mana_potion', name: '魔法药水', type: 'consumable', effect: 'mana', value: 20, price: 40, description: '恢复20点魔法值', dropRate: 0.2 },
                { id: 'gold_bag', name: '金币袋', type: 'consumable', effect: 'gold', value: 50, price: 0, description: '获得50金币', dropRate: 0.4 },
                { id: 'rusty_sword', name: '生锈的剑', type: 'weapon', attack: 5, price: 20, description: '攻击力+5的生锈武器', dropRate: 0.1 },
                { id: 'old_boots', name: '旧靴子', type: 'armor', defense: 2, price: 10, description: '防御力+2的旧靴子', dropRate: 0.1 }
            ],
            // 客栈系统
            inn: {
                restCost: 20,
                isOpen: false
            },
            // NPC系统
            npcs: [
                {
                    id: 'merchant_bob',
                    name: '商人鲍勃',
                    location: 'town',
                    dialogue: [
                        '欢迎来到我们的小镇！这里的贸易很繁荣。',
                        '听说最近森林里出现了一些奇怪的意图波动...',
                        '如果你需要好装备，记得去商店看看！',
                        '意图法师们总是很忙碌，但记得要好好休息哦。'
                    ]
                },
                {
                    id: 'innkeeper_mary',
                    name: '客栈老板娘玛丽',
                    location: 'town',
                    dialogue: [
                        '累了吗？来我的客栈休息一下吧！',
                        '只要20金币，就能让你完全恢复精神！',
                        '我这里的床铺是全镇最舒服的！',
                        '冒险者们都说在这里睡一觉比喝药水还管用呢。'
                    ]
                },
                {
                    id: 'old_sage',
                    name: '智者老人',
                    location: 'village',
                    dialogue: [
                        '年轻的意图法师，意图的力量需要智慧来引导。',
                        '记住，真正的力量来自于理解，而不是征服。',
                        'Anoma世界的秘密比你想象的更加深奥...',
                        '每一次战斗都是学习的机会，珍惜它们。'
                    ]
                },
                {
                    id: 'village_guard',
                    name: '村庄守卫',
                    location: 'village',
                    dialogue: [
                        '最近森林里的怪物变得更加活跃了。',
                        '如果你要去冒险，一定要小心！',
                        '我听说有些意图法师能够收集伙伴一起战斗。',
                        '村长对你的期望很高，不要让他失望。'
                    ]
                }
            ],
            currentNpc: null,
            availableCompanions: [
                { 
                    id: 'shrimp_companion', 
                    name: '虾虾伙伴', 
                    sprite: '🦐',
                    image: 'monster7.png',
                    hp: 60, 
                    maxHp: 60, 
                    attack: 12, 
                    skill: '意图连接', 
                    description: '来自Anoma世界的神秘生物，能够帮助理解意图流动',
                    unlocked: false,
                    location: 'forest',
                    unlockLevel: 1
                },
                { 
                    id: 'crystal_guardian', 
                    name: '水晶守护者', 
                    sprite: '🔴',
                    image: 'monster1.png',
                    hp: 80, 
                    maxHp: 80, 
                    attack: 15, 
                    skill: '水晶护盾', 
                    description: '强大的守护者，拥有坚不可摧的防御能力',
                    unlocked: false,
                    location: 'cave',
                    unlockLevel: 3
                },
                { 
                    id: 'sky_watcher', 
                    name: '天空观察者', 
                    sprite: '👁️',
                    image: 'monster2.png',
                    hp: 50, 
                    maxHp: 50, 
                    attack: 18, 
                    skill: '洞察之眼', 
                    description: '能够看透一切的神秘存在，提供战略指导',
                    unlocked: false,
                    location: 'mountain',
                    unlockLevel: 5
                },
                { 
                    id: 'block_builder', 
                    name: '方块建造者', 
                    sprite: '🟥',
                    image: 'monster3.png',
                    hp: 70, 
                    maxHp: 70, 
                    attack: 14, 
                    skill: '构造术', 
                    description: '擅长建造和重组的工程大师',
                    unlocked: false,
                    location: 'town',
                    unlockLevel: 7
                },
                { 
                    id: 'void_walker', 
                    name: '虚空行者', 
                    sprite: '🌀',
                    image: 'monster4.png',
                    hp: 90, 
                    maxHp: 90, 
                    attack: 20, 
                    skill: '虚空穿越', 
                    description: '来自虚空的强大存在，掌控空间的力量',
                    unlocked: false,
                    location: 'cave',
                    unlockLevel: 10
                },
                { 
                    id: 'star_forge', 
                    name: '星辰锻造者', 
                    sprite: '⭐',
                    image: 'monster6.png',
                    hp: 100, 
                    maxHp: 100, 
                    attack: 25, 
                    skill: '星辰之力', 
                    description: '传说中的锻造大师，能够创造星辰级别的装备',
                    unlocked: false,
                    location: 'mountain',
                    unlockLevel: 15
                }
            ]
        };
        
        // 地图数据
        const mapSize = 20;
        
        // 初始化地图
        function initializeMap() {
            const map = [];
            for (let y = 0; y < mapSize; y++) {
                map[y] = [];
                for (let x = 0; x < mapSize; x++) {
                    map[y][x] = {
                        type: 'grass',
                        discovered: false,
                        hasEvent: false,
                        eventType: null,
                        passable: true
                    };
                }
            }
            
            // 村庄 (起始点)
            map[10][10] = { type: 'village', discovered: true, hasEvent: false, eventType: null, passable: true };
            
            // 森林区域 (可通行，有遇敌概率)
            for (let y = 5; y < 15; y++) {
                for (let x = 5; x < 8; x++) {
                    if (Math.random() > 0.3) {
                        map[y][x] = { 
                            type: 'forest', 
                            discovered: false, 
                            hasEvent: false, 
                            eventType: null,
                            passable: true
                        };
                    }
                }
            }
            
            // 山脉 (不可通行)
            for (let y = 2; y < 6; y++) {
                for (let x = 12; x < 18; x++) {
                    if (Math.random() > 0.4) {
                        map[y][x] = { 
                            type: 'mountain', 
                            discovered: false, 
                            hasEvent: false, 
                            eventType: null,
                            passable: false
                        };
                    }
                }
            }
            
            // 湖泊 (不可通行)
            for (let y = 15; y < 19; y++) {
                for (let x = 13; x < 17; x++) {
                    if (Math.random() > 0.5) {
                        map[y][x] = { 
                            type: 'water', 
                            discovered: false, 
                            hasEvent: false, 
                            eventType: null,
                            passable: false
                        };
                    }
                }
            }
            
            // 洞穴入口 (可通行，有特殊事件)
            map[3][15] = { type: 'cave', discovered: false, hasEvent: true, eventType: 'dungeon', passable: true };
            map[16][6] = { type: 'cave', discovered: false, hasEvent: true, eventType: 'dungeon', passable: true };
            
            // 其他城镇 (可通行)
            map[5][5] = { type: 'town', discovered: false, hasEvent: true, eventType: 'shop', passable: true };
            map[15][15] = { type: 'town', discovered: false, hasEvent: true, eventType: 'shop', passable: true };
            
            // 添加更多山脉障碍
            for (let i = 0; i < 15; i++) {
                const x = Math.floor(Math.random() * mapSize);
                const y = Math.floor(Math.random() * mapSize);
                if (map[y][x].type === 'grass' && !(x === 10 && y === 10)) {
                    map[y][x] = {
                        type: 'mountain',
                        discovered: false,
                        hasEvent: false,
                        eventType: null,
                        passable: false
                    };
                }
            }
            
            // 添加更多水域障碍
            for (let i = 0; i < 10; i++) {
                const x = Math.floor(Math.random() * mapSize);
                const y = Math.floor(Math.random() * mapSize);
                if (map[y][x].type === 'grass' && !(x === 10 && y === 10)) {
                    map[y][x] = {
                        type: 'water',
                        discovered: false,
                        hasEvent: false,
                        eventType: null,
                        passable: false
                    };
                }
            }
            
            gameState.gameMap = map;
        }
        
        // 地形图标映射
        function getTerrainIcon(type) {
            const icons = {
                'village': '🏘️',
                'town': '🏛️',
                'forest': '🌲',
                'mountain': '⛰️',
                'water': '🌊',
                'cave': '🕳️',
                'grass': '🌱'
            };
            return icons[type] || '🌱';
        }
        
        // 更新玩家状态显示
        function updatePlayerStats() {
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-hp').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('player-mp').textContent = `${gameState.player.mp}/${gameState.player.maxMp}`;
            document.getElementById('player-exp').textContent = `${gameState.player.exp}/${gameState.player.maxExp}`;
            document.getElementById('player-gold').textContent = gameState.player.gold;
            
            // 更新进度条
            document.getElementById('hp-bar').style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            document.getElementById('mp-bar').style.width = `${(gameState.player.mp / gameState.player.maxMp) * 100}%`;
            document.getElementById('exp-bar').style.width = `${(gameState.player.exp / gameState.player.maxExp) * 100}%`;
        }
        
        // 添加日志
        function addLog(message) {
            const logContainer = document.getElementById('game-log');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 处理选择
        function makeChoice(choice) {
            switch (choice) {
                case 'village_chief':
                    document.getElementById('story-title').textContent = '村长的委托';
                    document.getElementById('story-text').textContent = '村长是一位慈祥的老人，他的眼中闪烁着智慧的光芒。当你走进他的房间时，他正在研究一张古老的地图。"年轻的意图法师，"他说道，"我们村庄附近出现了一些奇怪的现象。森林中的意图流动变得不稳定，一些原本温和的生物变得具有攻击性。我需要你去调查这个问题，并且..."他停顿了一下，"寻找传说中的虾虾伙伴。据说它能帮助意图法师更好地理解和操控意图。"';
                    updateChoices([
                        { text: '接受任务，前往森林调查', action: 'accept_quest' },
                        { text: '询问更多关于虾虾伙伴的信息', action: 'ask_shrimp' },
                        { text: '返回村庄中心', action: 'village_center' }
                    ]);
                    addLog('🏠 你与村长交谈，了解了当前的危机');
                    break;
                    
                case 'forest':
                    document.getElementById('story-title').textContent = '神秘森林';
                    document.getElementById('story-text').textContent = '你走进了村庄周围的森林。这里的树木高大茂密，阳光透过树叶洒下斑驳的光影。你能感受到空气中弥漫着浓郁的意图能量，但似乎有些不太稳定。突然，你听到了一些奇怪的声音...';
                    updateChoices([
                        { text: '深入森林探索', action: 'forest_deep' },
                        { text: '寻找意图能量的源头', action: 'find_intent' },
                        { text: '返回村庄', action: 'village_center' }
                    ]);
                    addLog('🌲 你进入了神秘的森林');
                    break;
                    
                case 'status':
                    showStatus();
                    break;
                    
                case 'shop':
                    showShop();
                    break;
                    
                case 'map':
                    showMap();
                    break;
                    
                case 'accept_quest':
                    document.getElementById('story-title').textContent = '任务开始';
                    document.getElementById('story-text').textContent = '你接受了村长的委托。他给了你一个古老的意图探测器和一些基础的冒险用品。"记住，"村长说道，"意图的力量既可以创造也可以毁灭。学会与它们和谐共处，你就能成为真正的意图大师。现在去吧，愿意图之光指引你的道路。"';
                    gameState.player.gold += 50;
                    updateChoices([
                        { text: '前往森林开始调查', action: 'forest' },
                        { text: '先去商店购买装备', action: 'shop' },
                        { text: '查看获得的物品', action: 'status' }
                    ]);
                    addLog('✅ 接受了村长的委托任务');
                    addLog('💰 获得了50金币的任务奖励');
                    updatePlayerStats();
                    break;
                    
                case 'forest_deep':
                    // 踩雷式遇敌机制
                    if (Math.random() > 0.4) { // 60%概率遇敌
                        startBattle();
                        addLog('🌲 在森林深处遭遇了敌人！');
                    } else {
                        document.getElementById('story-title').textContent = '意外发现';
                        document.getElementById('story-text').textContent = '在森林深处，你发现了一个闪闪发光的宝箱。当你打开它时，里面装满了金币和一瓶神秘的药水。这片森林似乎充满了意图能量的波动...';
                        const goldFound = Math.floor(Math.random() * 50) + 20;
                        gameState.player.gold += goldFound;
                        updateChoices([
                            { text: '继续深入探索', action: 'forest_deep' },
                            { text: '返回村庄', action: 'village_center' },
                            { text: '打开世界地图', action: 'map' }
                        ]);
                        addLog(`💰 发现宝箱，获得了${goldFound}金币！`);
                        updatePlayerStats();
                    }
                    break;
                case 'village_center':
                    document.getElementById('story-title').textContent = '村庄中心';
                    document.getElementById('story-text').textContent = '你回到了熟悉的村庄中心。这里有各种设施和友善的村民，你可以在这里休息、补给或与人交谈。';
                    updateChoices([
                        { text: '🏠 拜访村长', action: 'village_chief' },
                        { text: '🛒 前往商店', action: 'shop' },
                        { text: '🏨 前往客栈休息', action: 'inn' },
                        { text: '👥 与村民交谈', action: 'talk_npc' },
                        { text: '📊 查看个人状态', action: 'status' },
                        { text: '🗺️ 打开世界地图', action: 'map' },
                        { text: '🌲 探索森林', action: 'forest' }
                    ]);
                    addLog('🏠 返回到了村庄中心');
                    break;
                    
                case 'inn':
                    showInn();
                    break;
                    
                case 'talk_npc':
                    showNpcList();
                    break;
                    
                case 'rest_at_inn':
                    restAtInn();
                    break;
                    
                case 'shop_buy':
                    showShopBuy();
                    break;
                    
                case 'shop_sell':
                    showShopSell();
                    break;
                    
                default:
                    // 处理动态生成的动作
                    if (action.startsWith("talk_")) {
                        const npcId = action.replace("talk_", "");
                        talkToNpc(npcId);
                    } else if (action.startsWith("buy_")) {
                        const itemIndex = parseInt(action.replace("buy_", ""));
                        buyItem(itemIndex);
                    } else if (action.startsWith("sell_")) {
                        const itemIndex = parseInt(action.replace("sell_", ""));
                        sellItem(itemIndex);
                    } else if (action.startsWith("recruit_")) {
                        const companionId = action.replace("recruit_", "");
                        recruitCompanion(companionId);
                    }
                    break;
            }
        }
        
        // 更新选择按钮
        function updateChoices(choices) {
            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice.text;
                button.onclick = () => makeChoice(choice.action);
                choicesContainer.appendChild(button);
            });
        }
        
        // 显示状态
        function showStatus() {
            document.getElementById('story-title').textContent = '角色状态';
            document.getElementById('story-text').textContent = `
                🧙‍♂️ 意图法师
                等级: ${gameState.player.level}
                生命值: ${gameState.player.hp}/${gameState.player.maxHp}
                魔法值: ${gameState.player.mp}/${gameState.player.maxMp}
                经验值: ${gameState.player.exp}/${gameState.player.maxExp}
                金币: ${gameState.player.gold}
                
                🎒 装备:
                • 新手法杖 (攻击力: 10)
                • 布制长袍 (防御力: 5)
                • 意图探测器 (特殊道具)
            `;
            updateChoices([
                { text: '返回', action: 'village_center' }
            ]);
            addLog('📊 查看了角色状态');
        }
        
        // 显示商店
        function showShop() {
            document.getElementById('story-title').textContent = '村庄商店';
            document.getElementById('story-text').textContent = '商店老板是一位友善的中年人，他的店里摆满了各种冒险用品和魔法道具。';
            updateChoices([
                { text: '购买生命药水 (20金币)', action: 'buy_hp_potion' },
                { text: '购买魔法药水 (30金币)', action: 'buy_mp_potion' },
                { text: '购买铁剑 (100金币)', action: 'buy_sword' },
                { text: '返回村庄', action: 'village_center' }
            ]);
            addLog('🏪 进入了村庄商店');
        }
        
        // 显示地图
        function showMap() {
            if (!gameState.gameMap) {
                initializeMap();
            }
            
            document.getElementById("story-section").style.display = "none";
            document.getElementById("choices").style.display = "none";
            document.getElementById("map-container").style.display = "block";
            gameState.gameMode = "map"; // 设置游戏模式为地图
            
            renderMap();
            addLog("🗺️ 打开了世界地图");
        }
        
        // 渲染地图
        function renderMap() {
            const mapGrid = document.getElementById('map-grid');
            mapGrid.innerHTML = '';
            
            const viewSize = 10;
            const startX = Math.max(0, Math.min(mapSize - viewSize, gameState.player.x - 5));
            const startY = Math.max(0, Math.min(mapSize - viewSize, gameState.player.y - 5));
            
            for (let y = startY; y < startY + viewSize; y++) {
                for (let x = startX; x < startX + viewSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    
                    const tile = gameState.gameMap[y][x];
                    const isPlayer = x === gameState.player.x && y === gameState.player.y;
                    
                    if (isPlayer) {
                        cell.className += ' player';
                        cell.textContent = '🧙‍♂️';
                    } else if (tile.discovered) {
                        cell.className += ` ${tile.type}`;
                        cell.textContent = getTerrainIcon(tile.type);
                        // 为不可通行区域添加边框提示
                        if (!tile.passable) {
                            cell.style.border = '2px solid #ff4444';
                            cell.style.opacity = '0.8';
                        }
                    } else {
                        cell.className += ' undiscovered';
                        cell.textContent = '❓';
                    }
                    
                    mapGrid.appendChild(cell);
                }
            }
            
            document.getElementById('player-x').textContent = gameState.player.x;
            document.getElementById('player-y').textContent = gameState.player.y;
        }
        
        // 移动玩家
        function movePlayer(dx, dy) {
            const newX = Math.max(0, Math.min(mapSize - 1, gameState.player.x + dx));
            const newY = Math.max(0, Math.min(mapSize - 1, gameState.player.y + dy));
            
            // 检查目标位置是否可通行
            const targetTile = gameState.gameMap[newY][newX];
            if (!targetTile.passable) {
                addLog(`❌ 无法通过${getTerrainName(targetTile.type)}！`);
                return;
            }
            
            if (newX !== gameState.player.x || newY !== gameState.player.y) {
                gameState.player.x = newX;
                gameState.player.y = newY;
                
                // 发现新区域
                for (let y = Math.max(0, newY - 1); y <= Math.min(mapSize - 1, newY + 1); y++) {
                    for (let x = Math.max(0, newX - 1); x <= Math.min(mapSize - 1, newX + 1); x++) {
                        gameState.gameMap[y][x].discovered = true;
                    }
                }
                
                // 检查伙伴遭遇（优先级高于普通遭遇）
                if (checkCompanionEncounter(targetTile.type)) {
                    return; // 如果遇到伙伴，不进行其他检查
                }
                
                // 踩雷式遇敌机制
                const encounterChance = getEncounterChance(targetTile.type);
                if (Math.random() < encounterChance) {
                    closeMap();
                    startBattle();
                    addLog(`⚔️ 在${getTerrainName(targetTile.type)}中遭遇了敌人！`);
                    return;
                }
                
                // 检查特殊事件
                if (targetTile.hasEvent && targetTile.eventType) {
                    handleMapEvent(targetTile.eventType, newX, newY);
                }
                
                renderMap();
                addLog(`🚶‍♂️ 移动到${getTerrainName(targetTile.type)} (${newX}, ${newY})`);
            }
        }
        
        // 获取地形名称
        function getTerrainName(type) {
            const names = {
                'village': '村庄',
                'town': '城镇',
                'forest': '森林',
                'mountain': '山脉',
                'water': '湖泊',
                'cave': '洞穴',
                'grass': '草地'
            };
            return names[type] || '未知地形';
        }
        
        // 获取遇敌概率
        function getEncounterChance(terrainType) {
            const encounterRates = {
                'grass': 0.15,      // 草地：15%遇敌率
                'forest': 0.35,     // 森林：35%遇敌率
                'mountain': 0.25,   // 山脉：25%遇敌率（虽然不可通行，但用于参考）
                'cave': 0.50,       // 洞穴：50%遇敌率
                'village': 0.0,     // 村庄：0%遇敌率
                'town': 0.0,        // 城镇：0%遇敌率
                'water': 0.0        // 水域：0%遇敌率（不可通行）
            };
            return encounterRates[terrainType] || 0.1;
        }
        
        // 处理地图事件
        function handleMapEvent(eventType, x, y) {
            switch (eventType) {
                case 'monster':
                    closeMap();
                    startBattle();
                    addLog(`⚔️ 在 (${x}, ${y}) 遭遇了敌人！`);
                    break;
                case 'treasure':
                    const treasureGold = Math.floor(Math.random() * 50) + 10;
                    gameState.player.gold += treasureGold;
                    updatePlayerStats();
                    addLog(`💰 发现了宝箱！获得了 ${treasureGold} 金币`);
                    break;
                case 'dungeon':
                    addLog(`🕳️ 发现了地下城入口！这里充满了危险...`);
                    closeMap();
                    startBattle();
                    break;
                case 'shop':
                    closeMap();
                    showShop();
                    addLog(`🏪 进入了城镇商店`);
                    break;
            }
        }
        
        // 检查伙伴遭遇
        function checkCompanionEncounter(terrainType) {
            const availableCompanions = gameState.availableCompanions.filter(
                companion => !companion.unlocked && 
                           companion.location === terrainType &&
                           gameState.player.level >= companion.unlockLevel
            );
            
            if (availableCompanions.length > 0 && Math.random() < 0.15) { // 15%概率遇到伙伴
                const companion = availableCompanions[Math.floor(Math.random() * availableCompanions.length)];
                showCompanionEncounter(companion);
                return true;
            }
            return false;
        }
        
        // 显示伙伴遭遇
        function showCompanionEncounter(companion) {
            closeMap();
            document.getElementById('story-title').textContent = '意外遭遇';
            document.getElementById('story-text').textContent = `
                在你的冒险途中，你遇到了一个神秘的生物——${companion.name} ${companion.sprite}！
                
                ${companion.description}
                
                它似乎对你的意图能量很感兴趣，想要加入你的冒险队伍。你愿意接受这个新伙伴吗？
            `;
            
            updateChoices([
                { text: `✅ 接受${companion.name}加入队伍`, action: `recruit_${companion.id}` },
                { text: '🤔 先观察一下', action: 'observe_companion' },
                { text: '❌ 礼貌地拒绝', action: 'decline_companion' }
            ]);
            
            // 临时存储当前遭遇的伙伴
            gameState.currentCompanionEncounter = companion;
            addLog(`🌟 遇到了潜在的新伙伴：${companion.name}！`);
        }
        
        // 招募伙伴
        function recruitCompanion(companionId) {
            const companion = gameState.availableCompanions.find(c => c.id === companionId);
            if (companion) {
                companion.unlocked = true;
                gameState.player.companions.push({
                    ...companion,
                    hp: companion.maxHp
                });
                
                document.getElementById('story-title').textContent = '新伙伴加入！';
                document.getElementById('story-text').textContent = `
                    🎉 ${companion.name}决定加入你的冒险队伍！
                    
                    ${companion.name}的能力：
                    • 生命值：${companion.maxHp}
                    • 攻击力：${companion.attack}
                    • 特殊技能：${companion.skill}
                    
                    有了新伙伴的帮助，你的冒险将变得更加精彩！
                `;
                
                updateChoices([
                    { text: '🏠 返回村庄', action: 'village_center' },
                    { text: '🗺️ 继续探索', action: 'map' },
                    { text: '👥 查看队伍状态', action: 'view_party' }
                ]);
                
                addLog(`🎉 ${companion.name}加入了你的队伍！`);
                gameState.currentCompanionEncounter = null;
            }
        }
        
        // 关闭地图
        function closeMap() {
            document.getElementById("story-section").style.display = "block";
            document.getElementById("choices").style.display = "grid";
            document.getElementById("map-container").style.display = "none";
            gameState.gameMode = "story"; // 设置游戏模式为故事
            makeChoice("village_center");
        }
        
        // 开始战斗
        function startBattle() {
            const enemies = [
                { name: '森林哥布林', sprite: '👹', hp: 60, maxHp: 60, attack: 15 },
                { name: '野狼', sprite: '🐺', hp: 80, maxHp: 80, attack: 20 },
                { name: '石头巨人', sprite: '🗿', hp: 120, maxHp: 120, attack: 25 }
            ];
            
            gameState.enemy = enemies[Math.floor(Math.random() * enemies.length)];
            
            document.getElementById('story-section').style.display = 'none';
            document.getElementById('choices').style.display = 'none';
            document.getElementById('battle-section').style.display = 'block';
            
            document.getElementById('enemy-sprite').textContent = gameState.enemy.sprite;
            document.getElementById('enemy-name').textContent = gameState.enemy.name;
            updateBattleDisplay();
            
            addLog(`⚔️ 战斗开始！遭遇了${gameState.enemy.name}`);
        }
        
        // 更新战斗显示
        function updateBattleDisplay() {
            document.getElementById('enemy-hp').textContent = `HP: ${gameState.enemy.hp}/${gameState.enemy.maxHp}`;
            document.getElementById('enemy-hp-bar').style.width = `${(gameState.enemy.hp / gameState.enemy.maxHp) * 100}%`;
        }
        
        // 战斗行动
        function battleAction(action) {
            let playerDamage = 0;
            let enemyDamage = 0;
            
            switch (action) {
                case 'attack':
                    playerDamage = Math.floor(Math.random() * 20) + 15;
                    gameState.enemy.hp -= playerDamage;
                    addLog(`⚔️ 你攻击了${gameState.enemy.name}，造成${playerDamage}点伤害`);
                    break;
                    
                case 'magic':
                    if (gameState.player.mp >= 10) {
                        playerDamage = Math.floor(Math.random() * 30) + 20;
                        gameState.enemy.hp -= playerDamage;
                        gameState.player.mp -= 10;
                        addLog(`✨ 你使用魔法攻击，造成${playerDamage}点伤害`);
                    } else {
                        addLog(`❌ 魔法值不足！`);
                        return;
                    }
                    break;
                    
                case 'defend':
                    addLog(`🛡️ 你进入防御姿态`);
                    enemyDamage = Math.floor(gameState.enemy.attack * 0.5);
                    break;
                    
                case 'escape':
                    if (Math.random() > 0.3) {
                        addLog(`🏃 成功逃脱了战斗！`);
                        endBattle(false);
                        return;
                    } else {
                        addLog(`❌ 逃跑失败！`);
                    }
                    break;
            }
            
            // 检查敌人是否死亡
            if (gameState.enemy.hp <= 0) {
                const expGain = Math.floor(Math.random() * 30) + 20;
                const goldGain = Math.floor(Math.random() * 40) + 15;
                
                gameState.player.exp += expGain;
                gameState.player.gold += goldGain;
                
                // 检查升级
                if (gameState.player.exp >= gameState.player.maxExp) {
                    gameState.player.level++;
                    gameState.player.exp -= gameState.player.maxExp;
                    gameState.player.maxExp += 50;
                    gameState.player.maxHp += 20;
                    gameState.player.hp = gameState.player.maxHp;
                    gameState.player.maxMp += 10;
                    gameState.player.mp = gameState.player.maxMp;
                    addLog(`🎉 升级了！现在是${gameState.player.level}级`);
                }
                
                addLog(`🏆 战斗胜利！获得${expGain}经验值和${goldGain}金币`);

                // 物品掉落
                gameState.dropItems.forEach(dropItem => {
                    if (Math.random() < dropItem.dropRate) {
                        // 如果是金币袋，直接增加金币
                        if (dropItem.id === 'gold_bag') {
                            gameState.player.gold += dropItem.value;
                            addLog(`🎉 掉落了${dropItem.value}金币！`);
                        } else {
                            gameState.player.inventory.push(dropItem);
                            addLog(`🎉 掉落了${dropItem.name}！`);
                        }
                    }
                });
                endBattle(true);
                return;
            }
            
            // 敌人攻击
            if (action !== 'defend') {
                enemyDamage = Math.floor(Math.random() * gameState.enemy.attack) + 5;
            }
            
            if (enemyDamage > 0) {
                gameState.player.hp -= enemyDamage;
                addLog(`💥 ${gameState.enemy.name}攻击了你，造成${enemyDamage}点伤害`);
            }
            
            // 检查玩家是否死亡
            if (gameState.player.hp <= 0) {
                addLog(`💀 你被击败了...`);
                gameState.player.hp = 1;
                gameState.player.gold = Math.floor(gameState.player.gold * 0.8);
                endBattle(false);
                return;
            }
            
            updateBattleDisplay();
            updatePlayerStats();
        }
        
        // 结束战斗
        function endBattle(victory) {
            document.getElementById('story-section').style.display = 'block';
            document.getElementById('choices').style.display = 'grid';
            document.getElementById('battle-section').style.display = 'none';
            
            if (victory) {
                makeChoice('village_center');
            } else {
                document.getElementById('story-title').textContent = '战斗结束';
                document.getElementById('story-text').textContent = '虽然这次没有获得胜利，但你从战斗中学到了宝贵的经验。休息一下，准备下一次的冒险吧。';
                updateChoices([
                    { text: '返回村庄休息', action: 'village_center' }
                ]);
            }
            
            updatePlayerStats();
        }
        
        // 初始化游戏
        function initGame() {
            initializeMap();
            updatePlayerStats();
            addLog('🎮 游戏初始化完成');
        }
        
        // 页面加载完成后初始化游戏
        window.onload = function() {
            initGame();
        };
        
        // 客栈系统
        function showInn() {
            document.getElementById('story-title').textContent = '🏨 温馨客栈';
            const innkeeper = gameState.npcs.find(npc => npc.id === 'innkeeper_mary');
            const randomDialogue = innkeeper.dialogue[Math.floor(Math.random() * innkeeper.dialogue.length)];
            
            document.getElementById('story-text').textContent = `
                客栈老板娘玛丽热情地迎接了你。
                
                "${randomDialogue}"
                
                休息费用：${gameState.inn.restCost} 金币
                当前生命值：${gameState.player.hp}/${gameState.player.maxHp}
                当前魔法值：${gameState.player.mp}/${gameState.player.maxMp}
                当前金币：${gameState.player.gold}
            `;
            
            const choices = [];
            
            if (gameState.player.gold >= gameState.inn.restCost && 
                (gameState.player.hp < gameState.player.maxHp || gameState.player.mp < gameState.player.maxMp)) {
                choices.push({ text: `💰 支付${gameState.inn.restCost}金币休息`, action: 'rest_at_inn' });
            }
            
            choices.push(
                { text: '💬 与老板娘聊天', action: 'talk_innkeeper_mary' },
                { text: '🏠 返回村庄中心', action: 'village_center' }
            );
            
            updateChoices(choices);
        }
        
        function restAtInn() {
            if (gameState.player.gold >= gameState.inn.restCost) {
                gameState.player.gold -= gameState.inn.restCost;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.mp = gameState.player.maxMp;
                
                document.getElementById('story-title').textContent = '😴 舒适的休息';
                document.getElementById('story-text').textContent = `
                    你在客栈的舒适床铺上美美地睡了一觉。
                    
                    温暖的被褥和安静的环境让你完全恢复了精神。
                    当你醒来时，感觉精力充沛，准备迎接新的冒险！
                    
                    ✅ 生命值和魔法值已完全恢复！
                    💰 支付了${gameState.inn.restCost}金币
                `;
                
                updateChoices([
                    { text: '🌅 开始新的一天', action: 'village_center' },
                    { text: '📊 查看状态', action: 'status' }
                ]);
                
                addLog(`😴 在客栈休息，完全恢复了体力和魔法`);
                addLog(`💰 支付了${gameState.inn.restCost}金币`);
                updatePlayerStats();
            }
        }
        
        // NPC系统
        function showNpcList() {
            document.getElementById('story-title').textContent = '👥 村民交谈';
            document.getElementById('story-text').textContent = `
                村庄里有几位友善的村民，你可以选择与他们交谈：
                
                每个人都有自己的故事和见解，也许能给你一些有用的信息或建议。
            `;
            
            const villageNpcs = gameState.npcs.filter(npc => npc.location === 'village');
            const choices = villageNpcs.map(npc => ({
                text: `💬 与${npc.name}交谈`,
                action: `talk_${npc.id}`
            }));
            
            choices.push({ text: '🏠 返回村庄中心', action: 'village_center' });
            updateChoices(choices);
        }
        
        function talkToNpc(npcId) {
            const npc = gameState.npcs.find(n => n.id === npcId);
            if (npc) {
                const randomDialogue = npc.dialogue[Math.floor(Math.random() * npc.dialogue.length)];
                
                document.getElementById('story-title').textContent = `💬 与${npc.name}的对话`;
                document.getElementById('story-text').textContent = `
                    ${npc.name}友善地看着你。
                    
                    "${randomDialogue}"
                    
                    ${npc.name}的话语中透露着智慧和经验，也许对你的冒险有所帮助。
                `;
                
                updateChoices([
                    { text: '🗣️ 继续交谈', action: `talk_${npcId}` },
                    { text: '👥 与其他村民交谈', action: 'talk_npc' },
                    { text: '🏠 返回村庄中心', action: 'village_center' }
                ]);
                
                addLog(`💬 与${npc.name}进行了愉快的交谈`);
            }
        }
        
        // 更新商店系统，添加卖出功能
        function showShop() {
            document.getElementById('story-title').textContent = '🛒 村庄商店';
            document.getElementById('story-text').textContent = `
                商店老板热情地招呼你："欢迎光临！我这里有各种冒险用品。"
                
                你的金币：${gameState.player.gold}
                
                你可以购买装备，也可以出售不需要的物品。
            `;
            
            updateChoices([
                { text: '🛍️ 购买物品', action: 'shop_buy' },
                { text: '💰 出售物品', action: 'shop_sell' },
                { text: '🏠 返回村庄中心', action: 'village_center' }
            ]);
        }
        
        function showShopBuy() {
            document.getElementById('story-title').textContent = '🛍️ 购买物品';
            let shopText = `选择要购买的物品：\n\n`;
            
            gameState.shopItems.forEach((item, index) => {
                shopText += `${index + 1}. ${item.name} - ${item.price}金币\n   ${item.description}\n\n`;
            });
            
            document.getElementById('story-text').textContent = shopText;
            
            const choices = gameState.shopItems.map((item, index) => ({
                text: `💰 购买 ${item.name} (${item.price}金币)`,
                action: `buy_${index}`
            }));
            
            choices.push({ text: '🔙 返回商店', action: 'shop' });
            updateChoices(choices);
        }
        
        function showShopSell() {
            document.getElementById('story-title').textContent = '💰 出售物品';
            
            if (gameState.player.inventory.length === 0) {
                document.getElementById('story-text').textContent = '你的背包里没有可以出售的物品。';
                updateChoices([{ text: '🔙 返回商店', action: 'shop' }]);
                return;
            }
            
            let sellText = `选择要出售的物品：\n\n`;
            gameState.player.inventory.forEach((item, index) => {
                const sellPrice = Math.floor(item.price * 0.6); // 60%的原价
                sellText += `${index + 1}. ${item.name} - 出售价格：${sellPrice}金币\n`;
            });
            
            document.getElementById('story-text').textContent = sellText;
            
            const choices = gameState.player.inventory.map((item, index) => {
                const sellPrice = Math.floor(item.price * 0.6);
                return {
                    text: `💰 出售 ${item.name} (${sellPrice}金币)`,
                    action: `sell_${index}`
                };
            });
            
            choices.push({ text: '🔙 返回商店', action: 'shop' });
            updateChoices(choices);
        }
        
        function buyItem(index) {
            const item = gameState.shopItems[index];
            if (item) {
                if (gameState.player.gold >= item.price) {
                    gameState.player.gold -= item.price;
                    gameState.player.inventory.push(item);
                    
                    document.getElementById("story-title").textContent = "🛍️ 购买成功";
                    document.getElementById("story-text").textContent = `你成功购买了${item.name}，花费了${item.price}金币。`;
                    
                    updateChoices([
                        { text: "💰 继续购买", action: "shop_buy" },
                        { text: "🔙 返回商店", action: "shop" }
                    ]);
                    
                    addLog(`🛍️ 购买了${item.name}，花费${item.price}金币`);
                    updatePlayerStats();
                } else {
                    document.getElementById("story-title").textContent = "💰 金币不足";
                    document.getElementById("story-text").textContent = `你没有足够的金币购买${item.name}。你需要${item.price}金币，但你只有${gameState.player.gold}金币。`;
                    updateChoices([
                        { text: "💰 继续购买", action: "shop_buy" },
                        { text: "🔙 返回商店", action: "shop" }
                    ]);
                    addLog(`❌ 金币不足，无法购买${item.name}`);
                }
            }
        }

        function sellItem(index) {
            const item = gameState.player.inventory[index];
            if (item) {
                const sellPrice = Math.floor(item.price * 0.6);
                gameState.player.gold += sellPrice;
                gameState.player.inventory.splice(index, 1);
                
                document.getElementById('story-title').textContent = '💰 物品已出售';
                document.getElementById('story-text').textContent = `
                    你成功出售了${item.name}，获得了${sellPrice}金币。
                    
                    商店老板满意地点了点头："这是个好东西，谢谢你的生意！"
                `;
                
                updateChoices([
                    { text: '💰 继续出售', action: 'shop_sell' },
                    { text: '🛍️ 购买物品', action: 'shop_buy' },
                    { text: '🔙 返回商店', action: 'shop' }
                ]);
                
                addLog(`💰 出售了${item.name}，获得${sellPrice}金币`);
                updatePlayerStats();
            }
        }
        
        // 键盘事件监听器
        document.addEventListener("keydown", (event) => {
            if (gameState.gameMode === "map") {
                switch (event.key) {
                    case "ArrowUp":
                        movePlayer(0, -1);
                        break;
                    case "ArrowDown":
                        movePlayer(0, 1);
                        break;
                    case "ArrowLeft":
                        movePlayer(-1, 0);
                        break;
                    case "ArrowRight":
                        movePlayer(1, 0);
                        break;
                }
            }
        });
    </script>
</body>
</html>

