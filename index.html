<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anoma RPG - æ„å›¾ä¹‹å¢ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #ffd700;
        }

        .game-title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .game-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #444;
        }

        .main-content {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }

        .player-stats {
            margin-bottom: 20px;
        }

        .stat-bar {
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #666;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .hp-bar { background: #e74c3c; }
        .mp-bar { background: #3498db; }
        .exp-bar { background: #f39c12; }

        .character-image {
            text-align: center;
            margin: 20px 0;
        }

        .character-image img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 10px;
            border: 2px solid #ffd700;
        }

        .story-content {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #666;
        }

        .story-text {
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .choices {
            display: grid;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            border: 2px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-btn:hover {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        .shop-container, .inn-container, .inventory-container, .map-container {
            display: none;
        }

        .shop-container.active, .inn-container.active, .inventory-container.active, .map-container.active {
            display: block;
        }

        .shop-items, .inventory-items {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }

        .item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            color: #ffd700;
        }

        .item-description {
            font-size: 0.9em;
            color: #ccc;
            margin: 5px 0;
        }

        .item-price {
            color: #f39c12;
            font-weight: bold;
        }

        .buy-btn, .sell-btn, .use-btn, .equip-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .buy-btn:hover, .sell-btn:hover, .use-btn:hover, .equip-btn:hover {
            background: #2ecc71;
        }

        .buy-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .game-log {
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #666;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }

        .back-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .back-btn:hover {
            background: #c0392b;
        }

        .inn-service {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .rest-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 10px;
        }

        .rest-btn:hover {
            background: #8e44ad;
        }

        .rest-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .npc-dialogue {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #f39c12;
        }

        .npc-name {
            color: #f39c12;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .dialogue-text {
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(10, 40px);
            gap: 2px;
            margin: 20px 0;
            justify-content: center;
        }

        .map-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            border-radius: 3px;
            background: #2c3e50;
        }

        .map-cell.player {
            background: #e74c3c;
            border-color: #ffd700;
        }

        .map-cell.forest {
            background: #27ae60;
        }

        .map-cell.town {
            background: #3498db;
        }

        .map-cell.mountain {
            background: #95a5a6;
        }

        .map-cell.cave {
            background: #6a3200;
        }

        .companion-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #3498db;
        }

        .companion-name {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr;
            }
            
            .game-title {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">ğŸ§™â€â™‚ï¸ Anoma RPG - æ„å›¾ä¹‹å¢ƒ ğŸŒŸ</h1>
        
        <div class="game-layout">
            <!-- ä¾§è¾¹æ  - è§’è‰²çŠ¶æ€ -->
            <div class="sidebar">
                <div class="player-stats">
                    <h3>ğŸ§™â€â™‚ï¸ æ„å›¾æ³•å¸ˆ</h3>
                    <p>ç­‰çº§: <span id="player-level">1</span></p>
                    <p>é‡‘å¸: <span id="player-gold">100</span> ğŸ’°</p>
                    
                    <div class="stat-bar">
                        <div class="stat-label">ç”Ÿå‘½å€¼: <span id="hp-text">100/100</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill hp-bar" id="hp-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">é­”æ³•å€¼: <span id="mp-text">50/50</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill mp-bar" id="mp-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="stat-bar">
                        <div class="stat-label">ç»éªŒå€¼: <span id="exp-text">0/100</span></div>
                        <div class="progress-bar">
                            <div class="progress-fill exp-bar" id="exp-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="character-image">
                    <img id="character-img" src="./wizard.png" alt="è§’è‰²å›¾åƒ">
                </div>

                <!-- ä¼™ä¼´ä¿¡æ¯ -->
                <div id="companion-section" style="display: none;">
                    <div class="companion-info">
                        <div class="companion-name" id="companion-name">è™¾è™¾</div>
                        <div class="stat-bar">
                            <div class="stat-label">ç”Ÿå‘½å€¼: <span id="companion-hp-text">60/60</span></div>
                            <div class="progress-bar">
                                <div class="progress-fill hp-bar" id="companion-hp-bar" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¿«æ·æ“ä½œ -->
                <div style="margin-top: 20px;">
                    <button class="choice-btn" onclick="saveGame()" style="width: 100%; margin-bottom: 10px;">ğŸ’¾ ä¿å­˜æ¸¸æˆ</button>
                    <button class="choice-btn" onclick="loadGame()" style="width: 100%;">ğŸ“ åŠ è½½æ¸¸æˆ</button>
                </div>
            </div>

            <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <!-- æ•…äº‹æ¨¡å¼ -->
                <div id="story-mode">
                    <div class="story-content">
                        <div class="story-text" id="story-text">
                            åœ¨Anomaçš„ç¥ç§˜ä¸–ç•Œä¸­ï¼Œä½ æ˜¯ä¸€ååˆšåˆšè§‰é†’æ„å›¾èƒ½åŠ›çš„å¹´è½»æ³•å¸ˆã€‚è¿™ä¸ªä¸–ç•Œç”±æ— æ•°ä¸ª"æ„å›¾"æ„æˆï¼Œæ¯ä¸ªæ„å›¾éƒ½æ˜¯ç°å®çš„ä¸€ä¸ªç‰‡æ®µï¼Œè€Œä½ æ‹¥æœ‰æ“æ§è¿™äº›æ„å›¾çš„å¤©èµ‹ã€‚

                            ä½ ç«™åœ¨æ–°æ‰‹æ‘çš„ä¸­å¤®ï¼Œå‘¨å›´æ˜¯ç†Ÿæ‚‰çš„èŒ…è‰å±‹å’ŒçŸ³æ¿è·¯ã€‚è¿œå¤„çš„åœ°å¹³çº¿ä¸Šï¼Œç¥ç§˜çš„æ„å›¾ä¹‹å¡”è‹¥éšè‹¥ç°ï¼Œé‚£é‡Œæ®è¯´éšè—ç€Anomaä¸–ç•Œçš„ç»ˆæç§˜å¯†ã€‚

                            ä½ çš„å¯¼å¸ˆå‘Šè¯‰ä½ ï¼Œåªæœ‰é€šè¿‡ä¸æ–­çš„å†’é™©å’Œæˆ˜æ–—ï¼Œæ‰èƒ½æå‡ä½ çš„æ„å›¾æ“æ§èƒ½åŠ›ï¼Œæœ€ç»ˆæˆä¸ºçœŸæ­£çš„æ„å›¾å¤§å¸ˆã€‚
                        </div>
                        
                        <div class="choices" id="story-choices">
                            <button class="choice-btn" onclick="goToVillageChief()">ğŸ  å‰å¾€æ‘é•¿å®¶æ¥å—ç¬¬ä¸€ä¸ªä»»åŠ¡</button>
                            <button class="choice-btn" onclick="exploreForest()">ğŸŒ² æ¢ç´¢æ‘åº„å‘¨å›´çš„æ£®æ—</button>
                            <button class="choice-btn" onclick="openInventory()">ğŸ“Š æŸ¥çœ‹ä¸ªäººçŠ¶æ€å’Œè£…å¤‡</button>
                            <button class="choice-btn" onclick="openShop()">ğŸª å‰å¾€å•†åº—è´­ä¹°ç‰©å“</button>
                            <button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ æ‰“å¼€ä¸–ç•Œåœ°å›¾</button>
                        </div>
                    </div>
                </div>

                <!-- å•†åº—æ¨¡å¼ -->
                <div id="shop-mode" class="shop-container">
                    <h2>ğŸª æ„å›¾å•†åº—</h2>
                    <p>æ¬¢è¿æ¥åˆ°æ„å›¾å•†åº—ï¼è¿™é‡Œæœ‰å„ç§å†’é™©å¿…éœ€å“ã€‚</p>
                    
                    <div class="npc-dialogue">
                        <div class="npc-name">å•†äººé²å‹ƒ</div>
                        <div class="dialogue-text">
                            "æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„å°é•‡ï¼è¿™é‡Œçš„è´¸æ˜“å¾ˆç¹è£ã€‚å¦‚æœä½ éœ€è¦å¥½è£…å¤‡ï¼Œè®°å¾—å»å•†åº—çœ‹çœ‹ï¼æ„å›¾æ³•å¸ˆä»¬æ€»æ˜¯å¾ˆå¿™ç¢Œï¼Œä½†è®°å¾—è¦å¥½å¥½ä¼‘æ¯å“¦ã€‚"
                        </div>
                    </div>
                    
                    <div class="shop-items" id="shop-items">
                        <!-- å•†åº—ç‰©å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">è¿”å›æ‘åº„</button>
                </div>

                <!-- æ—…åº—æ¨¡å¼ -->
                <div id="inn-mode" class="inn-container">
                    <h2>ğŸ¨ æ„å›¾æ—…åº—</h2>
                    
                    <div class="npc-dialogue">
                        <div class="npc-name">å®¢æ ˆè€æ¿å¨˜ç›ä¸½</div>
                        <div class="dialogue-text" id="inn-dialogue">
                            "æ¬¢è¿æ¥åˆ°æ„å›¾æ—…åº—ï¼ç´¯äº†å—ï¼Ÿåœ¨è¿™é‡Œä¼‘æ¯ä¸€ä¸‹ï¼Œåªéœ€è¦20é‡‘å¸å°±èƒ½å®Œå…¨æ¢å¤ä½ çš„ç”Ÿå‘½å€¼å’Œé­”æ³•å€¼ã€‚æˆ‘ä»¬çš„åºŠé“ºæ˜¯å…¨æ‘æœ€èˆ’æœçš„ï¼"
                        </div>
                    </div>
                    
                    <div class="inn-service">
                        <h3>ğŸ’¤ ä¼‘æ¯æœåŠ¡</h3>
                        <p>è´¹ç”¨: 20 é‡‘å¸</p>
                        <p>æ•ˆæœ: å®Œå…¨æ¢å¤ç”Ÿå‘½å€¼å’Œé­”æ³•å€¼</p>
                        <button class="rest-btn" id="rest-btn" onclick="restAtInn()">ğŸ’¤ ä¼‘æ¯ (20é‡‘å¸)</button>
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">ç¦»å¼€æ—…åº—</button>
                </div>

                <!-- èƒŒåŒ…æ¨¡å¼ -->
                <div id="inventory-mode" class="inventory-container">
                    <h2>ğŸ’ ç‰©å“èƒŒåŒ…</h2>
                    
                    <div class="inventory-items" id="inventory-items">
                        <!-- èƒŒåŒ…ç‰©å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">å…³é—­èƒŒåŒ…</button>
                </div>

                <!-- åœ°å›¾æ¨¡å¼ -->
                <div id="map-mode" class="map-container">
                    <h2>ğŸ—ºï¸ æ„å›¾ä¸–ç•Œåœ°å›¾</h2>
                    <p>ä½¿ç”¨æ–¹å‘é”®æˆ–ç‚¹å‡»ç§»åŠ¨ã€‚ğŸ§™â€â™‚ï¸ è¡¨ç¤ºä½ çš„ä½ç½®ã€‚</p>
                    
                    <div class="map-grid" id="map-grid">
                        <!-- åœ°å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="choice-btn" onclick="movePlayer(-1, 0)" style="width: 60px;">â¬…ï¸</button>
                        <button class="choice-btn" onclick="movePlayer(1, 0)" style="width: 60px;">â¡ï¸</button>
                        <button class="choice-btn" onclick="movePlayer(0, -1)" style="width: 60px;">â¬†ï¸</button>
                        <button class="choice-btn" onclick="movePlayer(0, 1)" style="width: 60px;">â¬‡ï¸</button>
                    </div>
                    
                    <button class="back-btn" onclick="backToStory()">å…³é—­åœ°å›¾</button>
                </div>

                <!-- æ¸¸æˆæ—¥å¿— -->
                <div class="game-log">
                    <h4>ğŸ“œ æ¸¸æˆæ—¥å¿—</h4>
                    <div id="game-log">
                        <div class="log-entry">æ¸¸æˆå¼€å§‹ï¼æ¬¢è¿æ¥åˆ°Anomaä¸–ç•Œï¼</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            player: {
                x: 0,
                y: 0,
                level: 1,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                exp: 0,
                nextLevelExp: 100,
                gold: 100,
                inventory: [
                    { name: 'åˆçº§æ²»ç–—è¯æ°´', type: 'potion', effect: 30, price: 20 },
                ],
                companions: [],
            },
            mapData: [
                { x: 2, y: 2, type: 'town', name: 'å¸Œæœ›é•‡', icon: 'ğŸ˜ï¸' },
                { x: 7, y: 5, type: 'cave', name: 'å›éŸ³æ´ç©´', icon: 'ğŸï¸' },
                { x: 4, y: 8, type: 'mountain', name: 'è¿·é›¾å±±è„‰', icon: 'â›°ï¸' },
                { x: 1, y: 6, type: 'town', name: 'å•†ä¸šé•‡', icon: 'ğŸª' },
                { x: 8, y: 2, type: 'cave', name: 'æ°´æ™¶æ´ç©´', icon: 'ğŸ’' },
                { x: 6, y: 9, type: 'mountain', name: 'é›ªå³°å±±', icon: 'ğŸ”ï¸' },
            ],
            shopItems: [
                { name: 'åˆçº§æ²»ç–—è¯æ°´', description: 'æ¢å¤30ç‚¹ç”Ÿå‘½å€¼', price: 20, type: 'potion', effect: 30 },
                { name: 'åˆçº§é­”æ³•è¯æ°´', description: 'æ¢å¤20ç‚¹é­”æ³•å€¼', price: 25, type: 'potion', effect: 20 },
                { name: 'æ„å›¾ç¢ç‰‡', description: 'ç”¨äºå‡çº§è£…å¤‡çš„ç¥ç§˜ç¢ç‰‡', price: 100, type: 'material' },
                { name: 'é“å‰‘', description: 'æ”»å‡»åŠ›+15çš„æ­¦å™¨', price: 150, type: 'weapon' },
                { name: 'çš®ç”²', description: 'é˜²å¾¡åŠ›+10çš„æŠ¤ç”²', price: 120, type: 'armor' },
            ],
            currentMode: 'story',
        };

        // æ›´æ–°ç©å®¶çŠ¶æ€æ˜¾ç¤º
        function updatePlayerStats() {
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-gold').textContent = gameState.player.gold;
            document.getElementById('hp-text').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
            document.getElementById('mp-text').textContent = `${gameState.player.mp}/${gameState.player.maxMp}`;
            document.getElementById('exp-text').textContent = `${gameState.player.exp}/${gameState.player.nextLevelExp}`;
            
            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('hp-bar').style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            document.getElementById('mp-bar').style.width = `${(gameState.player.mp / gameState.player.maxMp) * 100}%`;
            document.getElementById('exp-bar').style.width = `${(gameState.player.exp / gameState.player.nextLevelExp) * 100}%`;
        }

        // è®°å½•æ¸¸æˆæ—¥å¿—
        function logMessage(message) {
            const logDiv = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ˜¾ç¤ºä¸åŒæ¨¡å¼
        function showStoryMode() {
            document.getElementById('story-mode').style.display = 'block';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'none';
            gameState.currentMode = 'story';
        }

        function showShopMode() {
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'block';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'none';
            gameState.currentMode = 'shop';
            renderShop();
        }

        function showInnMode() {
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'block';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'none';
            gameState.currentMode = 'inn';
            updateRestButton();
        }

        function showInventoryMode() {
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'block';
            document.getElementById('map-mode').style.display = 'none';
            gameState.currentMode = 'inventory';
            renderInventory();
        }

        function showMapMode() {
            document.getElementById('story-mode').style.display = 'none';
            document.getElementById('shop-mode').style.display = 'none';
            document.getElementById('inn-mode').style.display = 'none';
            document.getElementById('inventory-mode').style.display = 'none';
            document.getElementById('map-mode').style.display = 'block';
            gameState.currentMode = 'map';
            renderMap();
        }

        // æ¸²æŸ“åœ°å›¾
        function renderMap() {
            const mapContainer = document.getElementById('map-grid');
            mapContainer.innerHTML = '';

            for (let y = 0; y < 10; y++) {
                for (let x = 0; x < 10; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç©å®¶ä½ç½®
                    if (x === gameState.player.x && y === gameState.player.y) {
                        cell.classList.add('player');
                        cell.textContent = 'ğŸ§™â€â™‚ï¸';
                    } else {
                        // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šåœ°ç‚¹
                        const location = gameState.mapData.find(loc => loc.x === x && loc.y === y);
                        if (location) {
                            cell.classList.add(location.type);
                            cell.textContent = location.icon;
                            cell.title = location.name;
                        } else {
                            // éšæœºåœ°å½¢
                            const terrain = Math.random();
                            if (terrain < 0.3) {
                                cell.classList.add('forest');
                                cell.textContent = 'ğŸŒ²';
                            } else {
                                cell.textContent = 'ğŸŸ«';
                            }
                        }
                    }
                    
                    mapContainer.appendChild(cell);
                }
            }
        }

        // ç§»åŠ¨ç©å®¶
        function movePlayer(dx, dy) {
            const newX = gameState.player.x + dx;
            const newY = gameState.player.y + dy;

            // æ£€æŸ¥è¾¹ç•Œ
            if (newX >= 0 && newX < 10 && newY >= 0 && newY < 10) {
                gameState.player.x = newX;
                gameState.player.y = newY;

                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç‰¹æ®Šåœ°ç‚¹
                const location = gameState.mapData.find(loc => loc.x === gameState.player.x && loc.y === gameState.player.y);
                if (location) {
                    if (location.type === 'town') {
                        logMessage(`ä½ è¿›å…¥äº†${location.name}ï¼`);
                        document.getElementById('story-text').innerText = `æ¬¢è¿æ¥åˆ°${location.name}ï¼è¿™é‡Œæ˜¯ä¸€ä¸ªç¹è£çš„å•†ä¸šä¸­å¿ƒï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å•†åº—å’Œæ—…åº—ã€‚`;
                        document.getElementById('story-choices').innerHTML = `
                            <button class="choice-btn" onclick="openShop()">ğŸª é€›é€›å•†åº—</button>
                            <button class="choice-btn" onclick="openInn()">ğŸ¨ åœ¨æ—…åº—ä¼‘æ¯</button>
                            <button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ è¿”å›åœ°å›¾</button>
                        `;
                        showStoryMode();
                    } else if (location.type === 'cave') {
                        logMessage(`ä½ å‘ç°äº†${location.name}ï¼`);
                        document.getElementById('story-text').innerText = `ä½ èµ°è¿›${location.name}ï¼Œè¿™é‡Œé˜´æš—æ½®æ¹¿ï¼Œä¼¼ä¹éšè—ç€ä»€ä¹ˆç§˜å¯†ã€‚ä½ å¯ä»¥é€‰æ‹©æ·±å…¥æ¢ç´¢æˆ–è€…ç¦»å¼€ã€‚`;
                        document.getElementById('story-choices').innerHTML = `
                            <button class="choice-btn" onclick="exploreCave()">ğŸ”¦ æ·±å…¥æ¢ç´¢æ´ç©´</button>
                            <button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ ç¦»å¼€æ´ç©´</button>
                        `;
                        showStoryMode();
                    } else if (location.type === 'mountain') {
                        logMessage(`ä½ æ¥åˆ°äº†${location.name}ã€‚`);
                        document.getElementById('story-text').innerText = `ä½ ç«™åœ¨${location.name}çš„è„šä¸‹ï¼Œå±±è·¯å´å²–ï¼Œå……æ»¡æŒ‘æˆ˜ã€‚è¿™é‡Œçš„ç©ºæ°”ç¨€è–„ï¼Œä½†æ™¯è‰²å£®è§‚ã€‚`;
                        document.getElementById('story-choices').innerHTML = `
                            <button class="choice-btn" onclick="climbMountain()">â›°ï¸ å°è¯•æ”€ç™»</button>
                            <button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ è¿”å›åœ°å›¾</button>
                        `;
                        showStoryMode();
                    }
                } else {
                    logMessage(`ä½ ç§»åŠ¨åˆ°äº† (${gameState.player.x}, ${gameState.player.y})`);
                    
                    // éšæœºé‡æ•Œæ£€æŸ¥ï¼ˆåœ¨æ™®é€šåœ°å½¢ç§»åŠ¨æ—¶ï¼‰
                    const encounterChance = Math.random();
                    if (encounterChance < 0.3) { // 30% æ¦‚ç‡é‡æ•Œ
                        triggerRandomEncounter();
                        return; // é‡æ•Œåä¸ç»§ç»­æ¸²æŸ“åœ°å›¾ï¼Œç­‰å¾…æˆ˜æ–—ç»“æŸ
                    }
                }

                renderMap();
            }
        }

        // æ¢ç´¢æ´ç©´
        function exploreCave() {
            const random = Math.random();
            if (random < 0.4) {
                // å‘ç°å®è—
                const goldFound = Math.floor(Math.random() * 50) + 20;
                gameState.player.gold += goldFound;
                logMessage(`ä½ åœ¨æ´ç©´ä¸­å‘ç°äº†${goldFound}é‡‘å¸ï¼`);
                document.getElementById('story-text').innerText = `åœ¨æ´ç©´æ·±å¤„ï¼Œä½ å‘ç°äº†ä¸€ä¸ªå¤è€çš„å®ç®±ï¼Œé‡Œé¢æœ‰${goldFound}é‡‘å¸ï¼`;
            } else if (random < 0.7) {
                // é‡åˆ°æ€ªç‰©
                const damage = Math.floor(Math.random() * 20) + 10;
                gameState.player.hp = Math.max(0, gameState.player.hp - damage);
                logMessage(`ä½ é‡åˆ°äº†æ´ç©´æ€ªç‰©ï¼Œå—åˆ°äº†${damage}ç‚¹ä¼¤å®³ï¼`);
                document.getElementById('story-text').innerText = `ä¸€åªæ´ç©´è™è çªç„¶è¢­å‡»äº†ä½ ï¼ä½ å—åˆ°äº†${damage}ç‚¹ä¼¤å®³ã€‚`;
            } else {
                // å‘ç°ä¼™ä¼´
                if (gameState.player.companions.length === 0) {
                    gameState.player.companions.push({
                        name: 'è™¾è™¾',
                        hp: 60,
                        maxHp: 60,
                        image: './monster7.png'
                    });
                    document.getElementById('companion-section').style.display = 'block';
                    logMessage('ä½ å‘ç°äº†ä¸€åªå‹å–„çš„è™¾è™¾ï¼Œå®ƒå†³å®šè·Ÿéšä½ å†’é™©ï¼');
                    document.getElementById('story-text').innerText = 'åœ¨æ´ç©´çš„è§’è½ï¼Œä½ å‘ç°äº†ä¸€åªå—ä¼¤çš„è™¾è™¾ã€‚ç»è¿‡ä½ çš„æ²»ç–—ï¼Œå®ƒå†³å®šè·Ÿéšä½ ä¸€èµ·å†’é™©ï¼';
                } else {
                    logMessage('ä½ åœ¨æ´ç©´ä¸­æ²¡æœ‰å‘ç°ä»€ä¹ˆç‰¹åˆ«çš„ä¸œè¥¿ã€‚');
                    document.getElementById('story-text').innerText = 'ä½ ä»”ç»†æœç´¢äº†æ´ç©´ï¼Œä½†æ²¡æœ‰å‘ç°ä»€ä¹ˆç‰¹åˆ«çš„ä¸œè¥¿ã€‚';
                }
            }
            
            document.getElementById('story-choices').innerHTML = `<button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ ç¦»å¼€æ´ç©´</button>`;
            updatePlayerStats();
        }

        // æ”€ç™»å±±å³°
        function climbMountain() {
            const random = Math.random();
            if (random < 0.5) {
                // æˆåŠŸæ”€ç™»ï¼Œè·å¾—ç»éªŒ
                const expGained = Math.floor(Math.random() * 30) + 20;
                gameState.player.exp += expGained;
                logMessage(`æˆåŠŸæ”€ç™»å±±å³°ï¼Œè·å¾—äº†${expGained}ç‚¹ç»éªŒï¼`);
                document.getElementById('story-text').innerText = `ç»è¿‡è‰°éš¾çš„æ”€ç™»ï¼Œä½ æˆåŠŸåˆ°è¾¾äº†å±±å³°ï¼å£®ä¸½çš„æ™¯è‰²è®©ä½ è·å¾—äº†${expGained}ç‚¹ç»éªŒã€‚`;
                
                // æ£€æŸ¥å‡çº§
                if (gameState.player.exp >= gameState.player.nextLevelExp) {
                    levelUp();
                }
            } else {
                // æ”€ç™»å¤±è´¥ï¼Œæ¶ˆè€—ä½“åŠ›
                const hpLost = Math.floor(Math.random() * 15) + 5;
                gameState.player.hp = Math.max(0, gameState.player.hp - hpLost);
                logMessage(`æ”€ç™»å¤±è´¥ï¼Œæ¶ˆè€—äº†${hpLost}ç‚¹ç”Ÿå‘½å€¼ã€‚`);
                document.getElementById('story-text').innerText = `å±±è·¯å¤ªè¿‡é™©å³»ï¼Œä½ åœ¨æ”€ç™»è¿‡ç¨‹ä¸­æ»‘å€’äº†ï¼Œæ¶ˆè€—äº†${hpLost}ç‚¹ç”Ÿå‘½å€¼ã€‚`;
            }
            
            document.getElementById('story-choices').innerHTML = `<button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ è¿”å›åœ°å›¾</button>`;
            updatePlayerStats();
        }

        // å‡çº§
        function levelUp() {
            gameState.player.level++;
            gameState.player.exp = 0;
            gameState.player.nextLevelExp += 50;
            gameState.player.maxHp += 20;
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.maxMp += 10;
            gameState.player.mp = gameState.player.maxMp;
            
            logMessage(`æ­å–œå‡çº§ï¼ç°åœ¨æ˜¯${gameState.player.level}çº§ï¼`);
        }

        // éšæœºé‡æ•Œ
        function triggerRandomEncounter() {
            const monsters = [
                { name: 'æ£®æ—å²è±å§†', hp: 30, attack: 8, exp: 15, gold: 10, image: './monster1.png' },
                { name: 'é‡ç”Ÿè˜‘è‡', hp: 25, attack: 6, exp: 12, gold: 8, image: './monster2.png' },
                { name: 'è¿·è·¯å°ç²¾çµ', hp: 20, attack: 10, exp: 18, gold: 12, image: './monster3.png' },
                { name: 'å²©çŸ³èŸ¹', hp: 40, attack: 12, exp: 20, gold: 15, image: './monster4.png' },
                { name: 'é£ä¹‹ç‹¼', hp: 35, attack: 15, exp: 25, gold: 18, image: './monster6.png' }
            ];
            
            const randomMonster = monsters[Math.floor(Math.random() * monsters.length)];
            
            logMessage(`é­é‡äº†${randomMonster.name}ï¼`);
            
            document.getElementById('story-text').innerText = `åœ¨æ¢ç´¢è¿‡ç¨‹ä¸­ï¼Œä½ é­é‡äº†ä¸€åª${randomMonster.name}ï¼å®ƒçœ‹èµ·æ¥å¾ˆæœ‰æ•Œæ„ï¼Œå‡†å¤‡æˆ˜æ–—ï¼`;
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="startBattle('${JSON.stringify(randomMonster).replace(/"/g, '&quot;')}')">âš”ï¸ å¼€å§‹æˆ˜æ–—</button>
                <button class="choice-btn" onclick="attemptFlee()">ğŸƒâ€â™‚ï¸ å°è¯•é€ƒè·‘</button>
            `;
            showStoryMode();
        }

        // å¼€å§‹æˆ˜æ–—
        function startBattle(monsterData) {
            const monster = JSON.parse(monsterData.replace(/&quot;/g, '"'));
            gameState.currentBattle = {
                monster: monster,
                playerTurn: true
            };
            
            battleTurn(monster);
        }

        // æˆ˜æ–—å›åˆ
        function battleTurn(monster) {
            if (gameState.player.hp <= 0) {
                // ç©å®¶æ­»äº¡
                document.getElementById('story-text').innerText = 'ä½ è¢«å‡»è´¥äº†ï¼ä½ å¤±å»äº†ä¸€äº›é‡‘å¸ï¼Œä½†ä¿ä½äº†æ€§å‘½ã€‚';
                gameState.player.hp = Math.floor(gameState.player.maxHp * 0.3);
                gameState.player.gold = Math.max(0, gameState.player.gold - 20);
                document.getElementById('story-choices').innerHTML = `
                    <button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ è¿”å›åœ°å›¾</button>
                `;
                updatePlayerStats();
                return;
            }
            
            if (monster.hp <= 0) {
                // æ€ªç‰©æ­»äº¡ï¼Œç©å®¶èƒœåˆ©
                gameState.player.exp += monster.exp;
                gameState.player.gold += monster.gold;
                
                logMessage(`å‡»è´¥äº†${monster.name}ï¼è·å¾—${monster.exp}ç»éªŒå’Œ${monster.gold}é‡‘å¸ï¼`);
                document.getElementById('story-text').innerText = `ä½ æˆåŠŸå‡»è´¥äº†${monster.name}ï¼è·å¾—äº†${monster.exp}ç‚¹ç»éªŒå’Œ${monster.gold}é‡‘å¸ã€‚`;
                
                // æ£€æŸ¥å‡çº§
                if (gameState.player.exp >= gameState.player.nextLevelExp) {
                    levelUp();
                }
                
                document.getElementById('story-choices').innerHTML = `
                    <button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ ç»§ç»­æ¢ç´¢</button>
                `;
                updatePlayerStats();
                return;
            }
            
            // ç»§ç»­æˆ˜æ–—
            if (gameState.currentBattle.playerTurn) {
                // ç©å®¶å›åˆ
                document.getElementById('story-text').innerText = `${monster.name} (ç”Ÿå‘½å€¼: ${monster.hp}) æ­£åœ¨ä¸ä½ æˆ˜æ–—ï¼é€‰æ‹©ä½ çš„è¡ŒåŠ¨ï¼š`;
                document.getElementById('story-choices').innerHTML = `
                    <button class="choice-btn" onclick="playerAttack()">âš”ï¸ æ”»å‡»</button>
                    <button class="choice-btn" onclick="useHealingPotion()">ğŸ§ª ä½¿ç”¨æ²»ç–—è¯æ°´</button>
                    <button class="choice-btn" onclick="attemptFlee()">ğŸƒâ€â™‚ï¸ å°è¯•é€ƒè·‘</button>
                `;
            } else {
                // æ€ªç‰©å›åˆ
                const damage = Math.floor(Math.random() * monster.attack) + 5;
                gameState.player.hp = Math.max(0, gameState.player.hp - damage);
                
                logMessage(`${monster.name}æ”»å‡»äº†ä½ ï¼Œé€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
                document.getElementById('story-text').innerText = `${monster.name}å‘ä½ å‘èµ·æ”»å‡»ï¼Œé€ æˆäº†${damage}ç‚¹ä¼¤å®³ï¼`;
                
                gameState.currentBattle.playerTurn = true;
                updatePlayerStats();
                
                setTimeout(() => {
                    battleTurn(monster);
                }, 1500);
            }
        }

        // ç©å®¶æ”»å‡»
        function playerAttack() {
            const monster = gameState.currentBattle.monster;
            const damage = Math.floor(Math.random() * 20) + 10 + gameState.player.level * 2;
            monster.hp = Math.max(0, monster.hp - damage);
            
            logMessage(`ä½ æ”»å‡»äº†${monster.name}ï¼Œé€ æˆ${damage}ç‚¹ä¼¤å®³ï¼`);
            document.getElementById('story-text').innerText = `ä½ å‘${monster.name}å‘èµ·æ”»å‡»ï¼Œé€ æˆäº†${damage}ç‚¹ä¼¤å®³ï¼`;
            
            gameState.currentBattle.playerTurn = false;
            
            setTimeout(() => {
                battleTurn(monster);
            }, 1500);
        }

        // ä½¿ç”¨æ²»ç–—è¯æ°´
        function useHealingPotion() {
            const potionIndex = gameState.player.inventory.findIndex(item => 
                item.type === 'potion' && item.name.includes('æ²»ç–—')
            );
            
            if (potionIndex !== -1) {
                const potion = gameState.player.inventory[potionIndex];
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + potion.effect);
                gameState.player.inventory.splice(potionIndex, 1);
                
                logMessage(`ä½¿ç”¨äº†${potion.name}ï¼Œæ¢å¤äº†${potion.effect}ç‚¹ç”Ÿå‘½å€¼ï¼`);
                document.getElementById('story-text').innerText = `ä½ ä½¿ç”¨äº†${potion.name}ï¼Œæ¢å¤äº†${potion.effect}ç‚¹ç”Ÿå‘½å€¼ï¼`;
                
                gameState.currentBattle.playerTurn = false;
                updatePlayerStats();
                
                setTimeout(() => {
                    battleTurn(gameState.currentBattle.monster);
                }, 1500);
            } else {
                logMessage('ä½ æ²¡æœ‰æ²»ç–—è¯æ°´ï¼');
                document.getElementById('story-text').innerText = 'ä½ æ²¡æœ‰æ²»ç–—è¯æ°´å¯ä»¥ä½¿ç”¨ï¼';
                
                setTimeout(() => {
                    battleTurn(gameState.currentBattle.monster);
                }, 1000);
            }
        }

        // å°è¯•é€ƒè·‘
        function attemptFlee() {
            const fleeChance = Math.random();
            if (fleeChance < 0.7) { // 70% æˆåŠŸç‡
                logMessage('æˆåŠŸé€ƒè·‘äº†ï¼');
                document.getElementById('story-text').innerText = 'ä½ æˆåŠŸé€ƒç¦»äº†æˆ˜æ–—ï¼';
                document.getElementById('story-choices').innerHTML = `
                    <button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ è¿”å›åœ°å›¾</button>
                `;
            } else {
                logMessage('é€ƒè·‘å¤±è´¥ï¼');
                document.getElementById('story-text').innerText = 'é€ƒè·‘å¤±è´¥ï¼æ€ªç‰©é˜»æ­¢äº†ä½ çš„é€ƒè·‘ï¼';
                
                gameState.currentBattle.playerTurn = false;
                
                setTimeout(() => {
                    battleTurn(gameState.currentBattle.monster);
                }, 1500);
            }
        }

        // æ¸²æŸ“å•†åº—
        function renderShop() {
            const shopContainer = document.getElementById('shop-items');
            shopContainer.innerHTML = '';

            gameState.shopItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                
                const canAfford = gameState.player.gold >= item.price;
                
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                        <div class="item-price">ä»·æ ¼: ${item.price} é‡‘å¸</div>
                    </div>
                    <button class="buy-btn" onclick="buyItem(${index})" ${!canAfford ? 'disabled' : ''}>
                        ${canAfford ? 'è´­ä¹°' : 'é‡‘å¸ä¸è¶³'}
                    </button>
                `;
                
                shopContainer.appendChild(itemDiv);
            });
        }

        // è´­ä¹°ç‰©å“
        function buyItem(index) {
            const item = gameState.shopItems[index];
            if (gameState.player.gold >= item.price) {
                gameState.player.gold -= item.price;
                gameState.player.inventory.push({...item});
                logMessage(`è´­ä¹°äº†${item.name}ï¼`);
                updatePlayerStats();
                renderShop();
            }
        }

        // æ¸²æŸ“èƒŒåŒ…
        function renderInventory() {
            const inventoryContainer = document.getElementById('inventory-items');
            inventoryContainer.innerHTML = '';

            if (gameState.player.inventory.length === 0) {
                inventoryContainer.innerHTML = '<p>èƒŒåŒ…æ˜¯ç©ºçš„</p>';
                return;
            }

            gameState.player.inventory.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                
                let actionButton = '';
                if (item.type === 'potion') {
                    actionButton = `<button class="use-btn" onclick="useItem(${index})">ä½¿ç”¨</button>`;
                } else {
                    actionButton = `<button class="sell-btn" onclick="sellItem(${index})">å‡ºå”® (${Math.floor(item.price * 0.7)}é‡‘å¸)</button>`;
                }
                
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                    </div>
                    ${actionButton}
                `;
                
                inventoryContainer.appendChild(itemDiv);
            });
        }

        // ä½¿ç”¨ç‰©å“
        function useItem(index) {
            const item = gameState.player.inventory[index];
            if (item.type === 'potion') {
                if (item.name.includes('æ²»ç–—')) {
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + item.effect);
                    logMessage(`ä½¿ç”¨äº†${item.name}ï¼Œæ¢å¤äº†${item.effect}ç‚¹ç”Ÿå‘½å€¼ï¼`);
                } else if (item.name.includes('é­”æ³•')) {
                    gameState.player.mp = Math.min(gameState.player.maxMp, gameState.player.mp + item.effect);
                    logMessage(`ä½¿ç”¨äº†${item.name}ï¼Œæ¢å¤äº†${item.effect}ç‚¹é­”æ³•å€¼ï¼`);
                }
                
                gameState.player.inventory.splice(index, 1);
                updatePlayerStats();
                renderInventory();
            }
        }

        // å‡ºå”®ç‰©å“
        function sellItem(index) {
            const item = gameState.player.inventory[index];
            const sellPrice = Math.floor(item.price * 0.7);
            gameState.player.gold += sellPrice;
            gameState.player.inventory.splice(index, 1);
            logMessage(`å‡ºå”®äº†${item.name}ï¼Œè·å¾—${sellPrice}é‡‘å¸ï¼`);
            updatePlayerStats();
            renderInventory();
        }

        // æ›´æ–°ä¼‘æ¯æŒ‰é’®çŠ¶æ€
        function updateRestButton() {
            const restBtn = document.getElementById('rest-btn');
            const canRest = gameState.player.gold >= 20 && (gameState.player.hp < gameState.player.maxHp || gameState.player.mp < gameState.player.maxMp);
            
            if (!canRest) {
                restBtn.disabled = true;
                if (gameState.player.gold < 20) {
                    restBtn.textContent = 'ğŸ’¤ é‡‘å¸ä¸è¶³';
                } else {
                    restBtn.textContent = 'ğŸ’¤ çŠ¶æ€æ»¡å€¼';
                }
            } else {
                restBtn.disabled = false;
                restBtn.textContent = 'ğŸ’¤ ä¼‘æ¯ (20é‡‘å¸)';
            }
        }

        // åœ¨æ—…åº—ä¼‘æ¯
        function restAtInn() {
            if (gameState.player.gold >= 20) {
                gameState.player.gold -= 20;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.mp = gameState.player.maxMp;
                logMessage('åœ¨æ—…åº—ä¼‘æ¯ï¼Œå®Œå…¨æ¢å¤äº†ç”Ÿå‘½å€¼å’Œé­”æ³•å€¼ï¼');
                updatePlayerStats();
                updateRestButton();
            }
        }

        // æ•…äº‹é€‰æ‹©å‡½æ•°
        function goToVillageChief() {
            document.getElementById('story-text').innerText = 'ä½ æ¥åˆ°äº†æ‘é•¿å®¶ã€‚æ‘é•¿æ˜¯ä¸€ä½æ…ˆç¥¥çš„è€äººï¼Œä»–æ­£åœ¨ä¸ºæ‘åº„çš„å®‰å…¨æ‹…å¿§ã€‚';
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="acceptQuest()">ğŸ¯ æ¥å—æ¸…ç†æ£®æ—æ€ªç‰©çš„ä»»åŠ¡</button>
                <button class="choice-btn" onclick="openInn()">ğŸ¨ è¯¢é—®æ—…åº—ä¿¡æ¯</button>
                <button class="choice-btn" onclick="backToStory()">ğŸ”™ è¿”å›æ‘åº„ä¸­å¿ƒ</button>
            `;
        }

        function acceptQuest() {
            const expGained = 50;
            const goldGained = 30;
            gameState.player.exp += expGained;
            gameState.player.gold += goldGained;
            
            document.getElementById('story-text').innerText = `æ‘é•¿æ„Ÿæ¿€åœ°è¯´ï¼š"è°¢è°¢ä½ æ„¿æ„å¸®åŠ©æˆ‘ä»¬ï¼è¿™é‡Œæœ‰ä¸€äº›æŠ¥é…¬ã€‚"ä½ è·å¾—äº†${expGained}ç‚¹ç»éªŒå’Œ${goldGained}é‡‘å¸ï¼`;
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="backToStory()">ğŸ”™ è¿”å›æ‘åº„ä¸­å¿ƒ</button>
            `;
            
            logMessage(`å®Œæˆä»»åŠ¡ï¼Œè·å¾—${expGained}ç»éªŒå’Œ${goldGained}é‡‘å¸ï¼`);
            updatePlayerStats();
            
            if (gameState.player.exp >= gameState.player.nextLevelExp) {
                levelUp();
            }
        }

        function exploreForest() {
            const random = Math.random();
            if (random < 0.5) {
                const expGained = Math.floor(Math.random() * 20) + 10;
                gameState.player.exp += expGained;
                document.getElementById('story-text').innerText = `ä½ åœ¨æ£®æ—ä¸­é‡åˆ°äº†ä¸€äº›å°æ€ªç‰©ï¼Œç»è¿‡æˆ˜æ–—è·å¾—äº†${expGained}ç‚¹ç»éªŒï¼`;
                logMessage(`æ£®æ—æ¢ç´¢è·å¾—${expGained}ç‚¹ç»éªŒï¼`);
            } else {
                const goldFound = Math.floor(Math.random() * 30) + 10;
                gameState.player.gold += goldFound;
                document.getElementById('story-text').innerText = `ä½ åœ¨æ£®æ—ä¸­å‘ç°äº†ä¸€ä¸ªå°å®ç®±ï¼Œè·å¾—äº†${goldFound}é‡‘å¸ï¼`;
                logMessage(`å‘ç°å®ç®±ï¼Œè·å¾—${goldFound}é‡‘å¸ï¼`);
            }
            
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="backToStory()">ğŸ”™ è¿”å›æ‘åº„ä¸­å¿ƒ</button>
            `;
            
            updatePlayerStats();
            
            if (gameState.player.exp >= gameState.player.nextLevelExp) {
                levelUp();
            }
        }

        function openShop() {
            showShopMode();
        }

        function openInn() {
            showInnMode();
        }

        function openInventory() {
            showInventoryMode();
        }

        function openMap() {
            showMapMode();
        }

        function backToStory() {
            document.getElementById('story-text').innerText = `
                åœ¨Anomaçš„ç¥ç§˜ä¸–ç•Œä¸­ï¼Œä½ æ˜¯ä¸€ååˆšåˆšè§‰é†’æ„å›¾èƒ½åŠ›çš„å¹´è½»æ³•å¸ˆã€‚è¿™ä¸ªä¸–ç•Œç”±æ— æ•°ä¸ª"æ„å›¾"æ„æˆï¼Œæ¯ä¸ªæ„å›¾éƒ½æ˜¯ç°å®çš„ä¸€ä¸ªç‰‡æ®µï¼Œè€Œä½ æ‹¥æœ‰æ“æ§è¿™äº›æ„å›¾çš„å¤©èµ‹ã€‚

                ä½ ç«™åœ¨æ–°æ‰‹æ‘çš„ä¸­å¤®ï¼Œå‘¨å›´æ˜¯ç†Ÿæ‚‰çš„èŒ…è‰å±‹å’ŒçŸ³æ¿è·¯ã€‚è¿œå¤„çš„åœ°å¹³çº¿ä¸Šï¼Œç¥ç§˜çš„æ„å›¾ä¹‹å¡”è‹¥éšè‹¥ç°ï¼Œé‚£é‡Œæ®è¯´éšè—ç€Anomaä¸–ç•Œçš„ç»ˆæç§˜å¯†ã€‚

                ä½ çš„å¯¼å¸ˆå‘Šè¯‰ä½ ï¼Œåªæœ‰é€šè¿‡ä¸æ–­çš„å†’é™©å’Œæˆ˜æ–—ï¼Œæ‰èƒ½æå‡ä½ çš„æ„å›¾æ“æ§èƒ½åŠ›ï¼Œæœ€ç»ˆæˆä¸ºçœŸæ­£çš„æ„å›¾å¤§å¸ˆã€‚
            `;
            document.getElementById('story-choices').innerHTML = `
                <button class="choice-btn" onclick="goToVillageChief()">ğŸ  å‰å¾€æ‘é•¿å®¶æ¥å—ç¬¬ä¸€ä¸ªä»»åŠ¡</button>
                <button class="choice-btn" onclick="exploreForest()">ğŸŒ² æ¢ç´¢æ‘åº„å‘¨å›´çš„æ£®æ—</button>
                <button class="choice-btn" onclick="openInventory()">ğŸ“Š æŸ¥çœ‹ä¸ªäººçŠ¶æ€å’Œè£…å¤‡</button>
                <button class="choice-btn" onclick="openShop()">ğŸª å‰å¾€å•†åº—è´­ä¹°ç‰©å“</button>
                <button class="choice-btn" onclick="openMap()">ğŸ—ºï¸ æ‰“å¼€ä¸–ç•Œåœ°å›¾</button>
            `;
            showStoryMode();
        }

        // ä¿å­˜æ¸¸æˆ
        function saveGame() {
            localStorage.setItem('anomaRPGSave', JSON.stringify(gameState));
            logMessage('æ¸¸æˆå·²ä¿å­˜ï¼');
        }

        // åŠ è½½æ¸¸æˆ
        function loadGame() {
            const savedGame = localStorage.getItem('anomaRPGSave');
            if (savedGame) {
                gameState = JSON.parse(savedGame);
                updatePlayerStats();
                logMessage('æ¸¸æˆå·²åŠ è½½ï¼');
                
                // æ˜¾ç¤ºä¼™ä¼´ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if (gameState.player.companions.length > 0) {
                    document.getElementById('companion-section').style.display = 'block';
                }
            } else {
                logMessage('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£ï¼');
            }
        }

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', function(event) {
            if (gameState.currentMode === 'map') {
                switch(event.key) {
                    case 'ArrowLeft':
                        movePlayer(-1, 0);
                        break;
                    case 'ArrowRight':
                        movePlayer(1, 0);
                        break;
                    case 'ArrowUp':
                        movePlayer(0, -1);
                        break;
                    case 'ArrowDown':
                        movePlayer(0, 1);
                        break;
                }
            }
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        updatePlayerStats();
    </script>
</body>
</html>

